<!doctype html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ‘„ æ»‘èˆŒç·´ç¿’ï¼ˆãƒ•ãƒ¬ãƒ¼ã‚ºå¼ï¼‰</title>
<link rel="stylesheet" href="style.css">

<style>
  /* ===== è¦‹ã‚„ã™ã• ===== */
  #phraseBody{
    font-size:32px;
    font-weight:900;
    text-align:center;
    line-height:1.9;
    letter-spacing:0.02em;
    word-break:keep-all;
  }
  .mini{font-size:14px;opacity:.85;line-height:1.7;}
  .row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;align-items:center;}
  .pill{
    display:inline-block;padding:6px 12px;border-radius:999px;
    background:rgba(255,255,255,.75);border:1px solid rgba(0,0,0,.12);
    font-size:14px;
  }
  input[type=range]{width:220px;}
  .modeOn{border:2px solid #333;}
  textarea{font-size:16px; padding:10px; border-radius:12px; border:1px solid rgba(0,0,0,.18);}

  /* ===== ã‚«ãƒ©ã‚ªã‚±ï¼ˆæ»‘ã‚‰ã‹ï¼‰ ===== */
  .karaChar{
    display:inline-block;
    padding:2px 3px;
    border-radius:8px;
    transition: background-color .18s ease, color .18s ease, opacity .18s ease, transform .18s ease;
  }
  .karaChar.active{
    background: rgba(239,68,68,0.18);
    color: #ef4444;
    transform: scale(1.02);
  }
  .karaChar.done{opacity:0.55;}
  .karaChar.skip{
    opacity:0.55;
  }

  .softBox{
    background:rgba(255,255,255,.7);
    border:1px solid rgba(0,0,0,.12);
    padding:12px;border-radius:14px;
  }
  .goodBox{background:#eafff0;border:1px solid #86efac;}
  .warnBox{background:#fff7ed;border:1px solid #fdba74;}
  .title2{font-weight:900;margin:2px 0 8px;}
  .sep{height:1px;background:rgba(0,0,0,.1);margin:12px 0;}
</style>
</head>

<body>

<header class="top">
  <h1>ğŸ‘„ æ»‘èˆŒç·´ç¿’ï¼ˆãƒ•ãƒ¬ãƒ¼ã‚ºå¼ï¼‰</h1>
  <p class="sub">ã‚«ãƒ©ã‚ªã‚±å¼ã§1ãƒ•ãƒ¬ãƒ¼ã‚ºãšã¤ã€‚åˆå¿ƒè€…ã¯ã€Œä»Šæ—¥ã®ãŠã™ã™ã‚ã€ã ã‘ã§OK</p>
  <p><a href="index.html">â† ãƒ›ãƒ¼ãƒ ã¸</a></p>
</header>

<main class="menu">

  <!-- ğŸ”° åˆå¿ƒè€…å‘ã‘ï¼šä»Šæ—¥ã®ãŠã™ã™ã‚ï¼ˆè¿·ã‚ã›ãªã„ï¼‰ -->
  <div class="card" style="display:block;">
    <div class="title">ğŸ”° ä»Šæ—¥ã®ãŠã™ã™ã‚ï¼ˆåˆå¿ƒè€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼ / ç´„2ã€œ3åˆ†ï¼‰</div>
    <div class="desc">
      <div class="softBox warnBox">
        <div class="mini">è¿·ã£ãŸã‚‰ã“ã‚Œã ã‘ã€‚<b>ã€Œã‚„ã‚‹ç¿’æ…£ã€</b>ã‚’ä½œã‚‹ã®ãŒæœ€å„ªå…ˆã§ã™ã€‚</div>
        <div class="sep"></div>

        <div class="mini" id="dailyText">èª­ã¿è¾¼ã¿ä¸­â€¦</div>

        <div class="row" style="margin-top:10px;">
          <button onclick="startDaily()">â–¶ é–‹å§‹</button>
          <button onclick="shuffleDaily()">ğŸ² å¤‰æ›´</button>
          <button onclick="stopAll()">â¹ åœæ­¢</button>
        </div>

        <div class="mini" style="margin-top:10px;">
          â€»é–‹å§‹ã™ã‚‹ã¨ <b>è‡ªå‹•ON</b>ã«ãªã‚Šã€ã‚«ãƒ©ã‚ªã‚±ã§æµã‚Œã¾ã™ï¼ˆèª­ã¿ä¸Šã’ç„¡ã—ï¼‰
        </div>
      </div>
    </div>
  </div>

  <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <div class="card" style="display:block;">
    <div class="title">ã‚»ã‚¯ã‚·ãƒ§ãƒ³</div>
    <div class="desc row">
      <button onclick="setSection(0)">â‘ æ¯éŸ³</button>
      <button onclick="setSection(1)">â‘¡åŸºæœ¬ï¼ˆè¡Œï¼‰</button>
      <button onclick="setSection(2)">â‘¢æ¿éŸ³/åŠæ¿éŸ³</button>
      <button onclick="setSection(3)">â‘£æ‹—éŸ³</button>
      <button onclick="setSection(4)">â‘¤ãƒªã‚ºãƒ </button>
      <button onclick="setSection(5)">â‘¥è¨€ã„ã«ãã„10é¸</button>
    </div>
  </div>

  <!-- æ“ä½œ -->
  <div class="card" style="display:block;">
    <div class="title">æ“ä½œ</div>
    <div class="desc">

      <div class="row">
        <button onclick="togglePlay()">ğŸŒˆ å†ç”Ÿ</button>
        <button id="autoBtn" onclick="toggleAuto()">è‡ªå‹•OFF</button>
        <button id="karaBtn" onclick="toggleKara()">ã‚«ãƒ©ã‚ªã‚±ON</button>
      </div>

      <div class="row" style="margin-top:8px;">
        <span class="pill">é€Ÿåº¦</span>
        <input id="speedRange" type="range" min="200" max="900" value="450" oninput="setSpeed(this.value)">
        <span id="speedLabel" class="pill">450ms</span>
      </div>

      <div class="row" style="margin-top:8px;">
        <button id="bBtn" class="modeOn" onclick="setLevel('b')">ğŸ”°åˆå¿ƒè€…</button>
        <button id="aBtn" onclick="setLevel('a')">ğŸ”¥ä¸Šç´š</button>
      </div>

      <div class="mini" style="margin-top:8px;">
        ãƒ»åˆå¿ƒè€…ï¼šã‚†ã£ãã‚Šï¼ˆç²¾åº¦é‡è¦–ï¼‰<br>
        ãƒ»ä¸Šç´šï¼šãƒ†ãƒ³ãƒUPï¼ˆè‡ªå‹•ONæ¨å¥¨ï¼‰
      </div>

    </div>
  </div>

  <!-- è¡¨ç¤º -->
  <div class="card" style="display:block;">
    <div class="title" id="sectionTitle"></div>

    <div class="desc">
      <div style="text-align:center;">
        <span id="counter" class="pill"></span>
      </div>

      <div style="margin-top:10px;border:1px solid rgba(0,0,0,.12);border-radius:12px;padding:12px;background:rgba(255,255,255,.75);">
        <div id="phraseBody"></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button onclick="prev()">â—€</button>
        <button onclick="next()">â–¶</button>
        <button onclick="rand()">ğŸ²</button>
        <button onclick="reset()">âŸ²</button>
      </div>

      <div class="mini" style="text-align:center;margin-top:10px;">
        â€» ã¾ãšã€Œã‚†ã£ãã‚Šæ­£ç¢ºã«ã€â†’ æ…£ã‚ŒãŸã‚‰ãƒ†ãƒ³ãƒã‚¢ãƒƒãƒ—
      </div>
    </div>
  </div>

  <!-- ğŸ§  AIæ»‘èˆŒè©•ä¾¡ï¼ˆæœ¬æ ¼ï¼‰ -->
  <div class="card" style="display:block;">
    <div class="title">ğŸ§  AIæ»‘èˆŒè©•ä¾¡ï¼ˆæœ¬æ ¼ / æ‰‹å…¥åŠ›OKï¼‰</div>
    <div class="desc">
      <div class="mini">â‘  ä»Šã®ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ç™ºå£° â†’ â‘¡ æ–‡å­—èµ·ã“ã—ï¼ˆæ‰‹å…¥åŠ›ã§OKï¼‰â†’ â‘¢ è©•ä¾¡</div>

      <div style="margin-top:10px;" class="row">
        <button onclick="setEvalTargetFromCurrent()">ğŸ¯ ä»Šã®ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’è©•ä¾¡å¯¾è±¡ã«ã™ã‚‹</button>
        <span class="pill" id="evalTargetLabel">æœªè¨­å®š</span>
      </div>

      <div style="margin-top:10px;">
        <textarea id="sttText" placeholder="è©±ã—ãŸå†…å®¹ã‚’å…¥åŠ›ï¼ˆèª¤å¤‰æ›ãŒã‚ã£ã¦ã‚‚OKï¼‰" style="width:100%;min-height:90px;"></textarea>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="modeOn" onclick="runArticulationEval()">âœ… è©•ä¾¡ã™ã‚‹</button>
        <button onclick="fillSttWithPhrase()">ğŸ“ ãƒ†ã‚¹ãƒˆï¼ˆãŠæ‰‹æœ¬ã‚’å…¥ã‚Œã‚‹ï¼‰</button>
        <button onclick="clearEval()">ã‚¯ãƒªã‚¢</button>
      </div>

      <div style="margin-top:10px;">
        <div id="evalBadges" class="row" style="justify-content:flex-start;"></div>
        <div id="evalResult" class="mini" style="white-space:pre-wrap; line-height:1.8;">ã“ã“ã«è©•ä¾¡ãŒå‡ºã¾ã™ã€‚</div>
      </div>
    </div>
  </div>

  <!-- ğŸ§  ä»Šæ—¥ã®AIç·è©•ï¼ˆç·´ç¿’ãƒ­ã‚°ï¼‰ -->
  <div class="card" style="display:block;">
    <div class="title">ğŸ§  ä»Šæ—¥ã®AIç·è©•ï¼ˆã‚„ã£ãŸé‡ã§è‡ªä¿¡ã‚’å¢—ã‚„ã™ï¼‰</div>
    <div class="desc">
      <div class="softBox">
        <div class="mini">â€»ã“ã®ãƒšãƒ¼ã‚¸ã§å†ç”Ÿã—ãŸãƒ•ãƒ¬ãƒ¼ã‚ºæ•°ãƒ»é›£èªæ•°ã‚’è‡ªå‹•ã§è¨˜éŒ²ã—ã¾ã™ã€‚</div>

        <div class="sep"></div>

        <div class="title2">ğŸ¤ 30ç§’ã‚¹ãƒ”ãƒ¼ãƒï¼ˆä»»æ„ï¼‰</div>
        <textarea id="speechText" placeholder="ä»Šæ—¥ã®30ç§’ã‚¹ãƒ”ãƒ¼ãƒã‚’ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰" style="width:100%;min-height:80px;"></textarea>

        <div class="row" style="margin-top:10px;">
          <button class="modeOn" onclick="runDailySummary()">âœ… ä»Šæ—¥ã®ç·è©•ã‚’å‡ºã™</button>
          <button onclick="clearDailyLog()">ã‚¯ãƒªã‚¢</button>
        </div>

        <div class="sep"></div>

        <div id="mainText" class="mini" style="white-space:pre-wrap; line-height:1.8;">
ã“ã“ã«ç·è©•ãŒå‡ºã¾ã™ã€‚
ï¼ˆã¾ãšã¯ã€Œä»Šæ—¥ã®ãŠã™ã™ã‚ã€ã‚’1å›å®Œèµ°ã™ã‚‹ã¨ã€ã‹ãªã‚Šè‰¯ã„æ„Ÿã˜ã«å‡ºã¾ã™ğŸ˜Šï¼‰
        </div>
      </div>
    </div>
  </div>

</main>


<script>
/* =========================================================
  âœ… ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ•ãƒ¬ãƒ¼ã‚ºå¢—é‡ç‰ˆï¼‰
========================================================= */

// â‘  æ¯éŸ³
const p1 = [
  "ã‚ãˆã„ã†ãˆãŠã€€ã‚ãŠ",
  "ã‚ã„ã†ãˆãŠã€€ã‚ãŠ",
  "ã‚ãŠãˆã†ã„ã€€ãˆã„ãŠã†ã€€ã‚ã„ã†ãˆãŠ",
  "ã‚ã„ã†ãˆãŠã€€ãŠãˆã†ã„ã‚",
  "ã‚ãˆã„ã€€ã†ãˆãŠã€€ã‚ãŠ",
  "ã‚ã„ã†ãˆãŠã€€ã‚ãŠï¼ˆã‚†ã£ãã‚Šï¼‰"
];

// â‘¡ è¡Œåˆ¥åŸºæœ¬ï¼ˆã‚è¡Œã€œã‚è¡Œï¼‰
const p2 = [
  "ï¼ˆã‚è¡Œï¼‰ ã‚ã€€ã„ã€€ã†ã€€ãˆã€€ãŠ",
  "ï¼ˆã‹è¡Œï¼‰ ã‹ã€€ãã€€ãã€€ã‘ã€€ã“",
  "ï¼ˆã•è¡Œï¼‰ ã•ã€€ã—ã€€ã™ã€€ã›ã€€ã",
  "ï¼ˆãŸè¡Œï¼‰ ãŸã€€ã¡ã€€ã¤ã€€ã¦ã€€ã¨",
  "ï¼ˆãªè¡Œï¼‰ ãªã€€ã«ã€€ã¬ã€€ã­ã€€ã®",
  "ï¼ˆã¯è¡Œï¼‰ ã¯ã€€ã²ã€€ãµã€€ã¸ã€€ã»",
  "ï¼ˆã¾è¡Œï¼‰ ã¾ã€€ã¿ã€€ã‚€ã€€ã‚ã€€ã‚‚",
  "ï¼ˆã‚„è¡Œï¼‰ ã‚„ã€€ã‚†ã€€ã‚ˆ",
  "ï¼ˆã‚‰è¡Œï¼‰ ã‚‰ã€€ã‚Šã€€ã‚‹ã€€ã‚Œã€€ã‚",
  "ï¼ˆã‚è¡Œï¼‰ ã‚ã€€ã‚’ã€€ã‚“",
  "ã‚ã„ã†ãˆãŠã€€ã‚ãŠ",
  "ã‹ããã‘ã“ã€€ã‹ã‘ã“ã€€ããã‘",
  "ã•ã—ã™ã›ãã€€ã•ã›ãã€€ã—ã™ã›",
  "ãŸã¡ã¤ã¦ã¨ã€€ãŸã¦ã¨ã€€ã¡ã¤ã¦",
  "ãªã«ã¬ã­ã®ã€€ãªã­ã®ã€€ã«ã¬ã­",
  "ã¯ã²ãµã¸ã»ã€€ã¯ã¸ã»ã€€ã²ãµã¸",
  "ã¾ã¿ã‚€ã‚ã‚‚ã€€ã¾ã‚ã‚‚ã€€ã¿ã‚€ã‚",
  "ã‚„ã‚†ã‚ˆã€€ã‚†ã‚ˆã‚„ã€€ã‚ˆã‚„ã‚†",
  "ã‚‰ã‚Šã‚‹ã‚Œã‚ã€€ã‚‰ã‚Œã‚ã€€ã‚Šã‚‹ã‚Œ",
  "ã‚ã‚’ã‚“ã€€ã‚ã‚“ã‚’ã€€ã‚’ã‚ã‚“"
];

// â‘¢ æ¿éŸ³ãƒ»åŠæ¿éŸ³
const p3 = [
  "ãŒããã’ã”ã€€ãŒã’ã”ã€€ããã’",
  "ã–ã˜ãšãœãã€€ã–ãœãã€€ã˜ãšãœ",
  "ã ã¢ã¥ã§ã©ã€€ã ã§ã©ã€€ã¢ã¥ã§",
  "ã°ã³ã¶ã¹ã¼ã€€ã°ã¹ã¼ã€€ã³ã¶ã¹",
  "ã±ã´ã·ãºã½ã€€ã±ãºã½ã€€ã´ã·ãº"
];

// â‘£ æ‹—éŸ³ï¼ˆâ€»æ‹—éŸ³ã¯2æ–‡å­—ã‚»ãƒƒãƒˆã§è‰²ãŒå¤‰ã‚ã‚‹ï¼‰
const p4 = [
  "ãã‚ƒãã‚…ãã‚‡ã€€ãã‚ƒããã‚‡ã€€ãã‚…ãã‚‡ãã‚ƒ",
  "ã—ã‚ƒã—ã‚…ã—ã‚‡ã€€ã—ã‚ƒãã—ã‚‡ã€€ã—ã‚…ã—ã‚‡ã—ã‚ƒ",
  "ã¡ã‚ƒã¡ã‚…ã¡ã‚‡ã€€ã¡ã‚ƒãã¡ã‚‡ã€€ã¡ã‚…ã¡ã‚‡ã¡ã‚ƒ",
  "ã«ã‚ƒã«ã‚…ã«ã‚‡ã€€ã«ã‚ƒãã«ã‚‡ã€€ã«ã‚…ã«ã‚‡ã«ã‚ƒ",
  "ã²ã‚ƒã²ã‚…ã²ã‚‡ã€€ã²ã‚ƒãã²ã‚‡ã€€ã²ã‚…ã²ã‚‡ã²ã‚ƒ",
  "ã¿ã‚ƒã¿ã‚…ã¿ã‚‡ã€€ã¿ã‚ƒãã¿ã‚‡ã€€ã¿ã‚…ã¿ã‚‡ã¿ã‚ƒ",
  "ã‚Šã‚ƒã‚Šã‚…ã‚Šã‚‡ã€€ã‚Šã‚ƒãã‚Šã‚‡ã€€ã‚Šã‚…ã‚Šã‚‡ã‚Šã‚ƒ"
];

// â‘¤ ãƒªã‚ºãƒ 
const p5 = [
  "ãŸãŸãŸã€€ã¦ã¦ã¦ã€€ã¨ã¨ã¨",
  "ã‹ã‹ã‹ã€€ãããã€€ããã",
  "ã•ã•ã•ã€€ã—ã—ã—ã€€ã™ã™ã™",
  "ã‚‰ã‚‰ã‚‰ã€€ã‚Šã‚Šã‚Šã€€ã‚‹ã‚‹ã‚‹",
  "ãŸã¦ã¨ã€€ãŸã¦ã¨ã€€ãŸã¦ã¨",
  "ã‚‰ã‚Šã‚‹ã‚Œã‚ã€€ã‚‰ã‚Šã‚‹ã‚Œã‚ï¼ˆãƒªã‚ºãƒ ï¼‰"
];

// â‘¥ è¨€ã„ã«ãã„10é¸ï¼ˆãƒ•ãƒªã‚¬ãƒŠå¯¾å¿œï¼ã²ã‚‰ãŒãªåŒ–ï¼‰
const p6 = [
  "ã‚ã‚ã‚“ã¼ã‚ã‹ã„ãªã€€ã‚ã„ã†ãˆãŠã€€ã†ãã‚‚ã«ã“ãˆã³ã‚‚ãŠã‚ˆã„ã§ã‚‹",
  "ãªã¾ã‚€ãã€€ãªã¾ã”ã‚ã€€ãªã¾ãŸã¾ã”",
  "ã‚ã‹ã¾ããŒã¿ã€€ã‚ãŠã¾ããŒã¿ã€€ãã¾ããŒã¿",
  "ã¨ã†ãã‚‡ã†ã¨ã£ãã‚‡ãã‚‡ã‹ãã‚‡ã",
  "ã¨ãªã‚Šã®ãã‚ƒãã¯ã€€ã‚ˆãã‹ãã‚’ãã†ã€€ãã‚ƒãã ",
  "ã°ã™ãŒã™ã°ãã¯ã¤",
  "ã¾ã˜ã‚…ã¤ã—ã—ã‚…ã˜ã‚…ã¤ã¡ã‚…ã†",
  "ã‚ã†ã«ã‚ƒããªã‚“ã«ã‚‡",
  "ã—ã‚…ã—ã‚ƒã›ã‚“ãŸãã€€ã—ã—ã‚ƒã—ã¤ã€€ã—ã—ã‚ƒã—ã•ã¤",
  "ã•ã„ã•ã„ã•ã„ã‹ãã«ã‚“ã€€ã•ã„ã—ã‚…ã†ã‹ãã«ã‚“"
];

const sections = [
  { t:"â‘ æ¯éŸ³", d:p1 },
  { t:"â‘¡åŸºæœ¬ï¼ˆè¡Œï¼‰", d:p2 },
  { t:"â‘¢æ¿éŸ³/åŠæ¿éŸ³", d:p3 },
  { t:"â‘£æ‹—éŸ³", d:p4 },
  { t:"â‘¤ãƒªã‚ºãƒ ", d:p5 },
  { t:"â‘¥è¨€ã„ã«ãã„10é¸", d:p6 },
];

let sec = 0;
let idx = 0;

/* =========================================================
  âœ… è¨­å®š
========================================================= */
let auto = false;
let kara = true;
let speed = 450;
let level = "b";
let timer = null;
let runningDaily = false;

/* =========================================================
  âœ… ä»Šæ—¥ãƒ­ã‚°ï¼ˆç·è©•ç”¨ï¼‰
========================================================= */
let todayLog = {
  phrases: [],      // å†ç”Ÿã—ãŸãƒ•ãƒ¬ãƒ¼ã‚ºï¼ˆé‡è¤‡OKï¼‰
  hardPhrases: [],  // é›£èªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§å†ç”Ÿã—ãŸãƒ•ãƒ¬ãƒ¼ã‚º
};

/* =========================================================
  âœ… æ‹—éŸ³ï¼‹ã€Œï¼ˆï¼‰/ç©ºç™½ã¯è‰²ä»˜ã‘ã—ãªã„ã€åˆ†å‰²
  - ã¡ã‚ƒ/ã¡ã‚…/ã¡ã‚‡ ç­‰ã¯2æ–‡å­—ã‚»ãƒƒãƒˆæ‰±ã„
  - ï¼ˆï¼‰å†…ãƒ»ç©ºç™½ã¯ skip æ‰±ã„ã«ã—ã¦è‰²ä»˜ã‘ã—ãªã„
========================================================= */
function splitUnits(txt){
  const small = "ã‚ƒã‚…ã‚‡ããƒã…ã‡ã‰";
  const skips = [" ", "ã€€", "ï¼ˆ", "ï¼‰", "(", ")", "ã€€", "\n", "\t"];

  let units = [];
  let buf = "";
  let inParen = false;

  for(const c of Array.from(txt)){
    if(c === "ï¼ˆ" || c === "("){
      if(buf){ units.push({text:buf, skip:false}); buf=""; }
      inParen = true;
      units.push({text:c, skip:true});
      continue;
    }
    if(c === "ï¼‰" || c === ")"){
      if(buf){ units.push({text:buf, skip:true}); buf=""; }
      units.push({text:c, skip:true});
      inParen = false;
      continue;
    }

    if(skips.includes(c)){
      if(buf){
        units.push({text:buf, skip:inParen});
        buf="";
      }
      units.push({text:c, skip:true});
      continue;
    }

    if(small.includes(c)){
      // å°æ–‡å­—ã¯å‰ã®éŸ³ã«ãã£ã¤ã‘ã‚‹ï¼ˆæ‹—éŸ³2æ–‡å­—ã‚»ãƒƒãƒˆï¼‰
      buf += c;
      continue;
    }

    // é€šå¸¸æ–‡å­—ï¼šæ–°ã—ã„å˜ä½é–‹å§‹
    if(buf){
      units.push({text:buf, skip:inParen});
    }
    buf = c;
  }

  if(buf){
    units.push({text:buf, skip:inParen});
  }

  return units;
}

/* =========================================================
  âœ… è¡¨ç¤º
========================================================= */
function render(){
  const s = sections[sec];
  sectionTitle.textContent = s.t;
  counter.textContent = (idx+1) + "/" + s.d.length;

  const text = s.d[idx];
  if(kara) renderKara(text);
  else phraseBody.textContent = text;
}

function renderKara(text){
  phraseBody.innerHTML = "";
  const units = splitUnits(text);

  units.forEach(u=>{
    const sp = document.createElement("span");
    sp.className = "karaChar" + (u.skip ? " skip" : "");
    sp.textContent = u.text;
    phraseBody.appendChild(sp);
  });
}

/* =========================================================
  âœ… ã‚«ãƒ©ã‚ªã‚±é€²è¡Œ
  - skipã¯activeã«ã—ãªã„
========================================================= */
function stopKara(){
  if(timer){
    clearInterval(timer);
    timer = null;
  }
  document.querySelectorAll(".karaChar").forEach(s=>{
    s.classList.remove("active","done");
  });
}

function startKara(){
  if(!kara) return;

  stopKara();

  const spans = Array.from(document.querySelectorAll(".karaChar"));
  let i = 0;

  timer = setInterval(()=>{
    // 1ã¤å‰ã‚’doneã¸
    if(i > 0){
      spans[i-1].classList.remove("active");
      spans[i-1].classList.add("done");
    }

    if(i >= spans.length){
      clearInterval(timer);
      timer = null;
      if(auto && !runningDaily){
        setTimeout(next, 600);
      }
      return;
    }

    // skipã¯è‰²ä»˜ã‘ã—ãªã„ï¼ˆã™ãé€²ã‚€ï¼‰
    const isSkip = spans[i].classList.contains("skip");
    if(!isSkip){
      spans[i].classList.add("active");
    }else{
      spans[i].classList.add("done");
    }

    i++;
  }, speedForSmooth());
}

function speedForSmooth(){
  // skipãŒå¤šã„æ–‡ç« ã§ã‚‚ãƒ†ãƒ³ãƒãŒå¤‰ã«ãªã‚Šã«ãã„ã‚ˆã†ã«ã€æœ€ä½å€¤ã‚’å°‘ã—ä¸‹ã’ã‚‹
  return Math.max(180, speed);
}

/* =========================================================
  âœ… æ“ä½œ
========================================================= */
function stopAll(){
  stopKara();
  runningDaily = false;
}

function setSection(n){
  sec = n;
  idx = 0;
  stopAll();
  render();
}

function next(){
  idx = (idx + 1) % sections[sec].d.length;
  stopAll();
  render();
  if(auto) togglePlay(); // è‡ªå‹•ONãªã‚‰æ¬¡ã‚‚æµã™
}

function prev(){
  idx = (idx - 1 + sections[sec].d.length) % sections[sec].d.length;
  stopAll();
  render();
}

function rand(){
  idx = Math.floor(Math.random() * sections[sec].d.length);
  stopAll();
  render();
}

function reset(){
  idx = 0;
  stopAll();
  render();
}

function togglePlay(){
  // å†ç”Ÿã—ãŸã‚‰ãƒ­ã‚°ã«å…¥ã‚Œã‚‹
  const phrase = sections[sec].d[idx];
  todayLog.phrases.push(phrase);
  if(sec === 5) todayLog.hardPhrases.push(phrase);

  stopAll();
  startKara();
}

function toggleAuto(){
  auto = !auto;
  autoBtn.textContent = auto ? "è‡ªå‹•ON" : "è‡ªå‹•OFF";
}

function toggleKara(){
  kara = !kara;
  karaBtn.textContent = kara ? "ã‚«ãƒ©ã‚ªã‚±ON" : "ã‚«ãƒ©ã‚ªã‚±OFF";
  stopAll();
  render();
}

function setSpeed(v){
  speed = Number(v);
  speedLabel.textContent = speed + "ms";
}

function setLevel(l){
  level = l;

  bBtn.classList.remove("modeOn");
  aBtn.classList.remove("modeOn");

  if(l === "b"){
    bBtn.classList.add("modeOn");
    speed = Math.max(speed, 450);
  }else{
    aBtn.classList.add("modeOn");
    speed = Math.min(speed, 350);
  }
  speedRange.value = speed;
  speedLabel.textContent = speed + "ms";
}

/* =========================================================
  âœ… ä»Šæ—¥ã®ãŠã™ã™ã‚ï¼ˆåˆå¿ƒè€…ãƒ«ãƒ¼ãƒˆï¼‰
  - æ¯éŸ³ â†’ æ‹—éŸ³ â†’ æ¿éŸ³ â†’ é›£èªï¼ˆçŸ­ãï¼‰
========================================================= */
let daily = null;

function r(a){ return a[Math.floor(Math.random()*a.length)]; }

function pickDaily(){
  return [
    {sec:0, p:r(p1)},  // æ¯éŸ³
    {sec:3, p:r(p4)},  // æ‹—éŸ³
    {sec:2, p:r(p3)},  // æ¿éŸ³
    {sec:5, p:r(p6)}   // é›£èª1ã¤
  ];
}

function showDaily(){
  if(!daily) daily = pickDaily();
  dailyText.textContent = daily.map((x,i)=>`(${i+1}) ${sections[x.sec].t}ï¼š${x.p}`).join("\n");
}

function shuffleDaily(){
  daily = pickDaily();
  showDaily();
}

function startDaily(){
  if(!daily) daily = pickDaily();

  auto = true;
  autoBtn.textContent = "è‡ªå‹•ON";

  runningDaily = true;
  runDaily(0);
}

function runDaily(i){
  if(!runningDaily) return;
  if(!daily[i]){
    runningDaily = false;
    return;
  }

  sec = daily[i].sec;
  idx = sections[sec].d.indexOf(daily[i].p);
  if(idx < 0) idx = 0;

  render();

  // å†ç”Ÿãƒ­ã‚°
  const phrase = sections[sec].d[idx];
  todayLog.phrases.push(phrase);
  if(sec === 5) todayLog.hardPhrases.push(phrase);

  stopKara();
  startKara();

  const len = splitUnits(phrase).filter(u=>!u.skip).length;
  setTimeout(()=> runDaily(i+1), len * speedForSmooth() + 900);
}

/* =========================================================
  âœ… AIæ»‘èˆŒè©•ä¾¡ï¼ˆæœ¬æ ¼ï¼‰ â€»æ‰‹å…¥åŠ›ã®ã¿
========================================================= */
let evalTarget = "";

function setEvalTargetFromCurrent(){
  evalTarget = sections[sec].d[idx] || "";
  document.getElementById("evalTargetLabel").textContent = "è©•ä¾¡å¯¾è±¡ï¼šè¨­å®šOK";
}

function fillSttWithPhrase(){
  if(!evalTarget) setEvalTargetFromCurrent();
  document.getElementById("sttText").value = normalizeForEval(evalTarget);
}

function clearEval(){
  document.getElementById("sttText").value = "";
  document.getElementById("evalBadges").innerHTML = "";
  document.getElementById("evalResult").textContent = "ã“ã“ã«è©•ä¾¡ãŒå‡ºã¾ã™ã€‚";
}

function runArticulationEval(){
  if(!evalTarget) setEvalTargetFromCurrent();

  const rawTarget = evalTarget;
  const rawSpoken = document.getElementById("sttText").value || "";

  const target = normalizeForEval(rawTarget);
  const spoken = normalizeForEval(rawSpoken);

  if(spoken.length < 1){
    document.getElementById("evalResult").textContent =
      "æ–‡å­—èµ·ã“ã—ï¼ˆã¾ãŸã¯å…¥åŠ›ï¼‰ãŒç©ºã§ã™ã€‚\nç™ºå£°ã—ãŸå†…å®¹ã‚’æ€ã„å‡ºã—ã¦å…¥åŠ›ã—ã¦OKã§ã™ğŸ˜Š";
    return;
  }

  const diff = computeDiffScore(target, spoken);
  const miss = analyzeMistakes(target, spoken);

  const score = clamp(Math.round(60 + diff.matchRate * 40), 0, 100);
  const badges = buildBadges(diff, miss, score);
  renderEvalBadges(badges);

  const advice = buildAdvice(miss, score);

  document.getElementById("evalResult").textContent =
`ğŸŒŸ ç·åˆè©•ä¾¡ï¼š${score}ç‚¹

ä¸€è‡´ç‡ï¼ˆç›®å®‰ï¼‰ï¼š${Math.round(diff.matchRate*100)}%
ä¸è¶³ï¼š${diff.missing}ã€€ä½™è¨ˆï¼š${diff.extra}

ğŸ§© è‹¦æ‰‹æ¨å®šï¼š
${miss.summary || "å¤§ããªå´©ã‚Œã¯å°‘ãªã‚ï¼ˆã“ã®èª¿å­ã§OKï¼‰"}

ğŸ’¡ æ¬¡ã®ä¸€æ‰‹ï¼š
${advice}

ï¼ˆâ€»æ‰‹å…¥åŠ›ã¯â€œã ã„ãŸã„â€ã§OKã€‚ç›®å®‰ã¨ã—ã¦ä½¿ã£ã¦ãã ã•ã„ğŸ˜Šï¼‰`;
}

/* ---------- æ­£è¦åŒ–ï¼ˆè©•ä¾¡ç”¨ï¼‰ ---------- */
function normalizeForEval(text){
  return (text || "")
    .replace(/ï¼ˆ[^ï¼‰]*ï¼‰/g, "")        // ï¼ˆï¼‰ã‚’é™¤å»
    .replace(/[()]/g, "")
    .replace(/\s+/g, "")              // ç©ºç™½æ¶ˆã—
    .replace(/[ã€€]/g, "")
    .replace(/[ãƒ»ã€ã€‚ï¼ï¼Ÿ!?,.]/g, "")  // è¨˜å·å‰Šé™¤
    .trim();
}

/* ---------- å·®åˆ†ã‚¹ã‚³ã‚¢ ---------- */
function computeDiffScore(a, b){
  const dist = levenshtein(a, b);
  const maxLen = Math.max(a.length, b.length) || 1;
  const matchRate = 1 - (dist / maxLen);

  const missing = Math.max(0, a.length - b.length);
  const extra   = Math.max(0, b.length - a.length);

  return { dist, matchRate: clamp(matchRate, 0, 1), missing, extra };
}

function levenshtein(a, b){
  const dp = Array.from({length: a.length+1}, () => Array(b.length+1).fill(0));
  for(let i=0;i<=a.length;i++) dp[i][0]=i;
  for(let j=0;j<=b.length;j++) dp[0][j]=j;
  for(let i=1;i<=a.length;i++){
    for(let j=1;j<=b.length;j++){
      const cost = a[i-1]===b[j-1] ? 0 : 1;
      dp[i][j] = Math.min(
        dp[i-1][j]+1,
        dp[i][j-1]+1,
        dp[i-1][j-1]+cost
      );
    }
  }
  return dp[a.length][b.length];
}

function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

/* ---------- è‹¦æ‰‹æ¨å®š ---------- */
function analyzeMistakes(target, spoken){
  const smallKana = /[ã‚ƒã‚…ã‚‡ããƒã…ã‡ã‰]/g;
  const dakuon = /[ãŒããã’ã”ã–ã˜ãšãœãã ã¢ã¥ã§ã©ã°ã³ã¶ã¹ã¼ã±ã´ã·ãºã½]/g;
  const sokuon = /ã£/g;
  const ra = /[ã‚‰ã‚Šã‚‹ã‚Œã‚]/g;
  const sa = /[ã•ã—ã™ã›ã]/g;
  const ta = /[ãŸã¡ã¤ã¦ã¨]/g;

  const f = (re, x) => (x.match(re)||[]).length;

  const feat = {
    youonT: f(smallKana,target), youonS: f(smallKana,spoken),
    dakuT:  f(dakuon,target),    dakuS:  f(dakuon,spoken),
    sokuT:  f(sokuon,target),    sokuS:  f(sokuon,spoken),
    raT:    f(ra,target),        raS:    f(ra,spoken),
    saT:    f(sa,target),        saS:    f(sa,spoken),
    taT:    f(ta,target),        taS:    f(ta,spoken),
  };

  const notes = [];
  if(feat.youonT>0 && feat.youonS < feat.youonT) notes.push("æ‹—éŸ³ï¼ˆãã‚ƒ/ã—ã‚ƒ/ã¡ã‚ƒç­‰ï¼‰ãŒè½ã¡ã‚„ã™ã„");
  if(feat.dakuT>0  && feat.dakuS  < feat.dakuT)  notes.push("æ¿éŸ³/åŠæ¿éŸ³ï¼ˆãŒ/ã–/ã /ã°/ã±ç­‰ï¼‰ãŒå¼±ããªã‚Šã‚„ã™ã„");
  if(feat.sokuT>0  && feat.sokuS  < feat.sokuT)  notes.push("ä¿ƒéŸ³ï¼ˆã£ï¼‰ãŒæŠœã‘ã‚„ã™ã„ï¼ˆè©°ã‚ãŒç”˜ããªã‚‹ï¼‰");
  if(feat.raT>0    && feat.raS    < feat.raT)    notes.push("ãƒ©è¡ŒãŒå¼±ã„ï¼ˆèˆŒã®å¼¾ããŒä¸è¶³ã—ãŒã¡ï¼‰");
  if(feat.saT>0    && feat.saS    < feat.saT)    notes.push("ã‚µè¡ŒãŒæ›–æ˜§ï¼ˆæ¯ãŒæ¼ã‚Œã™ã/èˆŒä½ç½®ãŒã‚ºãƒ¬ï¼‰");
  if(feat.taT>0    && feat.taS    < feat.taT)    notes.push("ã‚¿è¡Œã®ç ´è£‚ãŒå¼±ã„ï¼ˆã‚¹ãƒãƒƒãƒˆãŒç”˜ã„ï¼‰");

  return { feat, summary: notes.length ? "ãƒ»" + notes.join("\nãƒ»") : "" };
}

function buildBadges(diff, miss, score){
  const b = [];
  if(score >= 90) b.push("å®‰å®šã—ã¦ã‚¯ãƒªã‚¢");
  if(score >= 80 && score < 90) b.push("ã‹ãªã‚Šè‰¯ã„");
  if(diff.missing > 0) b.push("æŠœã‘ãŒã¡");
  if(diff.extra > 0) b.push("è¨€ã„è¶³ã—ãŒã¡");
  if(miss.summary.includes("æ‹—éŸ³")) b.push("æ‹—éŸ³");
  if(miss.summary.includes("æ¿éŸ³")) b.push("æ¿éŸ³");
  if(miss.summary.includes("ä¿ƒéŸ³")) b.push("ä¿ƒéŸ³");
  if(miss.summary.includes("ãƒ©è¡Œ")) b.push("ãƒ©è¡Œ");
  if(miss.summary.includes("ã‚¿è¡Œ")) b.push("ã‚¿è¡Œ");
  return b.slice(0,6);
}

function renderEvalBadges(badges){
  const box = document.getElementById("evalBadges");
  box.innerHTML = "";
  (badges||[]).forEach(x=>{
    const sp = document.createElement("span");
    sp.className = "pill";
    sp.textContent = x;
    box.appendChild(sp);
  });
}

function buildAdvice(miss, score){
  if(score >= 90){
    return "âœ… åˆæ ¼ã€‚æ¬¡ã¯é€Ÿåº¦ã‚’å°‘ã—ä¸Šã’ã¦ã€åŒã˜ç²¾åº¦ã‚’ã‚­ãƒ¼ãƒ—ã—ã¾ã—ã‚‡ã†ã€‚";
  }
  if(miss.summary.includes("ã‚¿è¡Œ")){
    return "ğŸ‘‰ èˆŒå…ˆã‚’ä¸Šå‰æ­¯ã®è£ï¼ˆã‚¹ãƒãƒƒãƒˆï¼‰ã«ã—ã£ã‹ã‚Šå½“ã¦ã¦ã€Œã‚¿ãƒ»ãƒ†ãƒ»ãƒˆã€ã‚’45ç§’ã€‚ç ´è£‚ã®ã‚­ãƒ¬ãŒæˆ»ã‚Šã¾ã™ã€‚";
  }
  if(miss.summary.includes("æ‹—éŸ³")){
    return "ğŸ‘‰ æ‹—éŸ³ã¯2æ–‡å­—ã¾ã¨ã‚ã¦1æ‹ã€‚ã€ã¡ã‚ƒ/ã¡ã‚…/ã¡ã‚‡ã€ã‚’â€œ1å¡Šâ€ã§ã‚†ã£ãã‚Šâ†’ãƒ†ãƒ³ãƒUPã€‚";
  }
  if(miss.summary.includes("æ¿éŸ³")){
    return "ğŸ‘‰ æ¿éŸ³ã¯æ¯ã‚’å¼±ã‚ãšã€å–‰ã‚’ç· ã‚ãªã„ã€‚ã€ãŒããã’ã”ã€ã‚’â€œæ˜ã‚‹ãâ€å‡ºã™æ„è­˜ãŒåŠ¹ãã¾ã™ã€‚";
  }
  if(miss.summary.includes("ãƒ©è¡Œ")){
    return "ğŸ‘‰ ãƒ©è¡Œã¯èˆŒã‚’å¼¾ãã€‚ã€ãƒ©ãƒªãƒ«ãƒ¬ãƒ­ã€ã‚’å°ã•ã‚ã®å£°ã§æ­£ç¢ºã«10å›â†’æœ€å¾Œã«å°‘ã—é€Ÿãã€‚";
  }
  return "ğŸ‘‰ ã¾ãšã¯â€œã‚†ã£ãã‚Šæ­£ç¢ºã«â€ã€‚æŠœã‘ãŸç®‡æ‰€ã ã‘1å›æˆ»ã£ã¦è¨€ã„ç›´ã™ã¨ä¼¸ã³ã¾ã™ã€‚";
}

/* =========================================================
  âœ… ä»Šæ—¥ã®AIç·è©•ï¼ˆãƒ­ã‚°â†’æ¡ç‚¹ï¼‰
========================================================= */
function clearDailyLog(){
  todayLog = { phrases:[], hardPhrases:[] };
  document.getElementById("speechText").value = "";
  document.getElementById("mainText").textContent = "ã“ã“ã«ç·è©•ãŒå‡ºã¾ã™ã€‚";
}

function runDailySummary(){
  const speechText = (document.getElementById("speechText").value || "").trim();

  let score = 70;
  const feedback = [];

  // æ»‘èˆŒé‡
  const phraseCount = todayLog.phrases.length;
  if(phraseCount >= 10){
    score += 10;
    feedback.push("æ»‘èˆŒç·´ç¿’é‡ã¯ååˆ†ã§ã™ï¼ˆ10ãƒ•ãƒ¬ãƒ¼ã‚ºä»¥ä¸Šï¼‰");
  }else if(phraseCount >= 5){
    score += 5;
    feedback.push("æ»‘èˆŒã¯è‰¯ã„ãƒšãƒ¼ã‚¹ï¼ˆ5ãƒ•ãƒ¬ãƒ¼ã‚ºä»¥ä¸Šï¼‰");
  }else{
    feedback.push("æ»‘èˆŒã¯ã‚ã¨2ã€œ3ãƒ•ãƒ¬ãƒ¼ã‚ºå¢—ã‚„ã™ã¨ä¼¸ã³ãŒåŠ é€Ÿã—ã¾ã™");
  }

  // é›£èª
  const hardCount = todayLog.hardPhrases.length;
  if(hardCount >= 2){
    score += 10;
    feedback.push("è¨€ã„ã«ãã„10é¸ã«ã‚‚æŒ‘æˆ¦ã§ãã¾ã—ãŸï¼ˆé›£èªãŒå¼·ã„ï¼‰");
  }else if(hardCount >= 1){
    score += 5;
    feedback.push("é›£èªã‚’1ã¤å…¥ã‚Œã‚‰ã‚ŒãŸã®ãŒè‰¯ã„ï¼ˆå®Ÿæˆ¦åŠ›ãŒä¼¸ã³ã‚‹ï¼‰");
  }else{
    feedback.push("é›£èªã‚’1ã¤å…¥ã‚Œã‚‹ã¨â€œæœ¬ç•ªâ€ã«å¼·ããªã‚Šã¾ã™");
  }

  // ã‚¹ãƒ”ãƒ¼ãƒ
  const speechLen = speechText.length;
  if(speechLen > 80){
    score += 10;
    feedback.push("ã‚¹ãƒ”ãƒ¼ãƒé‡ãŒååˆ†ï¼ˆå…·ä½“ä¾‹ã¾ã§å…¥ã‚Šã‚„ã™ã„ï¼‰");
  }else if(speechLen > 30){
    score += 5;
    feedback.push("ã‚¹ãƒ”ãƒ¼ãƒã¯è‰¯ã„æ„Ÿã˜ã€‚æ¬¡ã¯â€œå…·ä½“ä¾‹â€ã‚’1ã¤è¶³ã™ã¨çˆ†ä¼¸ã³ã—ã¾ã™");
  }else if(speechLen > 0){
    feedback.push("ã‚¹ãƒ”ãƒ¼ãƒã¯ã‚‚ã†å°‘ã—é•·ãã™ã‚‹ã¨æˆé•·ãŒæ—©ã„ã§ã™ï¼ˆçµè«–â†’ç†ç”±â†’å…·ä½“â†’ã¾ã¨ã‚ï¼‰");
  }else{
    feedback.push("ã‚¹ãƒ”ãƒ¼ãƒã¯ä»»æ„ã§OKï¼ˆã‚„ã‚‹ã¨æˆé•·ãŒåŠ é€Ÿã—ã¾ã™ï¼‰");
  }

  score = Math.min(score, 100);

  let levelText = "";
  if(score >= 95) levelText = "ğŸ”¥ æ»‘èˆŒä¸Šç´šè€…";
  else if(score >= 85) levelText = "ğŸŒŸ å®‰å®šãƒ¬ãƒ™ãƒ«";
  else if(score >= 75) levelText = "ğŸ‘ è‰¯ã„æµã‚Œ";
  else levelText = "ğŸ”° ä¼¸ã³ã—ã‚ã‚ã‚Šï¼ˆã“ã“ãŒä¼¸ã³ã‚‹ï¼‰";

  document.getElementById("mainText").innerHTML =
`ğŸ§  ä»Šæ—¥ã®AIç·è©•

ç·åˆã‚¹ã‚³ã‚¢ï¼š${score}ç‚¹
${levelText}

è‰¯ã‹ã£ãŸç‚¹ï¼š
${feedback.map(f=>"ãƒ»"+f).join("\n")}

ã²ã¨ã“ã¨ï¼š
ä»Šæ—¥ã‚‚å®Œèµ°ã§ãã¾ã—ãŸğŸ˜Š
ã“ã®ç©ã¿é‡ã­ãŒç¢ºå®Ÿã«æ»‘èˆŒã‚’å¤‰ãˆã¾ã™ã€‚`;
}

/* =========================================================
  âœ… åˆæœŸ
========================================================= */
render();
showDaily();
</script>

</body>
</html>