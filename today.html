<!doctype html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ğŸ”° ä»Šæ—¥ã®ãŠã™ã™ã‚ï¼ˆç¥ãƒ«ãƒ¼ãƒˆï¼‰</title>
<link rel="stylesheet" href="style.css" />

<style>
  .row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;align-items:center;}
  .mini{font-size:14px;opacity:.85;line-height:1.7;}
  .pill{display:inline-block;padding:6px 12px;border-radius:999px;background:rgba(255,255,255,.75);border:1px solid rgba(0,0,0,.12);font-size:14px;}
  .bigTimer{font-size:46px;font-weight:900;text-align:center;margin:10px 0;letter-spacing:0.04em;}
  .phase{font-size:18px;font-weight:900;text-align:center;margin:6px 0;}
  .softBox{background:rgba(255,255,255,.7);border:1px solid rgba(0,0,0,.12);padding:12px;border-radius:14px;}
  .goodBox{background:#eafff0;border:1px solid #86efac;}
  .warnBox{background:#fff7ed;border:1px solid #fdba74;}
  .title2{font-weight:900;margin:2px 0 8px;}
  .badge{font-weight:900;color:#16a34a;}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
  .grid1{display:grid;grid-template-columns:1fr;gap:10px;}
  .btnWide{width:100%;padding:12px 14px;border-radius:14px;border:1px solid rgba(0,0,0,.12);background:#fff;}
  .btnPrimary{background:#0ea5e9;color:#fff;border:none;}
  .btnGood{background:#22c55e;color:#fff;border:none;}
  .btnDanger{background:#ef4444;color:#fff;border:none;}
  .sep{height:1px;background:rgba(0,0,0,.1);margin:12px 0;}
  .logRow{display:flex;gap:8px;flex-wrap:wrap;}
  .dot{width:10px;height:10px;border-radius:50%;display:inline-block;background:#ddd;vertical-align:middle;}
  .dot.ok{background:#22c55e;}
  .dot.ng{background:#ef4444;}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, monospace;}
  .toggle{display:flex;gap:8px;align-items:center;justify-content:center;}
  .smallBtn{padding:10px 12px;border-radius:12px;border:1px solid rgba(0,0,0,.12);background:#fff;}
  .kpi{font-size:22px;font-weight:900;}
</style>
</head>

<body>

<header class="top">
  <h1>ğŸ”° ä»Šæ—¥ã®ãŠã™ã™ã‚ï¼ˆç¥ãƒ«ãƒ¼ãƒˆï¼‰</h1>
  <p class="sub">è¿·ã£ãŸã‚‰ã“ã‚Œã ã‘ã€‚æ¯æ—¥3åˆ†ã§â€œç¿’æ…£åŒ–â†’ä¸Šé”â€</p>
  <p><a href="index.html">â† ãƒ›ãƒ¼ãƒ ã¸</a></p>
</header>

<main class="menu">

  <!-- KPI -->
  <div class="card" style="display:block;">
    <div class="title">ğŸ“ˆ ç¶™ç¶šãƒ‡ãƒ¼ã‚¿</div>
    <div class="desc">
      <div class="grid">
        <div class="softBox">
          <div class="mini">é€£ç¶šé”æˆï¼ˆã‚¹ãƒˆãƒªãƒ¼ã‚¯ï¼‰</div>
          <div class="kpi"><span id="streak" class="badge">0</span>æ—¥</div>
          <div id="rank" class="mini">ç§°å·ï¼šâ€”</div>
        </div>
        <div class="softBox">
          <div class="mini">ä»Šæœˆã®é”æˆç‡</div>
          <div class="kpi"><span id="monthRate">0</span>%</div>
          <div class="mini"><span id="monthDone">0</span>/<span id="monthTotal">0</span>æ—¥</div>
        </div>
      </div>

      <div class="softBox warnBox" style="margin-top:10px;">
        <div class="title2">ğŸ§  ä»Šæ—¥ã®ä¸€è¨€</div>
        <div id="coachMsg" class="mini">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
      </div>
    </div>
  </div>

  <!-- ä»Šæ—¥ã®å†…å®¹ï¼ˆè‡ªå‹•æŠ½é¸ï¼‰ -->
  <div class="card" style="display:block;">
    <div class="title">ğŸ¯ ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼ˆç´„3åˆ†ï¼‰</div>
    <div class="desc">
      <div class="softBox">
        <div class="mini">
          (1) ğŸ’¨ å‘¼å¸ 40ç§’ â†’ (2) ğŸ‘… èˆŒ 60ç§’ â†’ (3) ğŸ‘„ æ»‘èˆŒ 40ç§’ â†’ (4) ğŸ¤ 40ç§’ã‚¹ãƒ”ãƒ¼ãƒ 40ç§’
        </div>

        <div class="sep"></div>

        <div class="grid1">
          <div class="softBox">
            <div class="title2">ğŸ‘„ ä»Šæ—¥ã®æ»‘èˆŒãƒ•ãƒ¬ãƒ¼ã‚º</div>
            <div id="todayPhrase" style="font-weight:900;font-size:18px;line-height:1.8;">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
            <div class="mini" style="margin-top:6px;">â€»ã€Œã‚†ã£ãã‚Šæ­£ç¢ºã«ã€â†’æ…£ã‚ŒãŸã‚‰ãƒ†ãƒ³ãƒUP</div>
          </div>

          <div class="softBox">
            <div class="title2">ğŸ¤ ä»Šæ—¥ã®ã‚¹ãƒ”ãƒ¼ãƒãŠé¡Œ</div>
            <div id="todayTopic" style="font-weight:900;font-size:18px;line-height:1.8;">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
            <div class="mini" style="margin-top:6px;">å‹ï¼šçµè«–â†’ç†ç”±â†’å…·ä½“â†’ã¾ã¨ã‚ï¼ˆ40ç§’ï¼‰</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <button class="btnPrimary btnWide" onclick="startRoute()">â–¶ ä»Šæ—¥ã®ãŠã™ã™ã‚ã‚’é–‹å§‹</button>
        </div>

        <div class="row" style="margin-top:8px;">
          <button class="smallBtn" onclick="reroll()">ğŸ² ä»Šæ—¥ã®å†…å®¹ã‚’å¤‰ãˆã‚‹</button>
          <button class="smallBtn" onclick="resetUI()">âŸ² ãƒªã‚»ãƒƒãƒˆ</button>
        </div>

        <div class="toggle" style="margin-top:10px;">
          <span class="pill">å®Œäº†éŸ³</span>
          <button id="soundBtn" class="smallBtn" onclick="toggleSound()">ON</button>
        </div>

        <div class="mini" style="margin-top:10px;text-align:center;">
          ğŸ’¡ ã¾ãšã€Œæ¯æ—¥3åˆ†ã€ã ã‘ã€‚ä¼¸ã³ã‚‹äººã¯ã€å¿…ãšã“ã“ã‚’å®ˆã£ã¦ã„ã¾ã™ã€‚
        </div>
      </div>
    </div>
  </div>

  <!-- ã‚¬ã‚¤ãƒ‰ã‚¿ã‚¤ãƒãƒ¼ -->
  <div class="card" style="display:block;">
    <div class="title">â± ã‚¬ã‚¤ãƒ‰ï¼ˆè‡ªå‹•ï¼‰</div>
    <div class="desc">
      <div class="phase" id="phase">æº–å‚™OK</div>
      <div class="bigTimer mono" id="timer">00:00</div>

      <div class="row">
        <span class="pill" id="stepLabel">STEP 0/4</span>
        <span class="pill" id="status">å¾…æ©Ÿä¸­</span>
      </div>

      <div class="softBox" style="margin-top:10px;">
        <div class="title2">ã‚„ã‚‹ã“ã¨</div>
        <div id="guide" class="mini">é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€é †ç•ªã«æ¡ˆå†…ã—ã¾ã™ã€‚</div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btnWide" onclick="openBreath()">ğŸ’¨ å‘¼å¸ãƒšãƒ¼ã‚¸ã¸</button>
        <button class="btnWide" onclick="openTongue()">ğŸ‘… èˆŒãƒˆãƒ¬ãƒšãƒ¼ã‚¸ã¸</button>
        <button class="btnWide" onclick="openKatsuzetsu()">ğŸ‘„ æ»‘èˆŒãƒšãƒ¼ã‚¸ã¸</button>
        <button class="btnWide" onclick="open40()">ğŸ¤ 40ç§’ã‚¹ãƒ”ãƒ¼ãƒã¸</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btnDanger btnWide" onclick="stopRoute()">â¹ åœæ­¢</button>
      </div>
    </div>
  </div>

  <!-- å®Œäº† -->
  <div class="card" id="completeCard" style="display:none;">
    <div class="title">âœ… ä»Šæ—¥ã®é”æˆ</div>
    <div class="desc softBox goodBox">
      <div style="font-weight:900;font-size:18px;">å®Œäº†ï¼ä»Šæ—¥ã®è‡ªåˆ†ã€ãˆã‚‰ã„ã€‚</div>
      <div class="mini" style="margin-top:6px;">
        è‡ªä¿¡ã¯ã€Œæ‰èƒ½ã€ã˜ã‚ƒãªãã¦ã€Œå®Ÿè¡Œå›æ•°ã€ã§å¢—ãˆã¾ã™ã€‚
      </div>
    </div>
  </div>

  <!-- ãƒ­ã‚° -->
  <div class="card" style="display:block;">
    <div class="title">ğŸ—“ é”æˆãƒ­ã‚°ï¼ˆä»Šæœˆï¼‰</div>
    <div class="desc">
      <div class="mini">ç·‘ï¼é”æˆ / èµ¤ï¼æœªé”</div>
      <div id="monthLog" class="logRow" style="margin-top:10px;"></div>
    </div>
  </div>

</main>

<!-- å®Œäº†éŸ³ï¼ˆç°¡æ˜“ï¼‰ -->
<audio id="doneSound" preload="auto">
  <!-- ç„¡éŸ³ã§ã‚‚OKã€‚éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯ãƒ“ãƒ¼ãƒ—ã«ã™ã‚‹ãŸã‚WebAudioã‚’ä½¿ã† -->
</audio>

<script>
/* =========================
   âœ… ãƒšãƒ¼ã‚¸ãƒªãƒ³ã‚¯ï¼ˆã‚ãªãŸã®ãƒ•ã‚¡ã‚¤ãƒ«åã«åˆã‚ã›ã¦å¤‰æ›´OKï¼‰
========================= */
function openBreath(){ location.href="breathing.html"; }     // å‘¼å¸ãƒšãƒ¼ã‚¸
function openTongue(){ location.href="shitatore.html"; }     // èˆŒãƒˆãƒ¬
function openKatsuzetsu(){ location.href="katsuzetsu_phrase.html"; } // æ»‘èˆŒï¼ˆã“ã®ãƒšãƒ¼ã‚¸åã¯å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«åã«åˆã‚ã›ã¦ï¼‰
function open40(){ location.href="40.html"; }                // 40ç§’ã‚¹ãƒ”ãƒ¼ãƒï¼ˆå®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«åã«åˆã‚ã›ã¦ï¼‰

/* =========================
   âœ… ä»Šæ—¥ã®æŠ½é¸ãƒ‡ãƒ¼ã‚¿
========================= */
// æ»‘èˆŒãƒ•ãƒ¬ãƒ¼ã‚ºï¼ˆå¥½ãã«å¢—ã‚„ã—ã¦OKï¼‰
const katsuzetsuPhrases = [
  "ã¡ã‚ƒã¡ã‚…ã¡ã‚‡ã€€ã¡ã‚ƒãã¡ã‚‡ã€€ã¡ã‚…ã¡ã‚‡ã¡ã‚ƒ",
  "ãã‚ƒãã‚…ãã‚‡ã€€ãã‚ƒããã‚‡ã€€ãã‚…ãã‚‡ãã‚ƒ",
  "ã—ã‚ƒã—ã‚…ã—ã‚‡ã€€ã—ã‚ƒãã—ã‚‡ã€€ã—ã‚…ã—ã‚‡ã—ã‚ƒ",
  "ãŒããã’ã”ã€€ãŒã’ã”ã€€ããã’",
  "ã ã¢ã¥ã§ã©ã€€ã ã§ã©ã€€ã¢ã¥ã§",
  "ã°ã³ã¶ã¹ã¼ã€€ã°ã¹ã¼ã€€ã³ã¶ã¹",
  "ã±ã´ã·ãºã½ã€€ã±ãºã½ã€€ã´ã·ãº",
  "ãƒã‚¹ã‚¬ã‚¹çˆ†ç™ºï¼ˆã°ã™ãŒã™ã°ãã¯ã¤ï¼‰",
  "æ±äº¬ç‰¹è¨±è¨±å¯å±€ï¼ˆã¨ã†ãã‚‡ã†ã¨ã£ãã‚‡ãã‚‡ã‹ãã‚‡ãï¼‰",
  "éš£ã®å®¢ã¯ã‚ˆãæŸ¿é£Ÿã†å®¢ã ",
  "ç”Ÿéº¦ ç”Ÿç±³ ç”Ÿåµï¼ˆãªã¾ã‚€ã ãªã¾ã”ã‚ ãªã¾ãŸã¾ã”ï¼‰",
  "èµ¤å·»ç´™ é’å·»ç´™ é»„å·»ç´™ï¼ˆã‚ã‹ã¾ããŒã¿ ã‚ãŠã¾ããŒã¿ ãã¾ããŒã¿ï¼‰",
];

// ã‚¹ãƒ”ãƒ¼ãƒãŠé¡Œ
const speechTopics = [
  "æœ€è¿‘ã†ã‚Œã—ã‹ã£ãŸã“ã¨ï¼ˆçµè«–â†’ç†ç”±â†’å…·ä½“â†’ã¾ã¨ã‚ï¼‰",
  "æœ€è¿‘å­¦ã‚“ã ã“ã¨ã‚’1ã¤å…±æœ‰ã—ã¦ã¿ã‚‹",
  "ä»Šæ—¥ã®è‡ªåˆ†ã‚’è¤’ã‚ãŸã„ãƒã‚¤ãƒ³ãƒˆ",
  "è‹¦æ‰‹ã ã£ãŸã‘ã©å°‘ã—å‰é€²ã—ãŸã“ã¨",
  "äººã«ãŠã™ã™ã‚ã—ãŸã„ç¿’æ…£",
  "ä»•äº‹ã§å¤§äº‹ã«ã—ã¦ã„ã‚‹ã“ã¨",
  "å¤±æ•—ã‹ã‚‰å­¦ã‚“ã ã“ã¨",
  "å­ã©ã‚‚ã®é ƒå¥½ãã ã£ãŸã‚‚ã®",
  "æœ€è¿‘ãƒãƒã£ã¦ã„ã‚‹ã‚‚ã®",
  "å°†æ¥ã‚„ã£ã¦ã¿ãŸã„ã“ã¨",
];

function randFrom(arr){
  return arr[Math.floor(Math.random()*arr.length)];
}

/* =========================
   âœ… ãƒ«ãƒ¼ãƒˆï¼ˆ3åˆ†ï¼‰
========================= */
const route = [
  { title:"ğŸ’¨ å‘¼å¸ï¼ˆ4-4-8ï¼‰", sec:40, guide:"4ç§’å¸ã†â†’4ç§’æ­¢ã‚ã‚‹â†’8ç§’åãã€‚è‹¦ã—ã‘ã‚Œã° 3-3-6 ã§ã‚‚OKã€‚" },
  { title:"ğŸ‘… èˆŒãƒˆãƒ¬ï¼ˆåŸºæœ¬ï¼‰", sec:60, guide:"ã‚¹ãƒãƒƒãƒˆã‚¿ãƒƒãƒï¼ˆä¸Šã®å‰æ­¯ã®è£ã«èˆŒå…ˆï¼‰â†’ã‚¿ãƒ»ãƒ†ãƒ»ãƒˆã‚’ä¸å¯§ã«ã€‚" },
  { title:"ğŸ‘„ æ»‘èˆŒï¼ˆä»Šæ—¥ã®ãƒ•ãƒ¬ãƒ¼ã‚ºï¼‰", sec:40, guide:"ã‚†ã£ãã‚Šæ­£ç¢ºã«ã€‚å£ã‚’å¤§ããã€èˆŒå…ˆã‚’æ„è­˜ã€‚" },
  { title:"ğŸ¤ 40ç§’ã‚¹ãƒ”ãƒ¼ãƒ", sec:40, guide:"çµè«–â†’ç†ç”±â†’å…·ä½“â†’ã¾ã¨ã‚ã€‚è¨€è‘‰ãŒè©°ã¾ã£ã¦ã‚‚OKã€æ­¢ã¾ã‚‰ãªã„ç·´ç¿’ã€‚" },
];

let stepIndex=-1;
let remain=0;
let timerId=null;
let running=false;

/* =========================
   âœ… éŸ³ï¼ˆON/OFFï¼‰
========================= */
let soundOn = true;
function toggleSound(){
  soundOn = !soundOn;
  document.getElementById("soundBtn").textContent = soundOn ? "ON" : "OFF";
}
function beep(){
  if(!soundOn) return;
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = "sine";
    osc.frequency.value = 880;
    gain.gain.value = 0.07;
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    setTimeout(()=>{osc.stop(); ctx.close();}, 200);
  }catch(e){}
}

/* =========================
   âœ… æ—¥ä»˜ãƒ»ä¿å­˜ï¼ˆLocalStorageï¼‰
========================= */
function todayKey(){
  const d=new Date();
  return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
}
function monthKey(){
  const d=new Date();
  return `${d.getFullYear()}-${d.getMonth()+1}`;
}
function daysInMonth(){
  const d=new Date();
  return new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
}

function getMonthLog(){
  const key="log_"+monthKey();
  const raw=localStorage.getItem(key);
  return raw ? JSON.parse(raw) : {};
}
function setMonthLog(obj){
  const key="log_"+monthKey();
  localStorage.setItem(key, JSON.stringify(obj));
}

/* =========================
   âœ… ã‚¹ãƒˆãƒªãƒ¼ã‚¯è¨ˆç®—
========================= */
function calcStreak(){
  const lastDone = localStorage.getItem("lastDone");
  let streak = Number(localStorage.getItem("streak")||0);

  if(!lastDone){
    localStorage.setItem("streak","0");
    return 0;
  }

  const now=new Date();
  const y=new Date(); y.setDate(now.getDate()-1);
  const yKey = `${y.getFullYear()}-${y.getMonth()+1}-${y.getDate()}`;

  if(lastDone === todayKey()){
    return streak;
  }
  if(lastDone === yKey){
    return streak; // ã¾ã ä»Šæ—¥ã‚„ã£ã¦ãªã„ãŒã€é€”åˆ‡ã‚Œã¦ã¯ã„ãªã„ï¼ˆã‚„ã‚Œã°ä¼¸ã³ã‚‹ï¼‰
  }
  // é€”åˆ‡ã‚ŒãŸ
  localStorage.setItem("streak","0");
  return 0;
}

function saveDone(){
  const lastDone = localStorage.getItem("lastDone");
  let streak = Number(localStorage.getItem("streak")||0);

  if(lastDone === todayKey()) return; // äºŒé‡ä¿å­˜é˜²æ­¢

  const now=new Date();
  const y=new Date(); y.setDate(now.getDate()-1);
  const yKey = `${y.getFullYear()}-${y.getMonth()+1}-${y.getDate()}`;

  if(lastDone === yKey){
    streak = streak + 1;
  }else{
    streak = 1;
  }

  localStorage.setItem("streak", String(streak));
  localStorage.setItem("lastDone", todayKey());

  // æœˆãƒ­ã‚°ä¿å­˜
  const log=getMonthLog();
  const day = new Date().getDate();
  log[String(day)] = true;
  setMonthLog(log);
}

/* =========================
   âœ… ç§°å·ï¼ˆ7/14/30ï¼‰
========================= */
function rankByStreak(s){
  if(s>=30) return "ğŸ† ç¿’æ…£åŒ–ãƒã‚¹ã‚¿ãƒ¼ï¼ˆ30æ—¥ï¼‰";
  if(s>=14) return "ğŸ”¥ ç¶™ç¶šä¸Šç´šè€…ï¼ˆ14æ—¥ï¼‰";
  if(s>=7)  return "ğŸŒ± ç¶šã‘ã‚‹åŠ›ãŒã¤ã„ãŸï¼ˆ7æ—¥ï¼‰";
  if(s>=3)  return "âœ… ã„ã„æµã‚Œï¼ˆ3æ—¥ï¼‰";
  if(s>=1)  return "ğŸ‰ ã¯ã˜ã‚ã®ä¸€æ­©";
  return "â€”";
}

/* =========================
   âœ… ä»Šæ—¥ã®ä¸€è¨€ï¼ˆæ®µéšã§å¤‰åŒ–ï¼‰
========================= */
function coachMessage(s){
  if(s>=30) return "ã‚‚ã†â€œã§ãã‚‹äººâ€å´ã§ã™ã€‚æ¬¡ã¯ã€Œè³ªã€ã‚’ä¸Šã’ã¦ä¼¸ã°ã—ã¾ã—ã‚‡ã†ã€‚";
  if(s>=14) return "ç¶™ç¶šãŒå½¢ã«ãªã£ã¦ãã¾ã—ãŸã€‚ç·´ç¿’ã¯è£åˆ‡ã‚Šã¾ã›ã‚“ã€‚";
  if(s>=7)  return "7æ—¥ç¶šã„ãŸã‚‰ã€è„³ãŒâ€œå½“ãŸã‚Šå‰â€ã«å¤‰ã‚ã‚Šã¾ã™ã€‚ã“ã“ãŒå‹è² æ‰€ã€‚";
  if(s>=3)  return "3æ—¥ç¶šã„ãŸã‚‰æ‰èƒ½ã§ã™ã€‚ä»Šæ—¥ã¯â€œçŸ­ãã¦ã‚‚OKâ€ã§ç¶šã‘ã‚ˆã†ã€‚";
  if(s>=1)  return "ä»Šæ—¥ã¯â€œã‚„ã£ãŸäº‹å®Ÿâ€ãŒã™ã¹ã¦ã€‚å®Œç’§ã‚ˆã‚Šç¶™ç¶šã€‚";
  return "è¿·ã£ãŸã‚‰3åˆ†ã ã‘ã€‚è‡ªä¿¡ã¯ã“ã“ã‹ã‚‰ä½œã‚Œã¾ã™ã€‚";
}

/* =========================
   âœ… ä»ŠæœˆKPIè¡¨ç¤º
========================= */
function renderMonth(){
  const log=getMonthLog();
  const total=daysInMonth();
  let done=0;
  for(const k in log){ if(log[k]) done++; }

  const rate = Math.round((done/total)*100);
  document.getElementById("monthRate").textContent = isFinite(rate)?rate:0;
  document.getElementById("monthDone").textContent = done;
  document.getElementById("monthTotal").textContent = total;

  // ãƒ­ã‚°è¡¨ç¤ºï¼ˆ1ã€œæœˆæœ«ï¼‰
  const box=document.getElementById("monthLog");
  box.innerHTML="";
  for(let d=1; d<=total; d++){
    const ok=!!log[String(d)];
    const span=document.createElement("span");
    span.className="pill";
    span.innerHTML = `<span class="dot ${ok?'ok':'ng'}"></span> ${d}`;
    box.appendChild(span);
  }
}

/* =========================
   âœ… ä»Šæ—¥ã®æŠ½é¸ï¼ˆå›ºå®šåŒ–ï¼åŒã˜æ—¥ãªã‚‰åŒã˜å†…å®¹ï¼‰
========================= */
function seedRand(str){
  // ç°¡æ˜“ãƒãƒƒã‚·ãƒ¥â†’æ“¬ä¼¼ä¹±æ•°
  let h=2166136261;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return ()=>{
    h += 0x6D2B79F5;
    let t = Math.imul(h ^ (h>>>15), 1 | h);
    t ^= t + Math.imul(t ^ (t>>>7), 61 | t);
    return ((t ^ (t>>>14)) >>> 0) / 4294967296;
  };
}

let todayPhrase="";
let todayTopic="";

function rollToday(force=false){
  const key="todayPack_"+todayKey();
  if(!force){
    const saved=localStorage.getItem(key);
    if(saved){
      const obj=JSON.parse(saved);
      todayPhrase=obj.phrase;
      todayTopic=obj.topic;
      return;
    }
  }

  const rnd = seedRand(todayKey());
  todayPhrase = katsuzetsuPhrases[Math.floor(rnd()*katsuzetsuPhrases.length)];
  todayTopic  = speechTopics[Math.floor(rnd()*speechTopics.length)];

  localStorage.setItem(key, JSON.stringify({phrase:todayPhrase, topic:todayTopic}));
}

function renderToday(){
  document.getElementById("todayPhrase").textContent = todayPhrase;
  document.getElementById("todayTopic").textContent  = todayTopic;
}

function reroll(){
  rollToday(true);
  renderToday();
}

/* =========================
   âœ… ã‚¿ã‚¤ãƒãƒ¼
========================= */
function fmt(sec){
  const m=String(Math.floor(sec/60)).padStart(2,"0");
  const s=String(sec%60).padStart(2,"0");
  return `${m}:${s}`;
}

function resetUI(){
  stopRoute();
  document.getElementById("phase").textContent="æº–å‚™OK";
  document.getElementById("timer").textContent="00:00";
  document.getElementById("stepLabel").textContent="STEP 0/4";
  document.getElementById("status").textContent="å¾…æ©Ÿä¸­";
  document.getElementById("guide").textContent="é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€é †ç•ªã«æ¡ˆå†…ã—ã¾ã™ã€‚";
  document.getElementById("completeCard").style.display="none";
}

function startRoute(){
  if(running) return;
  running=true;
  stepIndex=-1;
  document.getElementById("status").textContent="é€²è¡Œä¸­";
  nextStep();
}

function stopRoute(){
  running=false;
  clearInterval(timerId);
  timerId=null;
  document.getElementById("status").textContent="åœæ­¢";
}

function nextStep(){
  stepIndex++;
  if(stepIndex>=route.length){
    finishRoute();
    return;
  }

  const st=route[stepIndex];
  remain=st.sec;

  document.getElementById("phase").textContent = st.title;
  document.getElementById("timer").textContent = fmt(remain);
  document.getElementById("stepLabel").textContent = `STEP ${stepIndex+1}/4`;

  // STEP3/4ã¯ä»Šæ—¥ã®å†…å®¹ã‚’ã‚¬ã‚¤ãƒ‰ã«åæ˜ 
  let g = st.guide;
  if(stepIndex===2){
    g = `ä»Šæ—¥ã®ãƒ•ãƒ¬ãƒ¼ã‚ºï¼š${todayPhrase}\n` + st.guide;
  }
  if(stepIndex===3){
    g = `ä»Šæ—¥ã®ãŠé¡Œï¼š${todayTopic}\n` + st.guide;
  }
  document.getElementById("guide").textContent = g;

  beep();

  clearInterval(timerId);
  timerId=setInterval(()=>{
    if(!running) return;
    remain--;
    document.getElementById("timer").textContent = fmt(remain);
    if(remain<=0){
      clearInterval(timerId);
      timerId=null;
      beep();
      setTimeout(()=>{ if(running) nextStep(); }, 600);
    }
  },1000);
}

function finishRoute(){
  running=false;
  document.getElementById("status").textContent="å®Œäº†";
  document.getElementById("completeCard").style.display="block";

  // âœ… ä¿å­˜ï¼ˆã‚¹ãƒˆãƒªãƒ¼ã‚¯ï¼‹æœˆãƒ­ã‚°ï¼‰
  saveDone();

  // è¡¨ç¤ºæ›´æ–°
  renderStats();
  renderMonth();

  // å®Œäº†éŸ³
  beep();
}

/* =========================
   âœ… è¡¨ç¤ºæ›´æ–°ã¾ã¨ã‚
========================= */
function renderStats(){
  const s = calcStreak();
  const streak = (localStorage.getItem("lastDone")===todayKey())
    ? Number(localStorage.getItem("streak")||0)
    : s;

  document.getElementById("streak").textContent = streak;
  document.getElementById("rank").textContent = "ç§°å·ï¼š" + rankByStreak(streak);
  document.getElementById("coachMsg").textContent = coachMessage(streak);
}

/* åˆæœŸ */
rollToday(false);
renderToday();
renderStats();
renderMonth();
resetUI();

</script>

</body>
</html>
