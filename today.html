<!doctype html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”° ä»Šæ—¥ã®ãŠã™ã™ã‚ç·´ç¿’</title>
<link rel="stylesheet" href="style.css">

<style>
  .big{font-size:36px;font-weight:900;text-align:center;margin:10px 0; line-height:1.5;}
  .mid{font-size:22px;font-weight:800;text-align:center;margin:6px 0;}
  .small{text-align:center;opacity:.85;font-size:14px;line-height:1.7;white-space:pre-wrap;}
  .highlight{color:#e60033;font-weight:900;}

  /* ã‚«ãƒ©ã‚ªã‚±è¡¨ç¤º */
  .karaWrap{
    display:inline-block;
    padding:4px 6px;
    border-radius:10px;
    transition: background-color .18s ease, color .18s ease, opacity .18s ease, transform .18s ease;
  }
  .karaWrap.active{
    background: rgba(239,68,68,0.18);
    color:#ef4444;
    transform: scale(1.02);
  }
  .karaWrap.done{opacity:.45;}
  .karaWrap.skip{opacity:.65;} /* ç©ºç™½ç­‰ */

  /* ãµã‚ŠãŒãª */
  ruby{ruby-position: over;}
  rt{font-size:10px; opacity:.9;}

  .center{text-align:center;}
  .btnRow{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:10px;}
  .btn{padding:12px 16px;border-radius:12px;border:none;font-weight:900;}
  .primary{background:#0ea5e9;color:#fff;}
  .danger{background:#ef4444;color:#fff;}
  .ghost{background:#fff;border:1px solid rgba(0,0,0,.2);}

  .pill{
    display:inline-block;
    padding:6px 12px;
    border-radius:999px;
    border:1px solid rgba(0,0,0,.12);
    background:rgba(255,255,255,.75);
    font-size:14px;
    font-weight:800;
  }
</style>
</head>

<body>

<header class="top">
  <h1>ğŸ”° ä»Šæ—¥ã®ãŠã™ã™ã‚ç·´ç¿’</h1>
  <p><a href="index.html">â† ãƒ›ãƒ¼ãƒ ã¸</a></p>
</header>

<main class="menu">

  <div class="card">
    <div class="title">ä¸€æœ¬é“ãƒ«ãƒ¼ãƒˆï¼ˆç´„4ã€œ6åˆ†ï¼‰</div>
    <div class="desc small">
å‘¼å¸ â†’ èˆŒãƒˆãƒ¬ â†’ æ»‘èˆŒï¼ˆã‚ã€œã‚è¡Œï¼‰â†’ è¨€ã„ã«ãã„10é¸ â†’ 30ç§’ã‚¹ãƒ”ãƒ¼ãƒ
    </div>

    <div class="btnRow">
      <button class="btn primary" onclick="startAll()">â–¶ é–‹å§‹</button>
      <button class="btn danger" onclick="stopAll()">â¹ åœæ­¢</button>
      <button class="btn ghost" onclick="changeTopic()">ğŸ² è©±é¡Œå¤‰æ›´</button>
    </div>

    <div class="center" style="margin-top:10px;">
      <span class="pill" id="statePill">å¾…æ©Ÿä¸­</span>
    </div>
  </div>

  <div class="card">
    <div id="phase" class="mid">æº–å‚™OK</div>
    <div id="display" class="big">00</div>
    <div id="sub" class="small">ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
  </div>

</main>

<script>
/* =========================
   å…¨ä½“åˆ¶å¾¡ï¼ˆä¸­æ–­ã§ãã‚‹è¨­è¨ˆï¼‰
========================= */
let runToken = 0;            // é–‹å§‹ã”ã¨ã«å¢—ãˆã‚‹ï¼ˆå¤ã„å‡¦ç†ã‚’ç„¡åŠ¹åŒ–ï¼‰
let speechToken = 0;         // ã‚¹ãƒ”ãƒ¼ãƒã ã‘åˆ¥ãƒˆãƒ¼ã‚¯ãƒ³
let speechRunning = false;

function wait(ms){
  return new Promise(res=>setTimeout(res,ms));
}
function setPhase(t){ document.getElementById("phase").textContent=t; }
function setDisplay(t){ document.getElementById("display").innerHTML=t; }
function setSub(t){ document.getElementById("sub").textContent=t; }
function setState(t){ document.getElementById("statePill").textContent=t; }

function isStopped(token){
  return token !== runToken;
}

function stopAll(){
  // é€²è¡Œä¸­ã®ã™ã¹ã¦ã®å‡¦ç†ã‚’æ­¢ã‚ã‚‹
  runToken++;
  speechToken++;
  speechRunning = false;
  setState("åœæ­¢");
  setPhase("â¹ åœæ­¢ã—ã¾ã—ãŸ");
  setDisplay("00");
  setSub("å†é–‹ã™ã‚‹å ´åˆã¯ã€Œé–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„");
}

/* =========================
   å‘¼å¸ 4-4-8 Ã—3ï¼ˆãã®ã¾ã¾ï¼‰
========================= */
async function breathing(token){
  setPhase("ğŸ’¨ å‘¼å¸");
  for(let round=1; round<=3; round++){
    if(isStopped(token)) return;

    setSub(`ãƒ©ã‚¦ãƒ³ãƒ‰ ${round}/3ï¼šã¯ã„å¸ã£ã¦ã€œ`);
    for(let i=1;i<=4;i++){
      if(isStopped(token)) return;
      setDisplay(i);
      await wait(1000);
    }

    setSub("ã¯ã„æ­¢ã‚ã¦");
    for(let i=1;i<=4;i++){
      if(isStopped(token)) return;
      setDisplay(i);
      await wait(1000);
    }

    setSub("ã¯ã„åã„ã¦ã€œ ãƒ•ã‚¥ã€œ");
    for(let i=1;i<=8;i++){
      if(isStopped(token)) return;
      setDisplay(i);
      await wait(1000);
    }
  }
}

/* =========================
   èˆŒãƒˆãƒ¬ï¼ˆ3ç§’ã§1å› / 7å›ï¼‰
========================= */
async function tongue(token){
  setPhase("ğŸ‘… èˆŒãƒˆãƒ¬");
  setSub("æ¬¡ã¯èˆŒãƒˆãƒ¬ã§ã™ã€‚èˆŒå…ˆã§å£ã®ä¸­ã‚’å¤§ããå›ã—ã¾ã™ã€‚");
  setDisplay(" ");
  await wait(1500);

  // å³å›ã‚Š
  setSub("å³å›ã‚Š 7å›ï¼ˆã‚†ã£ãã‚Šï¼š1å›ï¼3ç§’ï¼‰");
  await wait(1200);
  for(let i=1;i<=7;i++){
    if(isStopped(token)) return;
    setDisplay(i);
    await wait(3000); // 3ç§’ã§1ã‚«ã‚¦ãƒ³ãƒˆ
  }

  // å·¦å›ã‚Š
  setSub("æ¬¡ã¯å·¦å›ã‚Š 7å›ã§ã™ï¼ˆ1å›ï¼3ç§’ï¼‰");
  setDisplay(" ");
  await wait(1200);
  for(let i=1;i<=7;i++){
    if(isStopped(token)) return;
    setDisplay(i);
    await wait(3000);
  }

  setSub("OKï¼èˆŒãŒå‹•ãã‚„ã™ããªã‚Šã¾ã—ãŸã€‚");
  setDisplay(" ");
}

/* =========================
   ã‚«ãƒ©ã‚ªã‚±ï¼ˆrubyå¯¾å¿œ / ç©ºç™½ã‚¹ãƒ«ãƒ¼ / æ»‘ã‚‰ã‹ï¼‰
   - å¼•æ•° htmlText ã‚’è¡¨ç¤ºã™ã‚‹ï¼ˆrubyå«ã‚€OKï¼‰
   - highlightTargetsï¼šãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹å˜ä½ã®é…åˆ—ï¼ˆDOMä¸Šã®span.karaWrapï¼‰
========================= */
function buildKaraokeDOMFromHTML(htmlText){
  const display = document.getElementById("display");
  display.className = "big";
  display.innerHTML = "";

  // ãƒ©ãƒƒãƒ‘ãƒ¼
  const wrapper = document.createElement("div");
  wrapper.style.display = "inline-block";
  wrapper.style.textAlign = "center";

  // ã„ã£ãŸã‚“HTMLã‚’DOMã«ã—ã¦åŠ å·¥
  const temp = document.createElement("div");
  temp.innerHTML = htmlText;

  const targets = [];

  // å­ãƒãƒ¼ãƒ‰ã‚’èµ°æŸ»ã—ã¦ã€ã€Œrubyã¯1å˜ä½ã€ã€Œé€šå¸¸ãƒ†ã‚­ã‚¹ãƒˆã¯æ–‡å­—å˜ä½ï¼ˆç©ºç™½ã‚¹ã‚­ãƒƒãƒ—ï¼‰ã€
  function appendNode(node){
    if(node.nodeType === Node.TEXT_NODE){
      const txt = node.textContent || "";
      for(const ch of Array.from(txt)){
        const sp = document.createElement("span");
        sp.className = "karaWrap" + (/\s/.test(ch) ? " skip" : "");
        sp.textContent = ch;
        wrapper.appendChild(sp);
        targets.push(sp);
      }
      return;
    }

    if(node.nodeType === Node.ELEMENT_NODE){
      const tag = node.tagName.toLowerCase();

      if(tag === "ruby"){
        // rubyå…¨ä½“ã‚’1å˜ä½ã«ã™ã‚‹ï¼ˆãµã‚ŠãŒãªå´ã«äºŒé‡ãƒã‚¤ãƒ©ã‚¤ãƒˆãŒå…¥ã‚‰ãªã„ï¼‰
        const sp = document.createElement("span");
        sp.className = "karaWrap";
        sp.appendChild(node.cloneNode(true));
        wrapper.appendChild(sp);
        targets.push(sp);
        return;
      }

      // ãã‚Œä»¥å¤–ã®è¦ç´ ã¯ä¸­èº«ã‚’å†å¸°
      for(const child of Array.from(node.childNodes)){
        appendNode(child);
      }
      return;
    }
  }

  for(const n of Array.from(temp.childNodes)){
    appendNode(n);
  }

  display.appendChild(wrapper);
  return targets;
}

async function karaokeHTML(token, htmlText, unitMs){
  const targets = buildKaraokeDOMFromHTML(htmlText);

  for(let i=0;i<targets.length;i++){
    if(isStopped(token)) return;

    const el = targets[i];
    // ç©ºç™½ãªã©skipã¯è‰²ä»˜ã‘ã—ãªã„ï¼ˆã™ãdoneã«ã™ã‚‹ï¼‰
    if(el.classList.contains("skip")){
      el.classList.add("done");
      await wait(Math.max(60, Math.floor(unitMs*0.35)));
      continue;
    }

    el.classList.add("active");
    await wait(unitMs);
    el.classList.remove("active");
    el.classList.add("done");
  }

  await wait(350);
}

/* =========================
   æ»‘èˆŒï¼ˆã‚è¡Œã€œã‚è¡Œï¼‰
   - 3ç§’ç©ºã‘ã¦ã‹ã‚‰é–‹å§‹
   - 1èªï¼ˆ=1è¡Œï¼‰2ç§’ã§é€²ã‚€
========================= */
async function gyou(token){
  await wait(3000); // â˜… 3ç§’ç©ºã‘ã‚‹
  if(isStopped(token)) return;

  setPhase("ğŸ‘„ æ»‘èˆŒï¼ˆã‚ã€œã‚è¡Œï¼‰");
  setSub("1èªãšã¤ä¸å¯§ã«ç™ºå£°ã—ã¾ã—ã‚‡ã†ï¼ˆ2ç§’/1èªï¼‰");

  const lines=[
    "ã‚ã„ã†ãˆãŠ",
    "ã‹ããã‘ã“",
    "ã•ã—ã™ã›ã",
    "ãŸã¡ã¤ã¦ã¨",
    "ãªã«ã¬ã­ã®",
    "ã¯ã²ãµã¸ã»",
    "ã¾ã¿ã‚€ã‚ã‚‚",
    "ã‚„ã‚†ã‚ˆ",
    "ã‚‰ã‚Šã‚‹ã‚Œã‚",
    "ã‚ã‚’ã‚“"
  ];

  // ã€Œ1èª2ç§’ã€ãªã®ã§ã€è¡Œå…¨ä½“ã‚’1å˜ä½ã¨ã—ã¦2ç§’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
  for(const l of lines){
    if(isStopped(token)) return;
    await karaokeHTML(token, `<span>${l}</span>`, 2000);
  }
}

/* =========================
   è¨€ã„ã«ãã„10é¸ï¼ˆrubyã§å®Œå…¨ãƒ•ãƒªã‚¬ãƒŠï¼‰
   - 3ç§’ç©ºã‘ã¦ã‹ã‚‰é–‹å§‹
   - æ¼¢å­—å´ã ã‘ãŒ1å˜ä½ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã‚‹ï¼ˆrubyå˜ä½ï¼‰
   - ç©ºç™½ã¯ã‚¹ãƒ«ãƒ¼
========================= */
async function hard10(token){
  await wait(3000); // â˜… 3ç§’ç©ºã‘ã‚‹
  if(isStopped(token)) return;

  setPhase("ğŸ“¢ è¨€ã„ã«ãã„ãƒ•ãƒ¬ãƒ¼ã‚º10é¸ï¼ˆãƒ•ãƒªã‚¬ãƒŠä»˜ãï¼‰");
  setSub("æ¼¢å­—ã®ä¸Šã«ãƒ•ãƒªã‚¬ãƒŠã€‚è‰²ã¯æ¼¢å­—å´ã ã‘ã«å…¥ã‚Šã¾ã™ï¼ˆç©ºç™½ã¯ã‚¹ãƒ«ãƒ¼ï¼‰");

  const list=[
    `<ruby>æ±äº¬<rt>ã¨ã†ãã‚‡ã†</rt></ruby><ruby>ç‰¹è¨±<rt>ã¨ã£ãã‚‡</rt></ruby><ruby>è¨±å¯å±€<rt>ãã‚‡ã‹ãã‚‡ã</rt></ruby>`,
    `<ruby>ç”Ÿéº¦<rt>ãªã¾ã‚€ã</rt></ruby>ã€€<ruby>ç”Ÿç±³<rt>ãªã¾ã”ã‚</rt></ruby>ã€€<ruby>ç”Ÿåµ<rt>ãªã¾ãŸã¾ã”</rt></ruby>`,
    `<ruby>èµ¤å·»ç´™<rt>ã‚ã‹ã¾ããŒã¿</rt></ruby>ã€€<ruby>é’å·»ç´™<rt>ã‚ãŠã¾ããŒã¿</rt></ruby>ã€€<ruby>é»„å·»ç´™<rt>ãã¾ããŒã¿</rt></ruby>`,
    `<ruby>éš£<rt>ã¨ãªã‚Š</rt></ruby>ã®<ruby>å®¢<rt>ãã‚ƒã</rt></ruby>ã¯ã‚ˆã<ruby>æŸ¿<rt>ã‹ã</rt></ruby><ruby>é£Ÿ<rt>ã</rt></ruby>ã†<ruby>å®¢<rt>ãã‚ƒã</rt></ruby>ã `,
    `<ruby>æ‰“è€…<rt>ã ã—ã‚ƒ</rt></ruby><ruby>èµ°è€…<rt>ãã†ã—ã‚ƒ</rt></ruby><ruby>å‹è€…<rt>ã—ã‚‡ã†ã—ã‚ƒ</rt></ruby>`,
    `<ruby>é­”è¡“å¸«<rt>ã¾ã˜ã‚…ã¤ã—</rt></ruby><ruby>æ‰‹è¡“ä¸­<rt>ã—ã‚…ã˜ã‚…ã¤ã¡ã‚…ã†</rt></ruby>`,
    `<ruby>æ—…å®¢æ©Ÿ<rt>ã‚Šã‚‡ã‹ã£ã</rt></ruby>ã€€<ruby>æ—…å®¢èˆ¹<rt>ã‚Šã‚‡ã‹ãã›ã‚“</rt></ruby>ã€€<ruby>æ—…é¤¨<rt>ã‚Šã‚‡ã‹ã‚“</rt></ruby>`,
    `<ruby>å–æ¨é¸æŠ<rt>ã—ã‚…ã—ã‚ƒã›ã‚“ãŸã</rt></ruby>ã€€<ruby>è©¦å†™å®¤<rt>ã—ã—ã‚ƒã—ã¤</rt></ruby>ã€€<ruby>æ”¯ç¤¾è¦–å¯Ÿ<rt>ã—ã—ã‚ƒã—ã•ã¤</rt></ruby>`,
    `<ruby>æœ€çµ‚æ‰‹æ®µ<rt>ã•ã„ã—ã‚…ã†ã—ã‚…ã ã‚“</rt></ruby>ã€€<ruby>åé›†<rt>ã—ã‚…ã†ã—ã‚…ã†</rt></ruby>ã€€<ruby>é›†ä¸­<rt>ã—ã‚…ã†ã¡ã‚…ã†</rt></ruby>`,
    `<ruby>ç‰¹æ€¥åˆ—è»Š<rt>ã¨ã£ãã‚…ã†ã‚Œã£ã—ã‚ƒ</rt></ruby>ã€€<ruby>æ™®é€šåˆ—è»Š<rt>ãµã¤ã†ã‚Œã£ã—ã‚ƒ</rt></ruby>`
  ];

  // 1å˜ä½ã‚ãŸã‚Š 450msï¼ˆæ»‘ã‚‰ã‹ï¼†ãƒ†ãƒ³ãƒè‰¯ãï¼‰
  // â€»é€Ÿã™ããŸã‚‰ã“ã“ã‚’ 520ã€œ650 ã«ä¸Šã’ã¦OK
  const unitMs = 450;

  for(const item of list){
    if(isStopped(token)) return;
    await karaokeHTML(token, item, unitMs);
    await wait(450);
  }
}

/* =========================
   30ç§’ã‚¹ãƒ”ãƒ¼ãƒï¼ˆåœæ­¢ï¼†è©±é¡Œå¤‰æ›´ï¼‰
   - 5ç§’ç©ºã‘ã¦ã‹ã‚‰é–‹å§‹
========================= */
const topics=[
  "ã‚ãªãŸã®å¥½ããªé£Ÿã¹ç‰©ï¼ˆç†ç”±ã‚‚æ·»ãˆã¦ï¼‰",
  "ã‚ãªãŸã®è‹¦æ‰‹ãªé£Ÿã¹ç‰©ï¼ˆã©ã†å·¥å¤«ã—ã¦ã‚‹ï¼Ÿï¼‰",
  "ã‚ãªãŸã®å‡ºèº«åœ°ï¼ˆãŠã™ã™ã‚ãƒã‚¤ãƒ³ãƒˆï¼‰",
  "å­ã©ã‚‚ã®é ƒã‚ˆãéŠã‚“ã ã“ã¨",
  "æ˜”ã‚„ã£ã¦ã„ãŸã‚¹ãƒãƒ¼ãƒ„ï¼ˆæ€ã„å‡ºï¼‰",
  "ä»Šä½ã‚“ã§ã„ã‚‹å ´æ‰€ï¼ˆå¥½ããªæ‰€ï¼‰",
  "ã‚ãªãŸã®ä»•äº‹ï¼ˆä¸€è¨€ã§è¨€ã†ã¨ï¼‰",
  "ã“ã‚Œã‹ã‚‰æŒ‘æˆ¦ã—ãŸã„ä»•äº‹ãƒ»æ´»å‹•",
  "æœ€è¿‘ã†ã‚Œã—ã‹ã£ãŸã“ã¨",
  "æœ€è¿‘å­¦ã‚“ã ã“ã¨",
  "æœ€è¿‘ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã“ã¨",
  "ã‚ãªãŸã®å¼·ã¿ï¼ˆã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ä»˜ãï¼‰",
  "ã‚ãªãŸã®å¼±ã¿ï¼ˆæ”¹å–„ã®å·¥å¤«ï¼‰",
  "å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ä¾¡å€¤è¦³",
  "äººã«è¤’ã‚ã‚‰ã‚Œã¦å¬‰ã—ã‹ã£ãŸã“ã¨",
  "æœ€è¿‘ãƒãƒã£ã¦ã„ã‚‹ã“ã¨",
  "æœ€è¿‘è¦‹ãŸ/èª­ã‚“ã ã‚‚ã®ã§å°è±¡ã«æ®‹ã£ãŸã‚‚ã®",
  "å°Šæ•¬ã™ã‚‹äººï¼ˆç†ç”±ï¼‰",
  "æ„Ÿè¬ã—ã¦ã„ã‚‹äººï¼ˆç†ç”±ï¼‰",
  "ã„ã¾é ‘å¼µã£ã¦ã„ã‚‹ã“ã¨",
  "æœ€è¿‘ã®å°ã•ãªæˆåŠŸ",
  "æœ€è¿‘ã®å¤±æ•—ã¨å­¦ã³",
  "ã‚ãªãŸã®æœã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³",
  "ã‚ãªãŸã®å¤œã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³",
  "ä¼‘æ—¥ã®éã”ã—æ–¹",
  "ã‚ãªãŸã®ãƒªãƒ©ãƒƒã‚¯ã‚¹æ–¹æ³•",
  "ä»Šå¹´ã‚„ã‚ŠãŸã„ã“ã¨",
  "5å¹´å¾Œã“ã†ãªã£ã¦ã„ãŸã„ï¼ˆç†æƒ³ï¼‰",
  "è‡ªåˆ†ã‚’ä¸€è¨€ã§è¡¨ã™ã¨ï¼Ÿï¼ˆç†ç”±ã‚‚ï¼‰",
  "è‡ªå·±ç´¹ä»‹ï¼ˆåå‰/ä»•äº‹/æœ€è¿‘ã®ãƒ†ãƒ¼ãƒï¼‰"
];

let currentTopic = "";
function pickTopic(){
  return topics[Math.floor(Math.random()*topics.length)];
}

function changeTopic(){
  // ã‚¹ãƒ”ãƒ¼ãƒä¸­ã§ãªãã¦ã‚‚ã€Œæ¬¡ã®è©±é¡Œã€ã‚’æ›´æ–°ã—ã¦è¡¨ç¤ºã ã‘ã§ãã‚‹
  currentTopic = pickTopic();
  if(!speechRunning){
    setSub(`ï¼ˆè©±é¡Œï¼‰${currentTopic}\nâ€»ã‚¹ãƒ”ãƒ¼ãƒé–‹å§‹æ™‚ã«ã“ã®è©±é¡Œã§è¡Œãã¾ã™`);
  }else{
    setSub(`ï¼ˆå¤‰æ›´ï¼‰${currentTopic}\nã“ã®è©±é¡Œã§ç¶šã‘ã¦OKï¼`);
  }
}

function stopSpeech(){
  speechToken++;
  speechRunning = false;
  setPhase("ğŸ¤ ã‚¹ãƒ”ãƒ¼ãƒåœæ­¢");
  setDisplay("â¹");
  setSub("æ­¢ã‚ã¾ã—ãŸã€‚å†é–‹ã™ã‚‹ãªã‚‰ã€Œé–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
  setState("åœæ­¢");
}

async function speech(token){
  await wait(5000); // â˜… 5ç§’ç©ºã‘ã‚‹
  if(isStopped(token)) return;

  setPhase("ğŸ¤ 30ç§’ã‚¹ãƒ”ãƒ¼ãƒ");
  setState("ã‚¹ãƒ”ãƒ¼ãƒä¸­");
  speechRunning = true;

  // è©±é¡ŒãŒæœªè¨­å®šãªã‚‰æ±ºã‚ã‚‹
  if(!currentTopic) currentTopic = pickTopic();

  setSub(`ãŠé¡Œï¼š${currentTopic}\nï¼ˆæ­¢ã‚ãŸã„æ™‚ã¯ã€Œåœæ­¢ã€ / è©±é¡Œã‚’å¤‰ãˆãŸã„æ™‚ã¯ã€Œè©±é¡Œå¤‰æ›´ã€ï¼‰`);
  setDisplay("30");

  // ã‚¹ãƒ”ãƒ¼ãƒå°‚ç”¨ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆé€”ä¸­åœæ­¢å¯¾å¿œï¼‰
  const mySpeechToken = ++speechToken;

  for(let i=30;i>=0;i--){
    if(isStopped(token)) return;
    if(mySpeechToken !== speechToken){ return; } // stopSpeechã•ã‚ŒãŸ
    setDisplay(i);
    await wait(1000);
  }

  speechRunning = false;
  setState("é€²è¡Œä¸­");
}

/* =========================
   å…¨ä½“ã‚¹ã‚¿ãƒ¼ãƒˆ
========================= */
async function startAll(){
  // æ–°ã—ã„å®Ÿè¡Œã‚’é–‹å§‹
  runToken++;
  const token = runToken;

  setState("é€²è¡Œä¸­");
  speechRunning = false;

  // é–‹å§‹æ™‚ã«è©±é¡Œã‚’ç”¨æ„ï¼ˆæ¯å›æ–°ã—ãã—ã¦ã‚‚OKï¼‰
  currentTopic = pickTopic();

  try{
    await breathing(token);
    if(isStopped(token)) return;

    await wait(2000);
    await tongue(token);
    if(isStopped(token)) return;

    // ã“ã“ã‹ã‚‰ã¯æŒ‡å®šã®ã€Œé–“ã€ã‚’é–¢æ•°å†…ã«å«ã‚ã¦ã¾ã™
    await gyou(token);
    if(isStopped(token)) return;

    await hard10(token);
    if(isStopped(token)) return;

    await speech(token);
    if(isStopped(token)) return;

    setPhase("âœ¨ ãŠç–²ã‚Œæ§˜ã§ã—ãŸ");
    setDisplay("ğŸ˜Š");
    setSub("ã“ã®èª¿å­ã§ç„¦ã‚‰ãšç¶šã‘ã¦ã„ãã¾ã—ã‚‡ã†â™ª");
    setState("å®Œäº†");
  }catch(e){
    // ä½•ã‹ã‚ã£ã¦ã‚‚æ­¢ã¾ã‚‰ãªã„ã‚ˆã†ã«
    setPhase("âš ï¸ ã‚¨ãƒ©ãƒ¼");
    setDisplay("â€¦");
    setSub("ä¸€åº¦ã€Œåœæ­¢ã€â†’ã€Œé–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„");
    setState("åœæ­¢");
  }
}

/* åˆæœŸè¡¨ç¤ºï¼šè©±é¡Œã‚’æº–å‚™ã ã‘ã—ã¦ãŠã */
currentTopic = pickTopic();
</script>

</body>
</html>