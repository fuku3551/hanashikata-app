<!doctype html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”° ä»Šæ—¥ã®ãŠã™ã™ã‚ç·´ç¿’</title>
<link rel="stylesheet" href="style.css">

<style>
  .big{
    font-size:40px;font-weight:900;text-align:center;margin:10px 0;line-height:1.35;
    word-break:break-word;color:#111;
  }
  .mid{font-size:24px;font-weight:900;text-align:center;margin:6px 0;}
  .small{text-align:center;opacity:.88;font-size:18px;line-height:1.8;white-space:pre-wrap;}

  .blinkArrow{display:inline-block;font-size:26px;animation: blink 1s steps(2,start) infinite;margin-bottom:6px;}
  @keyframes blink{50%{opacity:0;}}

  .marqueeBox{
    width:100%;overflow:hidden;border-radius:12px;border:1px solid rgba(0,0,0,.12);
    background:rgba(255,255,255,.85);padding:8px 10px;box-sizing:border-box;
  }
  .marquee{
    display:inline-block;white-space:nowrap;will-change:transform;animation: marqueeMove 9s linear infinite;
    font-weight:900;font-size:18px;
  }
  @keyframes marqueeMove{0%{transform:translateX(100%);}100%{transform:translateX(-100%);}}
  .marquee.paused{animation-play-state:paused;}

  ruby{ruby-position:over;}
  rt{font-size:11px;opacity:.92;}
  .rtMini rt{font-size:10px;opacity:.9;}

  .center{text-align:center;}
  .controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:12px;}

  .btn{
    padding:14px 16px;border-radius:14px;border:1px solid rgba(0,0,0,.10);
    font-weight:900;font-size:16px;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.06);
    transition:transform .12s ease,box-shadow .12s ease,opacity .12s ease;min-width:150px;
    -webkit-tap-highlight-color: rgba(0,0,0,0);
  }
  .btn:active{transform:scale(.98);box-shadow:0 4px 10px rgba(0,0,0,.06);}
  .primary{background:#0ea5e9;color:#fff;border:none;}
  .danger{background:#ef4444;color:#fff;border:none;}
  .ghost{background:#fff;}
  .warn{background:#111;color:#fff;border:none;}
  .disabled{opacity:.45;pointer-events:none;}

  .pill{
    display:inline-block;padding:8px 14px;border-radius:999px;border:1px solid rgba(0,0,0,.12);
    background:rgba(255,255,255,.75);font-size:14px;font-weight:900;
  }

  .blinkRight{display:inline-block;margin-left:8px;font-size:20px;animation: blink 1s steps(2,start) infinite;}

  .hardText{font-size:32px;font-weight:900;line-height:1.35;}

  .countDown{font-size:56px;font-weight:1000;letter-spacing:.02em;line-height:1.1;}
  .countLabel{font-size:20px;opacity:.9;margin-top:6px;}

  /* æ»‘èˆŒï¼šç‚¹ç¯ã‚¹ã‚¿ã‚¤ãƒ« */
  .gyouWrap{
    display:inline-block;
    padding:10px 18px;
    border-radius:16px;
    background:rgba(14,165,233,.10);
    border:1px solid rgba(14,165,233,.20);
  }
  .gyouActive{
    background:rgba(239,68,68,.14);
    border-color:rgba(239,68,68,.35);
  }
</style>
</head>

<body>

<header class="top">
  <h1>ğŸ”° ä»Šæ—¥ã®ãŠã™ã™ã‚ç·´ç¿’</h1>
  <p><a href="index.html">â† ãƒ›ãƒ¼ãƒ ã¸</a></p>
</header>

<main class="menu">

  <div class="card">
    <div class="title">ä¸€æœ¬é“ãƒ«ãƒ¼ãƒˆï¼ˆç´„4ã€œ6åˆ†ï¼‰</div>
    <div class="desc small">
å‘¼å¸ â†’ èˆŒãƒˆãƒ¬ â†’ æ»‘èˆŒï¼ˆã‚ã€œã‚è¡Œï¼‰â†’ è¨€ã„ã«ãã„15é¸ â†’ 40ç§’ã‚¹ãƒ”ãƒ¼ãƒ
    </div>

    <div class="marqueeBox" style="margin-top:10px;">
      <span id="topMarquee" class="marquee">
        ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ãŸã‚‰è…¹å¼å‘¼å¸ã‹ã‚‰å§‹ã¾ã‚Šã¾ã™ã€€ï¼ã€€ã‚¹ãƒãƒ›ã¯æ¨ªå‘ãæ¨å¥¨ã€€ï¼ã€€é€”ä¸­ã§æ­¢ã‚ãŸã„æ™‚ã¯ã€Œåœæ­¢ã€ã€€ï¼ã€€ã€Œä¸€æ™‚åœæ­¢ã€ã‚‚ä½¿ãˆã¾ã™
      </span>
    </div>

    <div class="center" style="margin-top:12px;">
      <div id="startHint" class="blinkArrow">â¬‡ï¸â¬‡ï¸â¬‡ï¸</div>

      <div class="controls">
        <button id="startBtn" class="btn primary" type="button" style="min-width:220px;">â–¶ é–‹å§‹</button>
        <button id="pauseBtn" class="btn ghost disabled" type="button" disabled>â¸ ä¸€æ™‚åœæ­¢</button>
        <button id="stopBtn" class="btn danger disabled" type="button" disabled>â¹ åœæ­¢</button>
        <button id="skipBtn" class="btn warn disabled" type="button" disabled>â­ ã‚¹ã‚­ãƒƒãƒ—</button>
        <button class="btn ghost" type="button" onclick="changeTopic()">ğŸ² è©±é¡Œå¤‰æ›´</button>
      </div>
    </div>

    <div class="center" style="margin-top:10px;">
      <span class="pill" id="statePill">å¾…æ©Ÿä¸­</span>
    </div>
  </div>

  <div class="card">
    <div id="phase" class="mid">æº–å‚™OK</div>
    <div id="display" class="big">00</div>
    <div id="sub" class="small">ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
  </div>

</main>

<script>
/* =========================
   å…¨ä½“åˆ¶å¾¡
========================= */
let runToken = 0;
let speechRunning = false;

/* ä¸€æ™‚åœæ­¢ */
let paused = false;
let pauseResolvers = [];
function waitWhilePaused(){
  if(!paused) return Promise.resolve();
  return new Promise(res => pauseResolvers.push(res));
}
function resumePausedWaiters(){
  pauseResolvers.splice(0).forEach(r=>r());
}

/* ã‚¹ã‚­ãƒƒãƒ— */
let skipRequested = false;

/* UI */
function setPhase(t){ document.getElementById("phase").textContent=t; }
function setDisplay(html){ document.getElementById("display").innerHTML=html; }
function setSub(t){ document.getElementById("sub").textContent=t; }
function setState(t){ document.getElementById("statePill").textContent=t; }
function isStopped(token){ return token !== runToken; }

/* ä¸Šæ®µãƒãƒ«ã‚­ãƒ¼ */
const topMarquee = document.getElementById("topMarquee");
const DEFAULT_TOP = topMarquee.textContent;

function setTopMarquee(text){
  topMarquee.textContent = text;
  // iOSã§å·®ã—æ›¿ãˆç¢ºå®ŸåŒ–ï¼ˆã‚¢ãƒ‹ãƒ¡å†ã‚¹ã‚¿ãƒ¼ãƒˆï¼‰
  topMarquee.style.animation = "none";
  void topMarquee.offsetWidth;
  topMarquee.style.animation = "";
}
function pauseTopMarquee(){ topMarquee.classList.add("paused"); }
function resumeTopMarquee(){ topMarquee.classList.remove("paused"); }

/* ãƒœã‚¿ãƒ³æœ‰åŠ¹/ç„¡åŠ¹ï¼ˆå±æ€§ã‚‚ï¼‰ */
function setBtnEnabled(btn, enabled){
  btn.classList.toggle("disabled", !enabled);
  btn.disabled = !enabled;
}
function enableDuringRun(on){
  setBtnEnabled(document.getElementById("pauseBtn"), on);
  setBtnEnabled(document.getElementById("stopBtn"),  on);
  setBtnEnabled(document.getElementById("skipBtn"),  on);
}

/* â€œæ­¢ã¾ã‚Œã‚‹å¾…ã¡â€ */
async function wait(ms, token){
  const step = 70;
  let left = ms;
  while(left > 0){
    if(isStopped(token)) return false;
    if(skipRequested) return false;
    await waitWhilePaused();
    const chunk = Math.min(step, left);
    await new Promise(res=>setTimeout(res, chunk));
    left -= chunk;
  }
  return true;
}

/* ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹å‰ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ */
async function announceNext(token, text, ms=1200){
  skipRequested = false;
  setTopMarquee(text);
  if(paused) pauseTopMarquee(); else resumeTopMarquee();
  return await wait(ms, token);
}

/* åœæ­¢ */
function stopAll(){
  runToken++;
  speechRunning = false;

  paused = false;
  resumePausedWaiters();
  pauseTopMarquee(); // ã„ã£ãŸã‚“æ­¢ã‚ã¦ã‹ã‚‰æˆ»ã™
  setTopMarquee(DEFAULT_TOP);
  resumeTopMarquee();

  skipRequested = false;
  enableDuringRun(false);

  document.getElementById("startHint").style.display = "inline-block";

  setState("åœæ­¢");
  setPhase("â¹ åœæ­¢ã—ã¾ã—ãŸ");
  setDisplay("00");
  setSub("å†é–‹ã™ã‚‹å ´åˆã¯ã€Œé–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„");
}

/* ä¸€æ™‚åœæ­¢ */
function togglePause(){
  const btn = document.getElementById("pauseBtn");
  if(btn.disabled) return;

  paused = !paused;

  btn.textContent = paused ? "â–¶ å†é–‹" : "â¸ ä¸€æ™‚åœæ­¢";
  setState(paused ? "ä¸€æ™‚åœæ­¢ä¸­" : "é€²è¡Œä¸­");

  // ä¸€æ™‚åœæ­¢ä¸­ã¯ãƒãƒ«ã‚­ãƒ¼ã‚‚æ­¢ã‚ã‚‹ï¼ˆåˆå¿ƒè€…ãŒæ··ä¹±ã—ãªã„ï¼‰
  if(paused) pauseTopMarquee();
  else {
    resumeTopMarquee();
    resumePausedWaiters();
  }
}

/* ã‚¹ã‚­ãƒƒãƒ— */
function skipPhase(){
  const btn = document.getElementById("skipBtn");
  if(btn.disabled) return;

  skipRequested = true;
  setSub("â­ æ¬¡ã¸ç§»å‹•ä¸­â€¦");
}

/* =========================
   å‘¼å¸ 4-4-8 Ã—3ï¼ˆ4,3,2,1ï¼‰
========================= */
async function breathing(token){
  if(!await announceNext(token, "æ¬¡ã¯è…¹å¼å‘¼å¸ã§ã™ï¼šå¸ã£ã¦4ç§’ â†’ æ­¢ã‚ã¦4ç§’ â†’ åã„ã¦8ç§’ã€€ï¼ã€€ã‚†ã£ãã‚Šã§OK")) return;

  setPhase("ğŸ’¨ è…¹å¼å‘¼å¸");

  for(let round=1; round<=3; round++){
    if(isStopped(token) || skipRequested) return;
    setSub(`ãƒ©ã‚¦ãƒ³ãƒ‰ ${round}/3`);

    for(let n=4; n>=1; n--){
      if(isStopped(token) || skipRequested) return;
      setDisplay(`<div>ã¯ã„å¸ã£ã¦ã‚¹ã‚¥ã€œ</div><div class="countDown">${n}</div><div class="countLabel">ç§’</div>`);
      if(!await wait(1000, token)) return;
    }

    for(let n=4; n>=1; n--){
      if(isStopped(token) || skipRequested) return;
      setDisplay(`<div>ã¯ã„æ­¢ã‚ã¦</div><div class="countDown">${n}</div><div class="countLabel">ç§’</div>`);
      if(!await wait(1000, token)) return;
    }

    for(let n=8; n>=1; n--){
      if(isStopped(token) || skipRequested) return;
      setDisplay(`<div>ã¯ã„åã„ã¦ãƒ•ã‚¥ã€œ</div><div class="countDown">${n}</div><div class="countLabel">ç§’</div>`);
      if(!await wait(1000, token)) return;
    }
  }
  setDisplay(" ");
  setSub("å‘¼å¸OKï¼æ¬¡ã¸é€²ã¿ã¾ã™ã€‚");
}

/* =========================
   èˆŒãƒˆãƒ¬ï¼ˆå°å…¥ï¼‹3ç§’ï¼‰
========================= */
async function tongue(token){
  if(!await announceNext(token, "æ¬¡ã¯èˆŒãƒˆãƒ¬ã§ã™ã€‚èˆŒå…ˆã§å£ã®ä¸­ã«å¤§ããªå††ã‚’æã„ã¦è¡Œãã¾ã—ã‚‡ã†ã€‚å³ã‹ã‚‰3ç§’å¾Œã«ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚", 1600)) return;

  setPhase("ğŸ‘… èˆŒãƒˆãƒ¬");
  setSub("æº–å‚™ã—ã¦ãã ã•ã„");

  for(let c=3;c>=1;c--){
    if(isStopped(token) || skipRequested) return;
    setDisplay(`<div class="countDown">${c}</div>`);
    if(!await wait(1000, token)) return;
  }

  setSub("å³å›ã‚Š 7å›ï¼ˆ1å›ï¼3ç§’ï¼‰");
  setDisplay(" ");
  if(!await wait(700, token)) return;

  for(let i=1;i<=7;i++){
    if(isStopped(token) || skipRequested) return;
    setDisplay(i);
    if(!await wait(3000, token)) return;
  }

  setSub("å·¦å›ã‚Š 7å›ï¼ˆ1å›ï¼3ç§’ï¼‰");
  setDisplay(" ");
  if(!await wait(700, token)) return;

  for(let i=1;i<=7;i++){
    if(isStopped(token) || skipRequested) return;
    setDisplay(i);
    if(!await wait(3000, token)) return;
  }

  setSub("OKï¼èˆŒãŒå‹•ãã‚„ã™ããªã‚Šã¾ã—ãŸã€‚");
  setDisplay(" ");
}

/* =========================
   æ»‘èˆŒï¼ˆ2ç§’ã”ã¨ / ç‚¹ç¯ã‚ã‚Šï¼‰
========================= */
async function gyou(token){
  if(!await announceNext(token, "æ¬¡ã¯æ»‘èˆŒï¼ˆã‚ã€œã‚è¡Œï¼‰ã§ã™ã€‚1èªãšã¤ä¸å¯§ã«ç™ºå£°ã—ã¾ã—ã‚‡ã†ï¼ˆ2ç§’/1èªï¼‰")) return;

  setPhase("ğŸ‘„ æ»‘èˆŒï¼ˆã‚ã€œã‚è¡Œï¼‰");
  setSub("1èªãšã¤ä¸å¯§ã«ï¼ˆ2ç§’ï¼‰");

  const lines=[
    "ã‚ã„ã†ãˆãŠ","ã‹ããã‘ã“","ã•ã—ã™ã›ã","ãŸã¡ã¤ã¦ã¨","ãªã«ã¬ã­ã®",
    "ã¯ã²ãµã¸ã»","ã¾ã¿ã‚€ã‚ã‚‚","ã‚„ã‚†ã‚ˆ","ã‚‰ã‚Šã‚‹ã‚Œã‚","ã‚ã‚’ã‚“"
  ];

  for(const l of lines){
    if(isStopped(token) || skipRequested) return;

    // æœ€åˆã®0.35ç§’ã ã‘ç‚¹ç¯ï¼ˆè¦–èªæ€§UPï¼‰
    setDisplay(`<div class="gyouWrap gyouActive">${l}</div>`);
    if(!await wait(350, token)) return;

    // æ®‹ã‚Šã‚’é€šå¸¸è¡¨ç¤º
    setDisplay(`<div class="gyouWrap">${l}</div>`);
    if(!await wait(1650, token)) return;
  }

  setDisplay(" ");
}

/* =========================
   è¨€ã„ã«ãã„15é¸ï¼ˆãƒ•ãƒªã‚¬ãƒŠ / è‰²ä»˜ã‘ç„¡ã—ï¼‰
========================= */
async function hard15(token){
  if(!await announceNext(token, "æ¬¡ã¯è¨€ã„ã«ãã„ãƒ•ãƒ¬ãƒ¼ã‚º15é¸ã§ã™ã€‚ç„¦ã‚‰ãšã€ãƒãƒƒã‚­ãƒªã€ã‚†ã£ãã‚Šã€‚æ¬¡ã®è¨€è‘‰ã«åˆ‡ã‚Šæ›¿ã‚ã‚‹ã¾ã§3ç§’å¾…ã¡ã¾ã™ã€‚", 1500)) return;

  setPhase("ğŸ“¢ è¨€ã„ã«ãã„ãƒ•ãƒ¬ãƒ¼ã‚º15é¸");
  setSub("ã¯ã£ãã‚Šç™ºå£°ï¼ˆã‚†ã£ãã‚Šï¼‰");

  const list=[
    `<span class="rtMini"><ruby>æ±äº¬<rt>ã¨ã†ãã‚‡ã†</rt></ruby><ruby>ç‰¹è¨±<rt>ã¨ã£ãã‚‡</rt></ruby><ruby>è¨±å¯å±€<rt>ãã‚‡ã‹ãã‚‡ã</rt></ruby></span>`,
    `<span class="rtMini"><ruby>ç”Ÿéº¦<rt>ãªã¾ã‚€ã</rt></ruby> <ruby>ç”Ÿç±³<rt>ãªã¾ã”ã‚</rt></ruby> <ruby>ç”Ÿåµ<rt>ãªã¾ãŸã¾ã”</rt></ruby></span>`,
    `<span class="rtMini"><ruby>èµ¤å·»ç´™<rt>ã‚ã‹ã¾ããŒã¿</rt></ruby> <ruby>é’å·»ç´™<rt>ã‚ãŠã¾ããŒã¿</rt></ruby> <ruby>é»„å·»ç´™<rt>ãã¾ããŒã¿</rt></ruby></span>`,
    `<span class="rtMini"><ruby>éš£<rt>ã¨ãªã‚Š</rt></ruby>ã®<ruby>å®¢<rt>ãã‚ƒã</rt></ruby>ã¯ã‚ˆã<ruby>æŸ¿<rt>ã‹ã</rt></ruby><ruby>é£Ÿ<rt>ã</rt></ruby>ã†<ruby>å®¢<rt>ãã‚ƒã</rt></ruby>ã </span>`,
    `<span class="rtMini"><ruby>æ‰“è€…<rt>ã ã—ã‚ƒ</rt></ruby><ruby>èµ°è€…<rt>ãã†ã—ã‚ƒ</rt></ruby><ruby>å‹è€…<rt>ã—ã‚‡ã†ã—ã‚ƒ</rt></ruby></span>`,
    `<span class="rtMini"><ruby>é­”è¡“å¸«<rt>ã¾ã˜ã‚…ã¤ã—</rt></ruby><ruby>æ‰‹è¡“ä¸­<rt>ã—ã‚…ã˜ã‚…ã¤ã¡ã‚…ã†</rt></ruby></span>`,
    `<span class="rtMini"><ruby>æ—…å®¢æ©Ÿ<rt>ã‚Šã‚‡ã‹ã£ã</rt></ruby> <ruby>æ—…å®¢èˆ¹<rt>ã‚Šã‚‡ã‹ãã›ã‚“</rt></ruby> <ruby>æ—…é¤¨<rt>ã‚Šã‚‡ã‹ã‚“</rt></ruby></span>`,
    `<span class="rtMini"><ruby>å–æ¨é¸æŠ<rt>ã—ã‚…ã—ã‚ƒã›ã‚“ãŸã</rt></ruby> <ruby>è©¦å†™å®¤<rt>ã—ã—ã‚ƒã—ã¤</rt></ruby> <ruby>æ”¯ç¤¾è¦–å¯Ÿ<rt>ã—ã—ã‚ƒã—ã•ã¤</rt></ruby></span>`,
    `<span class="rtMini"><ruby>æœ€çµ‚æ‰‹æ®µ<rt>ã•ã„ã—ã‚…ã†ã—ã‚…ã ã‚“</rt></ruby> <ruby>åé›†<rt>ã—ã‚…ã†ã—ã‚…ã†</rt></ruby> <ruby>é›†ä¸­<rt>ã—ã‚…ã†ã¡ã‚…ã†</rt></ruby></span>`,
    `<span class="rtMini"><ruby>ç‰¹æ€¥åˆ—è»Š<rt>ã¨ã£ãã‚…ã†ã‚Œã£ã—ã‚ƒ</rt></ruby> <ruby>æ™®é€šåˆ—è»Š<rt>ãµã¤ã†ã‚Œã£ã—ã‚ƒ</rt></ruby></span>`,
    `<span class="rtMini"><ruby>æ–°æ˜¥<rt>ã—ã‚“ã—ã‚…ã‚“</rt></ruby> <ruby>å”±æ­Œ<rt>ã—ã‚‡ã†ã‹</rt></ruby> <ruby>å¥¨å­¦é‡‘<rt>ã—ã‚‡ã†ãŒããã‚“</rt></ruby></span>`,
    `<span class="rtMini"><ruby>è²¨å®¢èˆ¹<rt>ã‹ãã‚ƒãã›ã‚“</rt></ruby>ã¨<ruby>æ—…å®¢èˆ¹<rt>ã‚Šã‚‡ã‹ãã›ã‚“</rt></ruby></span>`,
    `<span class="rtMini"><ruby>éš£ç”º<rt>ã¨ãªã‚Šã¾ã¡</rt></ruby>ã®<ruby>å®¢<rt>ãã‚ƒã</rt></ruby>ãŒ<ruby>æŸ¿<rt>ã‹ã</rt></ruby>ã‚’<ruby>è²·<rt>ã‹</rt></ruby>ã†</span>`,
    `<span class="rtMini"><ruby>æ—©å£è¨€è‘‰<rt>ã¯ã‚„ãã¡ã“ã¨ã°</rt></ruby>ã¯<ruby>ç„¦<rt>ã‚ã›</rt></ruby>ã‚‰ãš<ruby>æ­£ç¢º<rt>ã›ã„ã‹ã</rt></ruby>ã«</span>`,
    `<span class="rtMini"><ruby>ç™ºå£°<rt>ã¯ã£ã›ã„</rt></ruby>ã¨<ruby>æ»‘èˆŒ<rt>ã‹ã¤ãœã¤</rt></ruby>ã¯<ruby>æ¯æ—¥<rt>ã¾ã„ã«ã¡</rt></ruby>ã®<ruby>ç©<rt>ã¤</rt></ruby>ã¿<ruby>é‡<rt>ã‹ã•</rt></ruby>ã­</span>`
  ];

  for(const item of list){
    if(isStopped(token) || skipRequested) return;

    setDisplay(`<div class="hardText">${item}</div>`);
    if(!await wait(4500, token)) return;

    if(!await wait(3000, token)) return;
  }

  setDisplay(" ");
}

/* =========================
   40ç§’ã‚¹ãƒ”ãƒ¼ãƒï¼ˆ5ç§’å‰ã‹ã‚‰ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºï¼‰
========================= */
const topics=[
  "ã‚ãªãŸã®å¥½ããªé£Ÿã¹ç‰©ï¼ˆç†ç”±ã‚‚æ·»ãˆã¦ï¼‰","ã‚ãªãŸã®è‹¦æ‰‹ãªé£Ÿã¹ç‰©ï¼ˆã©ã†å·¥å¤«ã—ã¦ã‚‹ï¼Ÿï¼‰","ã‚ãªãŸã®å‡ºèº«åœ°ï¼ˆãŠã™ã™ã‚ãƒã‚¤ãƒ³ãƒˆï¼‰",
  "å­ã©ã‚‚ã®é ƒã‚ˆãéŠã‚“ã ã“ã¨","æ˜”ã‚„ã£ã¦ã„ãŸã‚¹ãƒãƒ¼ãƒ„ï¼ˆæ€ã„å‡ºï¼‰","ä»Šä½ã‚“ã§ã„ã‚‹å ´æ‰€ï¼ˆå¥½ããªæ‰€ï¼‰","ã‚ãªãŸã®ä»•äº‹ï¼ˆä¸€è¨€ã§è¨€ã†ã¨ï¼‰",
  "ã“ã‚Œã‹ã‚‰æŒ‘æˆ¦ã—ãŸã„ä»•äº‹ãƒ»æ´»å‹•","æœ€è¿‘ã†ã‚Œã—ã‹ã£ãŸã“ã¨","æœ€è¿‘å­¦ã‚“ã ã“ã¨","æœ€è¿‘ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã“ã¨","ã‚ãªãŸã®å¼·ã¿ï¼ˆã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ä»˜ãï¼‰",
  "ã‚ãªãŸã®å¼±ã¿ï¼ˆæ”¹å–„ã®å·¥å¤«ï¼‰","å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ä¾¡å€¤è¦³","äººã«è¤’ã‚ã‚‰ã‚Œã¦å¬‰ã—ã‹ã£ãŸã“ã¨","æœ€è¿‘ãƒãƒã£ã¦ã„ã‚‹ã“ã¨",
  "æœ€è¿‘è¦‹ãŸ/èª­ã‚“ã ã‚‚ã®ã§å°è±¡ã«æ®‹ã£ãŸã‚‚ã®","å°Šæ•¬ã™ã‚‹äººï¼ˆç†ç”±ï¼‰","æ„Ÿè¬ã—ã¦ã„ã‚‹äººï¼ˆç†ç”±ï¼‰","ã„ã¾é ‘å¼µã£ã¦ã„ã‚‹ã“ã¨"
];
let currentTopic = "";
function pickTopic(){ return topics[Math.floor(Math.random()*topics.length)]; }

function changeTopic(){
  currentTopic = pickTopic();
  if(!speechRunning){
    setSub(`ï¼ˆè©±é¡Œï¼‰${currentTopic}\nâ€»ã‚¹ãƒ”ãƒ¼ãƒé–‹å§‹æ™‚ã«ã“ã®è©±é¡Œã§è¡Œãã¾ã™`);
  }else{
    setSub(`ï¼ˆå¤‰æ›´ï¼‰${currentTopic}\nã“ã®è©±é¡Œã§ç¶šã‘ã¦OKï¼`);
  }
}

async function speech40(token){
  if(!await announceNext(token, "æ¬¡ã¯40ç§’ã‚¹ãƒ”ãƒ¼ãƒã§ã™ã€‚10ç§’æº–å‚™ã—ã¦ã‹ã‚‰é–‹å§‹ã—ã¾ã™ã€‚çµè«–â†’ç†ç”±â†’å…·ä½“ä¾‹â†’çµè«– ã‚’æ„è­˜ï¼", 1500)) return;

  setPhase("ğŸ¤ 40ç§’ã‚¹ãƒ”ãƒ¼ãƒï¼ˆæº–å‚™ï¼‰");
  setState("ã‚¹ãƒ”ãƒ¼ãƒæº–å‚™");
  speechRunning = true;

  if(!currentTopic) currentTopic = pickTopic();

  setDisplay(`ãŠé¡Œï¼š${currentTopic}<span class="blinkRight">â¡ï¸</span>`);
  setSub("æ­¢ã‚ãŸã„æ™‚ã¯ã€Œåœæ­¢ã€ / è©±é¡Œã‚’å¤‰ãˆãŸã„æ™‚ã¯ã€Œè©±é¡Œå¤‰æ›´ã€");

  // 10ç§’æº–å‚™ï¼ˆæ®‹ã‚Š5ç§’ã‹ã‚‰ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºï¼‰
  for(let sec=10; sec>=1; sec--){
    if(isStopped(token) || skipRequested) return;

    if(sec <= 5){
      setPhase(`ğŸ¤ 40ç§’ã‚¹ãƒ”ãƒ¼ãƒï¼ˆé–‹å§‹ã¾ã§ï¼‰`);
      setDisplay(`<div style="font-size:18px;opacity:.85;">é–‹å§‹ã¾ã§</div><div class="countDown">${sec}</div>`);
    }else{
      setPhase(`ğŸ¤ 40ç§’ã‚¹ãƒ”ãƒ¼ãƒï¼ˆé–‹å§‹ã¾ã§ ${sec}ç§’ï¼‰`);
      // ãŠé¡Œã¯ç¶­æŒã—ãŸã„ã®ã§è¡¨ç¤ºã¯å¤‰ãˆãªã„
      setDisplay(`ãŠé¡Œï¼š${currentTopic}<span class="blinkRight">â¡ï¸</span>`);
    }

    if(!await wait(1000, token)) return;
  }

  setPhase("ğŸ¤ 40ç§’ã‚¹ãƒ”ãƒ¼ãƒï¼ˆé–‹å§‹ï¼‰");
  setState("ã‚¹ãƒ”ãƒ¼ãƒä¸­");

  for(let i=40;i>=0;i--){
    if(isStopped(token) || skipRequested) return;
    setDisplay(i);
    if(!await wait(1000, token)) return;
  }

  speechRunning = false;
  setState("é€²è¡Œä¸­");
}

/* =========================
   å…¨ä½“ã‚¹ã‚¿ãƒ¼ãƒˆ
========================= */
async function startAll(){
  runToken++;
  const token = runToken;

  paused = false;
  resumePausedWaiters();
  skipRequested = false;

  document.getElementById("pauseBtn").textContent = "â¸ ä¸€æ™‚åœæ­¢";
  document.getElementById("startHint").style.display = "none";

  setState("é€²è¡Œä¸­");
  speechRunning = false;
  currentTopic = pickTopic();

  enableDuringRun(true);
  resumeTopMarquee();

  try{
    setPhase("æº–å‚™â€¦");
    setDisplay(" ");
    setSub("ã“ã‚Œã‹ã‚‰å§‹ã¾ã‚Šã¾ã™");
    if(!await wait(700, token)) return;

    await breathing(token);
    if(isStopped(token)) return;

    if(!await wait(500, token)) return;
    skipRequested = false;
    await tongue(token);
    if(isStopped(token)) return;

    if(!await wait(500, token)) return;
    skipRequested = false;
    await gyou(token);
    if(isStopped(token)) return;

    if(!await wait(500, token)) return;
    skipRequested = false;
    await hard15(token);
    if(isStopped(token)) return;

    if(!await wait(500, token)) return;
    skipRequested = false;
    await speech40(token);
    if(isStopped(token)) return;

    setPhase("âœ¨ ãŠç–²ã‚Œæ§˜ã§ã—ãŸ");
    setDisplay("ğŸ˜Š");
    setSub("ã“ã®èª¿å­ã§ç„¦ã‚‰ãšç¶šã‘ã¦ã„ãã¾ã—ã‚‡ã†â™ª");
    setState("å®Œäº†");

  }catch(e){
    setPhase("âš ï¸ ã‚¨ãƒ©ãƒ¼");
    setDisplay("â€¦");
    setSub("ä¸€åº¦ã€Œåœæ­¢ã€â†’ã€Œé–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„");
    setState("åœæ­¢");
  }finally{
    enableDuringRun(false);
    setTopMarquee(DEFAULT_TOP);
    resumeTopMarquee();
    document.getElementById("startHint").style.display = "inline-block";
    paused = false;
    resumePausedWaiters();
    skipRequested = false;
    speechRunning = false;
    document.getElementById("pauseBtn").textContent = "â¸ ä¸€æ™‚åœæ­¢";
  }
}

/* =========================
   âœ… iPhoneå¯¾ç­–ï¼šãƒœã‚¿ãƒ³ã‚’ç¢ºå®Ÿã«åå¿œã•ã›ã‚‹
========================= */
(function bindControlButtons(){
  const startBtn = document.getElementById("startBtn");
  const pauseBtn = document.getElementById("pauseBtn");
  const stopBtn  = document.getElementById("stopBtn");
  const skipBtn  = document.getElementById("skipBtn");

  function tap(fn){
    return function(e){
      e.preventDefault();
      e.stopPropagation();
      fn();
      return false;
    };
  }

  // é–‹å§‹ï¼ˆclickã§OKã€touchã‚‚ä»˜ã‘ã‚‹ï¼‰
  startBtn.addEventListener("click", tap(startAll));
  startBtn.addEventListener("touchstart", tap(startAll), {passive:false});

  pauseBtn.addEventListener("click", tap(togglePause));
  pauseBtn.addEventListener("touchstart", tap(togglePause), {passive:false});

  stopBtn.addEventListener("click", tap(stopAll));
  stopBtn.addEventListener("touchstart", tap(stopAll), {passive:false});

  skipBtn.addEventListener("click", tap(skipPhase));
  skipBtn.addEventListener("touchstart", tap(skipPhase), {passive:false});
})();

/* åˆæœŸè¡¨ç¤º */
setTopMarquee(DEFAULT_TOP);
document.getElementById("pauseBtn").textContent = "â¸ ä¸€æ™‚åœæ­¢";
</script>

</body>
</html>