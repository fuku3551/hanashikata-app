<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è©±æ³•åˆ¥ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

<header class="top">
  <h1>ğŸ§  è©±æ³•åˆ¥ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h1>
  <p class="sub">AREA / PREP / ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ / äº¤æ¸‰è¡“</p>
  <p><a href="index.html">â† ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</a></p>
</header>

<main class="menu">

  <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
  <div class="card" style="display:block;">
    <div class="title">â‘  è©±æ³•ã‚’é¸ã¶</div>
    <div class="desc">
      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
        <button onclick="setMode('area')" id="btn-area">AREA</button>
        <button onclick="setMode('prep')" id="btn-prep">PREP</button>
        <button onclick="setMode('story')" id="btn-story">ã‚¹ãƒˆãƒ¼ãƒªãƒ¼</button>
        <button onclick="setMode('nego')" id="btn-nego">äº¤æ¸‰è¡“</button>
      </div>
      <p id="modeHint" style="margin-top:10px; line-height:1.7; opacity:0.9;">
        ã¾ãšè©±æ³•ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚
      </p>
    </div>
  </div>

  <!-- ãŠé¡Œ -->
  <div class="card" style="display:block;">
    <div class="title">â‘¡ ãŠé¡Œ</div>
    <div class="desc">
      <p id="topic" style="font-size:20px; font-weight:bold;">ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
      <p id="topicHint" style="margin-top:8px; line-height:1.7; opacity:0.85;"></p>
    </div>
  </div>

  <!-- ã‚¿ã‚¤ãƒãƒ¼ -->
  <div class="card" style="display:block;">
    <div class="title">â‘¢ ã‚¿ã‚¤ãƒãƒ¼</div>
    <div class="desc">
      <p id="timer" style="font-size:32px;">--</p>
      <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
        <button onclick="start()">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button onclick="stop()">â¹ ã‚¹ãƒˆãƒƒãƒ—</button>
        <button onclick="newTopic()">ğŸ² ãŠé¡Œã ã‘æ›´æ–°</button>
      </div>
      <p id="timeHint" style="margin-top:10px; opacity:0.85;"></p>
    </div>
  </div>

  <!-- éŒ²éŸ³ï¼‹è©•ä¾¡ -->
  <section class="card" style="display:block;">
    <div class="title">ğŸ™ éŒ²éŸ³ & AIè©•ä¾¡ï¼ˆ1ç”»é¢å®Œçµï¼‰</div>
    <div class="desc">

      <div style="border:1px solid #eee; border-radius:14px; padding:12px;">
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <button id="hxRecBtn" onclick="hxToggleRecording()"
            style="padding:12px 14px; border-radius:12px; border:none; background:#22c55e; color:#fff;">
            éŒ²éŸ³é–‹å§‹
          </button>

          <button onclick="hxResetRecording()"
            style="padding:12px 14px; border-radius:12px; border:none; background:#ef4444; color:#fff;">
            éŒ²éŸ³ãƒªã‚»ãƒƒãƒˆ
          </button>

          <span id="hxRecStatus" style="font-family: ui-monospace, SFMono-Regular, Menlo, monospace;">
            å¾…æ©Ÿä¸­
          </span>
        </div>

        <audio id="hxPlayer" controls style="display:none; width:100%; margin-top:10px;"></audio>

        <div style="margin-top:10px; font-size:14px; opacity:0.9; line-height:1.7;">
          âœ… éŒ²éŸ³â†’å†ç”Ÿã§ãã¾ã™ï¼ˆç«¯æœ«å†…ï¼‰<br>
          ğŸ’¡ éŒ²éŸ³ã‚’èããªãŒã‚‰ä¸‹ã®æ¬„ã«åŸç¨¿ãƒ¡ãƒ¢ â†’ ã€ŒAIè©•ä¾¡ã€ãŒãŠã™ã™ã‚
        </div>
      </div>

      <div style="margin-top:12px;">
        <div style="font-weight:700; margin-bottom:6px;">ğŸ“ ã‚¹ãƒ”ãƒ¼ãƒæœ¬æ–‡ï¼ˆè©•ä¾¡å¯¾è±¡ï¼‰</div>
        <textarea id="hxSpeechText"
          placeholder="ã“ã“ã«ã‚¹ãƒ”ãƒ¼ãƒã‚’æ›¸ã„ã¦ãã ã•ã„ï¼ˆéŒ²éŸ³ã‚’èããªãŒã‚‰ãƒ¡ãƒ¢ã§ã‚‚OKï¼‰"
          style="width:100%; min-height:180px; padding:12px; border-radius:12px; border:1px solid #ddd;"></textarea>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
          <button onclick="hxRunEvaluation()"
            style="padding:12px 14px; border-radius:12px; border:none; background:#0ea5e9; color:#fff;">
            AIè©•ä¾¡ã™ã‚‹
          </button>

          <button onclick="hxClearText()"
            style="padding:12px 14px; border-radius:12px; border:1px solid #ddd; background:#fff;">
            ã‚¯ãƒªã‚¢
          </button>

          <button onclick="hxInsertTemplate()"
            style="padding:12px 14px; border-radius:12px; border:1px solid #ddd; background:#fff;">
            ãƒ†ãƒ³ãƒ—ãƒ¬æŒ¿å…¥
          </button>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div id="hxBadges"></div>
        <div id="hxResult" style="white-space:pre-wrap; line-height:1.9; margin-top:10px;">
          ã“ã“ã«è©•ä¾¡çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
        </div>
      </div>

    </div>
  </section>

</main>

<script>
/* =========================
   è¨­å®šï¼šãƒ¢ãƒ¼ãƒ‰åˆ¥
========================= */
const MODES = {
  area: {
    name: "AREA",
    seconds: 80,
    hint: "å…±æ„Ÿâ†’ç†ç”±â†’å…·ä½“ä¾‹â†’ææ¡ˆï¼ˆç›¸æ‰‹ã‚’å¦å®šã›ãšå°ãï¼‰",
    topicHint: "ğŸ’¡ ã¾ãšå…±æ„Ÿã€ãã®å¾Œã«ç†ç”±â†’å…·ä½“ä¾‹â†’ææ¡ˆã§ã¾ã¨ã‚ã‚‹ã¨å¼·ã„ã§ã™ã€‚",
    topics: [
      "ä»•äº‹ã§ç›¸æ‰‹ãŒä¸å®‰ãã†ãªæ™‚ã€ã©ã†å£°ã‚’ã‹ã‘ã‚‹ï¼Ÿ",
      "æ–°äººãŒãƒŸã‚¹ã—ã¦è½ã¡è¾¼ã‚“ã§ã„ã‚‹æ™‚ã®ä¼ãˆæ–¹",
      "ç›¸æ‰‹ãŒæ€’ã£ã¦ã„ã‚‹æ™‚ã«è½ã¡ç€ã‹ã›ã‚‹ä¸€è¨€",
      "å¿™ã—ã„åŒåƒšã«å”åŠ›ã‚’ãŠé¡˜ã„ã™ã‚‹æ™‚ã®è¨€ã„æ–¹",
      "åˆ©ç”¨è€…ã•ã‚“ã«ãŠé¡˜ã„ã”ã¨ã‚’ã™ã‚‹æ™‚ã®è¨€ã„æ–¹",
      "å®¶æ—ã«å”åŠ›ã—ã¦ã»ã—ã„æ™‚ã®ä¼ãˆæ–¹",
      "ç›¸æ‰‹ã®ä¸æº€ã‚’å—ã‘æ­¢ã‚ã¤ã¤ææ¡ˆã™ã‚‹",
      "æ³¨æ„ã‚’ã—ãŸã„ãŒé–¢ä¿‚æ€§ã‚’å£Šã—ãŸããªã„",
      "æ–­ã‚ŠãŸã„ä¾é ¼ã‚’è§’ãŒç«‹ãŸãªã„ã‚ˆã†ã«æ–­ã‚‹",
      "ç›¸æ‰‹ãŒè¿·ã£ã¦ã„ã‚‹æ™‚ã«èƒŒä¸­ã‚’æŠ¼ã™"
    ],
    template:
`ï¼ˆAREAä¾‹ï¼‰
Aï¼šå¤§å¤‰ã§ã™ã‚ˆã­ã€‚ãŠæ°—æŒã¡ã‚ã‹ã‚Šã¾ã™ã€‚
Rï¼šå®Ÿã¯ã€‡ã€‡ã¨ã„ã†ç†ç”±ãŒã‚ã£ã¦â€¦
Eï¼šä¾‹ãˆã°â–¡â–¡ã®æ™‚ã«ã†ã¾ãã„ãã¾ã—ãŸã€‚
Aï¼šãªã®ã§ã€ã¾ãšã¯â—‡â—‡ã‹ã‚‰ã‚„ã£ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ`
  },
  prep: {
    name: "PREP",
    seconds: 40,
    hint: "çµè«–â†’ç†ç”±â†’å…·ä½“ä¾‹â†’çµè«–ï¼ˆçŸ­æ™‚é–“ã§ä¼ãˆã‚‹ï¼‰",
    topicHint: "ğŸ’¡ æœ€åˆã«çµè«–ã‚’è¨€ã£ã¦ã‹ã‚‰ã€ç†ç”±â†’å…·ä½“ä¾‹â†’çµè«–ã§ç· ã‚ã‚‹ã¨40ç§’ãŒæ±ºã¾ã‚Šã¾ã™ã€‚",
    topics: [
      "æœ€è¿‘è²·ã£ã¦ã‚ˆã‹ã£ãŸã‚‚ã®",
      "ãŠã™ã™ã‚ã®ç¿’æ…£",
      "ç§ã®å¼·ã¿",
      "å¤±æ•—ã‹ã‚‰å­¦ã‚“ã ã“ã¨",
      "å¥åº·ã®ãŸã‚ã«ã—ã¦ã„ã‚‹ã“ã¨",
      "ä»•äº‹ã§å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ã“ã¨",
      "å°Šæ•¬ã—ã¦ã„ã‚‹äºº",
      "ç·Šå¼µã—ãŸæ™‚ã®å¯¾å‡¦æ³•",
      "æ™‚é–“ç®¡ç†ã®ã‚³ãƒ„",
      "ç§ãŒå¤§äº‹ã«ã—ã¦ã„ã‚‹ä¾¡å€¤è¦³"
    ],
    template:
`ï¼ˆPREPä¾‹ï¼‰
Pï¼šçµè«–ã¯ã€‡ã€‡ã§ã™ã€‚
Rï¼šãªãœãªã‚‰â–³â–³ã ã‹ã‚‰ã§ã™ã€‚
Eï¼šä¾‹ãˆã°â–¡â–¡ã®æ™‚ã«â€¦
Pï¼šã ã‹ã‚‰ç§ã¯ã€‡ã€‡ã ã¨æ€ã„ã¾ã™ã€‚`
  },
  story: {
    name: "ã‚¹ãƒˆãƒ¼ãƒªãƒ¼",
    seconds: 80,
    hint: "çŠ¶æ³â†’å‡ºæ¥äº‹â†’æ„Ÿæƒ…â†’å­¦ã³â†’ä»Šå¾Œï¼ˆå¿ƒã‚’å‹•ã‹ã™ï¼‰",
    topicHint: "ğŸ’¡ æƒ…æ™¯ï¼ˆã„ã¤/ã©ã“ã§ï¼‰ï¼‹æ„Ÿæƒ…ï¼ˆå¬‰ã—ã„/æ‚”ã—ã„ç­‰ï¼‰ï¼‹å­¦ã³ã‚’å…¥ã‚Œã‚‹ã¨å¼·ã„ã§ã™ã€‚",
    topics: [
      "äººç”Ÿã®è»¢æ©Ÿã«ãªã£ãŸå‡ºæ¥äº‹",
      "æŒ«æŠ˜ã—ãŸã‘ã©ç«‹ã¡ç›´ã‚ŒãŸè©±",
      "å¿˜ã‚Œã‚‰ã‚Œãªã„æ„Ÿå‹•ä½“é¨“",
      "æ€–ã‹ã£ãŸçµŒé¨“ã¨ãã®å…‹æœ",
      "èª°ã‹ã«æ„Ÿè¬ã—ãŸã„å‡ºæ¥äº‹",
      "åŠªåŠ›ãŒå ±ã‚ã‚ŒãŸç¬é–“",
      "å¤±æ•—ã—ã¦æ¥ãšã‹ã—ã‹ã£ãŸã‘ã©å­¦ã‚“ã è©±",
      "äººé–“é–¢ä¿‚ã§æ•‘ã‚ã‚ŒãŸã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰",
      "ä»•äº‹ã§èƒ¸ãŒç†±ããªã£ãŸç¬é–“",
      "ã€Œã‚ã®æ™‚ã®è‡ªåˆ†ã€ã«ä¼ãˆãŸã„ã“ã¨"
    ],
    template:
`ï¼ˆã‚¹ãƒˆãƒ¼ãƒªãƒ¼ä¾‹ï¼‰
çŠ¶æ³ï¼šã„ã¤/ã©ã“ã§/ä½•ãŒèµ·ãã¦ã„ãŸã‹
å‡ºæ¥äº‹ï¼šä½•ãŒèµ·ããŸã‹
æ„Ÿæƒ…ï¼šãã®æ™‚ã©ã†æ„Ÿã˜ãŸã‹
å­¦ã³ï¼šä½•ã«æ°—ã¥ã„ãŸã‹
ä»Šå¾Œï¼šã“ã‚Œã‹ã‚‰ã©ã†ã—ãŸã„ã‹`
  },
  nego: {
    name: "äº¤æ¸‰è¡“",
    seconds: 120,
    hint: "ç›®çš„â†’æ¡ä»¶â†’ç†ç”±â†’ä»£æ¡ˆâ†’åˆæ„ï¼ˆè½ã¨ã—æ‰€ã‚’ä½œã‚‹ï¼‰",
    topicHint: "ğŸ’¡ ç›®çš„â†’ç†ç”±â†’ä»£æ¡ˆï¼ˆAæ¡ˆ/Bæ¡ˆï¼‰â†’ç›¸æ‰‹ã®ãƒ¡ãƒªãƒƒãƒˆã€ã®é †ã§è©±ã™ã¨äº¤æ¸‰ãŒé€šã‚Šã‚„ã™ã„ã§ã™ã€‚",
    topics: [
      "ã‚·ãƒ•ãƒˆã‚„äºˆå®šã®èª¿æ•´ã‚’ãŠé¡˜ã„ã—ãŸã„ï¼ˆç›¸æ‰‹ã®äº‹æƒ…ã‚‚å°Šé‡ï¼‰",
      "è¿½åŠ æ¥­å‹™ã‚’æ–­ã‚Šã¤ã¤ä»£æ¡ˆã‚’å‡ºã™",
      "å€¤ä¸Šã’ï¼ˆæ–™é‡‘æ”¹å®šï¼‰ã‚’ä¸å¯§ã«ä¼ãˆã‚‹",
      "æœŸé™å»¶é•·ã‚’ãŠé¡˜ã„ã™ã‚‹ï¼ˆèª å®Ÿã«ï¼‰",
      "å®¶æ—ã«å”åŠ›ã‚’ãŠé¡˜ã„ã™ã‚‹ï¼ˆå…·ä½“æ¡ˆã¤ãï¼‰",
      "å–å¼•å…ˆã«æ¡ä»¶å¤‰æ›´ã‚’ç›¸è«‡ã™ã‚‹",
      "ç›¸æ‰‹ã®è¦æœ›ã‚’ä¸€éƒ¨ã ã‘å—ã‘ã‚‹äº¤æ¸‰",
      "ã‚¯ãƒ¬ãƒ¼ãƒ å¯¾å¿œã§è½ã¨ã—æ‰€ã‚’ä½œã‚‹",
      "ä»•äº‹ã®å½¹å‰²åˆ†æ‹…ã‚’èª¿æ•´ã™ã‚‹",
      "è‡ªåˆ†ã®å¸Œæœ›ã‚’é€šã—ã¤ã¤é–¢ä¿‚æ€§ã‚’å®ˆã‚‹"
    ],
    template:
`ï¼ˆäº¤æ¸‰ãƒ†ãƒ³ãƒ—ãƒ¬ï¼‰
ç›®çš„ï¼šä»Šæ—¥ã¯ã€‡ã€‡ã‚’ç›¸è«‡ã—ãŸã„ã§ã™ã€‚
ç†ç”±ï¼šèƒŒæ™¯ã¨ã—ã¦â–³â–³ãŒã‚ã£ã¦â€¦
æ¡ä»¶ï¼šå¸Œæœ›ã¯â–¡â–¡ã§ã™ã€‚
ä»£æ¡ˆï¼šé›£ã—ã‘ã‚Œã°Aæ¡ˆ/Bæ¡ˆã¯ã©ã†ã§ã—ã‚‡ã†ï¼Ÿ
åˆæ„ï¼šã©ã®å½¢ãªã‚‰ãŠäº’ã„ç„¡ç†ãªãé€²ã‚ã‚‰ã‚Œã¾ã™ã‹ï¼Ÿ`
  }
};

let currentModeKey = "area";
let TARGET_SECONDS = MODES[currentModeKey].seconds;

let time = TARGET_SECONDS;
let interval = null;

function setMode(key){
  currentModeKey = key;
  TARGET_SECONDS = MODES[key].seconds;

  // ãƒœã‚¿ãƒ³è¦‹ãŸç›®ï¼ˆç°¡æ˜“ï¼‰
  ["area","prep","story","nego"].forEach(k => {
    const b = document.getElementById("btn-" + k);
    if(!b) return;
    b.style.opacity = (k === key) ? "1" : "0.6";
    b.style.border = (k === key) ? "2px solid #333" : "";
  });

  document.getElementById("modeHint").textContent =
    `é¸æŠä¸­ï¼š${MODES[key].name}ï¼ˆ${MODES[key].hint}ï¼‰`;

  document.getElementById("topicHint").textContent = MODES[key].topicHint;

  time = TARGET_SECONDS;
  document.getElementById("timer").textContent = time;
  document.getElementById("timeHint").textContent =
    `ã“ã®ãƒ¢ãƒ¼ãƒ‰ã®ç›®å®‰ï¼š${TARGET_SECONDS}ç§’`;

  document.getElementById("topic").textContent = "ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„";
  stop();
}

function newTopic(){
  const conf = MODES[currentModeKey];
  const t = conf.topics[Math.floor(Math.random() * conf.topics.length)];
  document.getElementById("topic").textContent = t;
}

function start(){
  if(interval) return;

  newTopic();

  time = TARGET_SECONDS;
  document.getElementById("timer").textContent = time;

  interval = setInterval(() => {
    time--;
    document.getElementById("timer").textContent = time;

    if(time <= 0){
      stop();
      const msg = (TARGET_SECONDS >= 120)
        ? "çµ‚äº†ï¼2åˆ†ã‚„ã‚Šåˆ‡ã‚Šã¾ã—ãŸã€‚æœ¬å½“ã«ãŠç–²ã‚Œã•ã¾ã§ã—ãŸğŸ˜Š"
        : "çµ‚äº†ï¼ãŠç–²ã‚Œã•ã¾ã§ã—ãŸğŸ˜Š";
      alert(msg);
    }
  }, 1000);
}

function stop(){
  if(interval){
    clearInterval(interval);
    interval = null;
  }
}

/* =========================
   éŒ²éŸ³ï¼ˆMediaRecorderï¼‰
========================= */
let hxMediaRecorder = null;
let hxRecordedChunks = [];
let hxRecordedBlobUrl = null;

async function hxToggleRecording(){
  const btn = document.getElementById("hxRecBtn");
  const status = document.getElementById("hxRecStatus");
  const player = document.getElementById("hxPlayer");

  if(hxMediaRecorder && hxMediaRecorder.state === "recording"){
    hxMediaRecorder.stop();
    btn.textContent = "éŒ²éŸ³é–‹å§‹";
    status.textContent = "åœæ­¢ã—ã¾ã—ãŸï¼ˆéŸ³å£°ç”Ÿæˆä¸­â€¦ï¼‰";
    return;
  }

  try{
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    hxRecordedChunks = [];
    hxMediaRecorder = new MediaRecorder(stream);

    hxMediaRecorder.ondataavailable = (e) => {
      if(e.data && e.data.size > 0) hxRecordedChunks.push(e.data);
    };

    hxMediaRecorder.onstop = () => {
      stream.getTracks().forEach(t => t.stop());
      const blob = new Blob(hxRecordedChunks, { type: "audio/webm" });
      if(hxRecordedBlobUrl) URL.revokeObjectURL(hxRecordedBlobUrl);
      hxRecordedBlobUrl = URL.createObjectURL(blob);

      player.src = hxRecordedBlobUrl;
      player.style.display = "block";
      status.textContent = "éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿æº–å‚™OKï¼ˆå†ç”Ÿã§ãã¾ã™ï¼‰";
    };

    hxMediaRecorder.start();
    btn.textContent = "éŒ²éŸ³åœæ­¢";
    status.textContent = "éŒ²éŸ³ä¸­â€¦";
  }catch(err){
    status.textContent = "éŒ²éŸ³ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆãƒã‚¤ã‚¯è¨±å¯ã‚’ç¢ºèªï¼‰";
    alert("éŒ²éŸ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚iPhoneã®è¨­å®š/ã‚µã‚¤ãƒˆè¨­å®šã§ãƒã‚¤ã‚¯è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  }
}

function hxResetRecording(){
  const status = document.getElementById("hxRecStatus");
  const player = document.getElementById("hxPlayer");

  if(hxMediaRecorder && hxMediaRecorder.state === "recording"){
    hxMediaRecorder.stop();
  }
  hxRecordedChunks = [];
  if(hxRecordedBlobUrl) URL.revokeObjectURL(hxRecordedBlobUrl);
  hxRecordedBlobUrl = null;

  player.pause();
  player.removeAttribute("src");
  player.style.display = "none";
  status.textContent = "å¾…æ©Ÿä¸­";

  const btn = document.getElementById("hxRecBtn");
  btn.textContent = "éŒ²éŸ³é–‹å§‹";
}

/* =========================
   é•·ã•æ¨å®šï¼ˆå…±é€šï¼‰
========================= */
function hxEstimateSeconds(text){
  const t = (text || "")
    .replace(/\s/g, "")
    .replace(/[ã€ã€‚,.!?ï¼ï¼Ÿ]/g,"");
  const chars = t.length;

  // ç›®å®‰ï¼š1ç§’=6æ–‡å­—ï¼ˆå¿…è¦ãªã‚‰èª¿æ•´ï¼‰
  const CHARS_PER_SEC = 6;
  const sec = chars / CHARS_PER_SEC;
  return { sec, chars, charsPerSec: CHARS_PER_SEC };
}

/* =========================
   è©•ä¾¡ï¼ˆãƒ¢ãƒ¼ãƒ‰ï¼‹ãŠé¡Œã«æ²¿ã£ã¦ï¼‰
========================= */
function hxEvaluateByMode(text, modeKey, topicText){
  const raw = (text || "").trim();
  const t = raw.replace(/\r\n/g, "\n").replace(/\n{3,}/g, "\n\n").trim();
  const conf = MODES[modeKey];
  const target = conf.seconds;

  let score = 60;
  const badges = [];
  const good = [];
  const advice = [];

  if(t.length < 10){
    return {
      score: 60,
      badges: ["å…¥åŠ›ãŒçŸ­ã‚"],
      message:
`ğŸŒŸ ç·åˆè©•ä¾¡ï¼š60ç‚¹

ã¾ãšæŒ‘æˆ¦ã—ãŸã“ã¨ãŒç´ æ™´ã‚‰ã—ã„ã§ã™ğŸ‘

é¸æŠä¸­ã®è©±æ³•ï¼š${conf.name}
ãŠé¡Œï¼š${topicText || "ï¼ˆæœªè¡¨ç¤ºï¼‰"}

ğŸ’¡ æ¬¡ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’å…¥ã‚Œã¦ã¿ã¾ã—ã‚‡ã†ï¼š
${conf.template}`
    };
  }

  // å…±é€šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆæŸ”è»Ÿï¼‰
  const conclusion = ["çµè«–","è¦ã™ã‚‹ã«","ã¤ã¾ã‚Š","ä¸€è¨€ã§ã„ã†ã¨","ç§ã¯","åƒ•ã¯","å¤§äº‹ãªã®ã¯","é‡è¦ãªã®ã¯","ãƒã‚¤ãƒ³ãƒˆã¯","ä¸€ç•ªè¨€ã„ãŸã„ã®ã¯"];
  const reason = ["ãªãœãªã‚‰","ç†ç”±","èƒŒæ™¯","ã¨ã„ã†ã®ã‚‚","ãªãœã‹ã¨ã„ã†ã¨","ã ã‹ã‚‰ã“ã","ãªã®ã§","ã‹ã‚‰","ãŸã‚","ãŒã‚ã£ã¦","èƒŒæ™¯ã¨ã—ã¦"];
  const example = ["ä¾‹ãˆã°","ãŸã¨ãˆã°","å®Ÿéš›ã«","å…ˆæ—¥","ä»¥å‰","å…·ä½“çš„ã«","ä½“é¨“ã¨ã—ã¦","ãã®æ™‚","å½“æ™‚","å ´é¢","ã‚·ãƒ¼ãƒ³"];
  const summary = ["ã¾ã¨ã‚ã‚‹ã¨","çµè«–ã¨ã—ã¦","æœ€å¾Œã«","ã ã‹ã‚‰","ã¤ã¾ã‚Š","ãªã®ã§","ã¨ã„ã†ã‚ã‘ã§","è¦ã¯","ä»Šå¾Œã¯","ã“ã‚Œã‹ã‚‰","ãœã²"];

  const hasC = conclusion.some(w => t.includes(w));
  const hasR = reason.some(w => t.includes(w));
  const hasE = example.some(w => t.includes(w));
  const hasS = summary.some(w => t.includes(w));

  // ãƒ¢ãƒ¼ãƒ‰åˆ¥ã«é‡ã¿ã‚’å°‘ã—å¤‰ãˆã‚‹
  if(modeKey === "prep"){
    if(hasC){ score += 15; good.push("çµè«–ãŒã¯ã£ãã‚Šã—ã¦ã„ã¦40ç§’å‘ãã§ã—ãŸ"); badges.push("çµè«–"); }
    if(hasR){ score += 10; good.push("ç†ç”±ãŒã¤ã„ã¦èª¬å¾—åŠ›ãŒã‚ã‚Šã¾ã—ãŸ"); badges.push("ç†ç”±"); }
    if(hasE){ score += 10; good.push("å…·ä½“ä¾‹ãŒã‚ã£ã¦ä¼ã‚ã‚Šã‚„ã™ã„ã§ã™"); badges.push("å…·ä½“ä¾‹"); }
    if(hasS){ score += 5;  good.push("ç· ã‚ãŒã‚ã£ã¦ç¶ºéº—ã§ã—ãŸ"); badges.push("ç· ã‚"); }
  } else if(modeKey === "area"){
    // å…±æ„Ÿãƒ¯ãƒ¼ãƒ‰ã‚‚è¦‹ã‚‹
    const agree = ["å¤§å¤‰","ã‚ã‹ã‚Šã¾ã™","ãŠæ°—æŒã¡","ãŠç–²ã‚Œ","ã§ã™ã‚ˆã­","ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™"];
    const hasA = agree.some(w => t.includes(w));
    if(hasA){ score += 12; good.push("å…±æ„Ÿãƒ»è‚¯å®šã‹ã‚‰å…¥ã‚Œã¦ã„ã¦ä¿¡é ¼æ„ŸãŒã‚ã‚Šã¾ã—ãŸ"); badges.push("å…±æ„Ÿ"); }
    if(hasR){ score += 10; good.push("ç†ç”±ãŒã‚ã‚Šç´å¾—ã—ã‚„ã™ã„ã§ã™"); badges.push("ç†ç”±"); }
    if(hasE){ score += 10; good.push("å…·ä½“ä¾‹ãŒã‚ã‚Šã‚¤ãƒ¡ãƒ¼ã‚¸ã§ãã¾ã™"); badges.push("å…·ä½“ä¾‹"); }
    // è¡Œå‹•ææ¡ˆã½ã„
    const action = ["ã‚„ã£ã¦ã¿","ã—ã¾ã—ã‚‡ã†","ææ¡ˆ","ãŠã™ã™ã‚","æ¬¡ã¯","ä¸€åº¦"];
    if(action.some(w => t.includes(w))){ score += 10; good.push("è¡Œå‹•ææ¡ˆã¾ã§ã§ãã¦ã„ã¦AREAãŒå®Œæˆã—ã¦ã„ã¾ã™"); badges.push("ææ¡ˆ"); }
  } else if(modeKey === "story"){
    // æ„Ÿæƒ…ãƒ»å­¦ã³
    const emo = ["å¬‰ã—ã„","æ‚”ã—ã„","æ‚²ã—ã„","æ€–ã„","æ„Ÿå‹•","é©šã„","ãƒ¯ã‚¯ãƒ¯ã‚¯","ãƒ¢ãƒ¤ãƒ¢ãƒ¤","ã»ã£ã¨","æ³£ã„"];
    const learn = ["å­¦ã‚“ã ","æ°—ã¥ã„ãŸ","åçœ","æˆé•·","ä¾¡å€¤è¦³","å¤§åˆ‡","å¤‰ã‚ã£ãŸ"];
    if(emo.some(w => t.includes(w))){ score += 12; good.push("æ„Ÿæƒ…ãŒå…¥ã£ã¦ã„ã¦å¿ƒã«å±Šãã¾ã™"); badges.push("æ„Ÿæƒ…"); }
    if(hasE){ score += 10; good.push("å‡ºæ¥äº‹ãŒå…·ä½“çš„ã§æƒ…æ™¯ãŒæµ®ã‹ã³ã¾ã—ãŸ"); badges.push("æƒ…æ™¯"); }
    if(learn.some(w => t.includes(w))){ score += 10; good.push("å­¦ã³ãŒã‚ã‚Šã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã¨ã—ã¦ç· ã¾ã£ã¦ã„ã¾ã™"); badges.push("å­¦ã³"); }
    if(hasS){ score += 5; good.push("æœ€å¾Œã®ã¾ã¨ã‚ãŒè‰¯ã„ã§ã™"); badges.push("ç· ã‚"); }
  } else if(modeKey === "nego"){
    // äº¤æ¸‰ï¼šç›®çš„/ç†ç”±/ä»£æ¡ˆ/ç›¸æ‰‹ãƒ¡ãƒªãƒƒãƒˆ
    const purpose = ["ç›¸è«‡","ãŠé¡˜ã„","å¸Œæœ›","ç›®çš„","ææ¡ˆ"];
    const alt = ["ä»£æ¡ˆ","Aæ¡ˆ","Bæ¡ˆ","ã‚‚ã—é›£ã—ã‘ã‚Œã°","åˆ¥æ¡ˆ"];
    const merit = ["ãŠäº’ã„","åŒæ–¹","ãƒ¡ãƒªãƒƒãƒˆ","åŠ©ã‹ã‚‹","è² æ‹…","ç„¡ç†ãªã"];
    if(purpose.some(w => t.includes(w))){ score += 10; good.push("ç›®çš„ãŒæ˜ç¢ºã§äº¤æ¸‰ãŒå§‹ã‚ã‚„ã™ã„ã§ã™"); badges.push("ç›®çš„"); }
    if(hasR){ score += 10; good.push("ç†ç”±ãŒã‚ã‚‹ã®ã§ç›¸æ‰‹ãŒç´å¾—ã—ã‚„ã™ã„ã§ã™"); badges.push("ç†ç”±"); }
    if(alt.some(w => t.includes(w))){ score += 12; good.push("ä»£æ¡ˆãŒå‡ºã¦ã„ã¦äº¤æ¸‰ãŒé€šã‚Šã‚„ã™ã„ã§ã™"); badges.push("ä»£æ¡ˆ"); }
    if(merit.some(w => t.includes(w))){ score += 10; good.push("ç›¸æ‰‹ã®ãƒ¡ãƒªãƒƒãƒˆã‚’æ„è­˜ã§ãã¦ã„ã¾ã™"); badges.push("ç›¸æ‰‹ç›®ç·š"); }
  }

  // é‡
  if(t.length > 150){ score += 5; badges.push("å†…å®¹"); }

  // é•·ã•ãƒã‚§ãƒƒã‚¯
  const est = hxEstimateSeconds(t);
  const low = target * 0.85;
  const high = target * 1.15;

  let lengthComment = "";
  if(est.sec < low){
    badges.push("çŸ­ã‚");
    lengthComment =
`â± é•·ã•ãƒã‚§ãƒƒã‚¯ï¼šæ¨å®š ${est.sec.toFixed(0)}ç§’ï¼ˆç›®æ¨™ ${target}ç§’ï¼‰ â†’ å°‘ã—çŸ­ã‚
ğŸ’¡ ä¼¸ã°ã™ã‚³ãƒ„ï¼šãƒ†ãƒ³ãƒ—ãƒ¬ã®ã€Œè¶³ã‚Šãªã„1ãƒ‘ãƒ¼ãƒ„ã€ã‚’è¶³ã™ï¼ˆä¾‹ï¼šå…·ä½“ä¾‹ or å­¦ã³ï¼‰`;
    advice.push("1ãƒ‘ãƒ¼ãƒ„è¶³ã™ã ã‘ã§ã€è‡ªç„¶ã«æ™‚é–“ãŒåŸ‹ã¾ã‚Šã¾ã™");
  }else if(est.sec > high){
    badges.push("é•·ã‚");
    lengthComment =
`â± é•·ã•ãƒã‚§ãƒƒã‚¯ï¼šæ¨å®š ${est.sec.toFixed(0)}ç§’ï¼ˆç›®æ¨™ ${target}ç§’ï¼‰ â†’ å°‘ã—é•·ã‚
ğŸ’¡ çŸ­ãã™ã‚‹ã‚³ãƒ„ï¼šå…·ä½“ä¾‹ã‚’1ã¤ã«çµã‚Šã€ç· ã‚ã‚’1æ–‡ã«ã¾ã¨ã‚ã‚‹`;
    advice.push("ä¸€ç•ªå¼·ã„å…·ä½“ä¾‹ã ã‘æ®‹ã™ã¨ã€ã¾ã¨ã¾ã‚ŠãŒè‰¯ããªã‚Šã¾ã™");
  }else{
    badges.push("é•·ã•OK");
    score += 5;
    lengthComment =
`â± é•·ã•ãƒã‚§ãƒƒã‚¯ï¼šæ¨å®š ${est.sec.toFixed(0)}ç§’ï¼ˆç›®æ¨™ ${target}ç§’ï¼‰ â†’ ã¡ã‚‡ã†ã©è‰¯ã„é•·ã•ã§ã™ âœ…`;
    good.push("æ™‚é–“é…åˆ†ãŒå®‰å®šã—ã¦ã„ã¦èãã‚„ã™ã„ã§ã™");
  }

  // ãŠé¡Œã«æ²¿ã£ã¦ã‚‹ã‹ï¼ˆç°¡æ˜“ï¼šãŠé¡Œã®ä¸»è¦èªãŒå«ã¾ã‚ŒãŸã‚‰åŠ ç‚¹ï¼‰
  if(topicText){
    const key = topicText
      .replace(/[ï¼ˆï¼‰()ã€Œã€ã€ã€ãƒ»ã€ã€‚,.!?ï¼ï¼Ÿ]/g," ")
      .split(/\s+/).filter(x => x && x.length >= 2);
    const hit = key.some(k => t.includes(k));
    if(hit){
      score += 3;
      badges.push("ãŠé¡Œæ²¿ã„");
    }else{
      // æ¸›ç‚¹ã¯ã—ãªã„ã€å„ªã—ãä¿ƒã™
      advice.push("ãŠé¡Œã®è¨€è‘‰ã‚’1å›ã ã‘æœ¬æ–‡ã«å…¥ã‚Œã‚‹ã¨ã€ã‚ˆã‚Šâ€œãŠé¡Œæ²¿ã„â€ã«è¦‹ãˆã¾ã™");
    }
  }

  // æ”¹å–„ã¯æœ€å¤§2ã¤
  const merged = [];
  advice.forEach(a => {
    if(!a) return;
    if(merged.includes(a)) return;
    if(merged.length >= 2) return;
    merged.push(a);
  });

  const praise = good.length
    ? good[Math.floor(Math.random() * good.length)]
    : "å‰å‘ãã«è©±ãã†ã¨ã—ã¦ã„ã‚‹å§¿å‹¢ãŒã¨ã¦ã‚‚è‰¯ã„ã§ã™";

  score = Math.min(score, 100);

  // åŠ´ã„ï¼ˆé•·ã„ãƒ¢ãƒ¼ãƒ‰ã»ã©å¼·ã‚ï¼‰
  const warm =
    (target >= 120) ? "2åˆ†ã¯æœ¬å½“ã«ä½“åŠ›ã‚’ä½¿ã„ã¾ã™ã€‚ã‚ˆãã‚„ã‚Šåˆ‡ã‚Šã¾ã—ãŸğŸ‘"
    : (target >= 80) ? "80ç§’ã§ã‚‚ååˆ†ã™ã”ã„ã§ã™ã€‚é›†ä¸­ã—ã¦è©±ã›ã¦ã„ã¾ã™ğŸ‘"
    : "çŸ­æ™‚é–“ã§ã¾ã¨ã‚ã‚‰ã‚Œã¦ã„ã¦è‰¯ã„ã§ã™ğŸ‘";

  const improveText = merged.length
    ? "ğŸ’¡ ã•ã‚‰ã«è‰¯ãã™ã‚‹ãªã‚‰ï¼š\nãƒ»" + merged.join("\nãƒ»")
    : "ğŸ’¡ ä»Šã®èª¿å­ã§ç¶šã‘ã¦ã„ãã¾ã—ã‚‡ã†";

  return {
    score,
    badges,
    message:
`ğŸŒŸ ç·åˆè©•ä¾¡ï¼š${score}ç‚¹

${warm}

é¸æŠä¸­ã®è©±æ³•ï¼š${conf.name}
ãŠé¡Œï¼š${topicText || "ï¼ˆæœªè¡¨ç¤ºï¼‰"}

ç‰¹ã«ã€Œ${praise}ã€ç‚¹ãŒç´ æ™´ã‚‰ã—ã„ã§ã™ã€‚

${lengthComment}

${improveText}

ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆå›°ã£ãŸã‚‰ã“ã‚Œï¼‰ï¼š
${conf.template}
`
  };
}

/* =========================
   UIæ“ä½œ
========================= */
function hxRunEvaluation(){
  const text = document.getElementById("hxSpeechText").value;
  const topicText = document.getElementById("topic").textContent;
  const res = hxEvaluateByMode(text, currentModeKey, topicText);

  const badgesEl = document.getElementById("hxBadges");
  badgesEl.innerHTML = "";
  (res.badges || []).forEach(b => {
    const span = document.createElement("span");
    span.textContent = b;
    span.style.display = "inline-block";
    span.style.padding = "6px 10px";
    span.style.borderRadius = "999px";
    span.style.border = "1px solid #ddd";
    span.style.fontSize = "14px";
    span.style.margin = "4px 6px 0 0";
    badgesEl.appendChild(span);
  });

  document.getElementById("hxResult").textContent = res.message;
}

function hxClearText(){
  document.getElementById("hxSpeechText").value = "";
  document.getElementById("hxBadges").innerHTML = "";
  document.getElementById("hxResult").textContent = "ã“ã“ã«è©•ä¾¡çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚";
}

function hxInsertTemplate(){
  document.getElementById("hxSpeechText").value = MODES[currentModeKey].template;
  hxRunEvaluation();
}

/* åˆæœŸçŠ¶æ…‹ */
setMode("area");
</script>

</body>
</html>
