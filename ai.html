<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIè©•ä¾¡ï¼ˆéŒ²éŸ³ã¤ãï¼‰</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .btnRow { display:flex; gap:10px; flex-wrap:wrap; }
    textarea { width:100%; min-height:160px; padding:12px; border-radius:12px; border:1px solid #ddd; }
    .resultBox { white-space: pre-wrap; line-height: 1.9; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid #ddd; font-size:14px; margin:4px 6px 0 0; }
    .small { font-size: 14px; opacity: 0.9; line-height: 1.7; }
    button { padding:12px 14px; border-radius:12px; border:1px solid #ddd; background:#fff; }
    button.primary { border:none; background:#0ea5e9; color:#fff; }
    button.danger { border:none; background:#ef4444; color:#fff; }
    button.good { border:none; background:#22c55e; color:#fff; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    audio { width:100%; margin-top:10px; }
    .box { border:1px solid #eee; border-radius:14px; padding:12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .hr { height:1px; background:#eee; margin:12px 0; }
    details { border:1px solid #eee; border-radius:14px; padding:12px; background:#fff; }
    summary { cursor:pointer; font-weight:700; }
    .grid2 { display:grid; gap:10px; grid-template-columns: 1fr; }
    @media (min-width: 720px){
      .grid2 { grid-template-columns: 1fr 1fr; }
    }
    .kv { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .kv .pill { background:#fff; }
    .notice { padding:10px 12px; border-radius:12px; border:1px dashed #ddd; }
  </style>
</head>

<body>
  <header class="top">
    <h1>ğŸ§  AIè©•ä¾¡ï¼ˆéŒ²éŸ³ã¤ãï¼‰</h1>
    <p class="sub">éŒ²éŸ³â†’å†ç”Ÿâ†’ï¼ˆä»»æ„ã§ãƒ¡ãƒ¢/æ–‡å­—èµ·ã“ã—ï¼‰â†’ã‚„ã•ã—ãç·åˆè©•ä¾¡</p>
    <p><a href="index.html">â† ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</a></p>
  </header>

  <main class="menu">

    <!-- âœ… è¿·ã‚ãªã„å°ç·šï¼ˆãƒŸãƒ‹æ‰‹é † + ç¶™ç¶šãƒ­ã‚°ï¼‰ -->
    <div class="card" style="display:block;">
      <div class="title">âœ… ä»Šæ—¥ã®ã‚„ã‚Šæ–¹ï¼ˆè¿·ã£ãŸã‚‰ã“ã‚Œï¼‰</div>
      <div class="desc">
        <div class="notice small">
          â‘  ã¾ãš <b>éŒ²éŸ³</b> â†’ â‘¡ <b>æœ¬æ–‡ã«ãƒ¡ãƒ¢</b> â†’ â‘¢ <b>AIè©•ä¾¡</b><br>
          â€»ã€Œæ–‡å­—èµ·ã“ã—ã€ã¯ä¸Šç´šè€…å‘ã‘ï¼ˆä»»æ„ï¼‰ã€‚å‹•ã‹ãªãã¦ã‚‚OKã§ã™ã€‚
        </div>

        <div class="hr"></div>

        <div class="kv">
          <span class="pill">ğŸ“Œ åˆè¨ˆç·´ç¿’å›æ•°ï¼š<b id="statTotal">0</b></span>
          <span class="pill">ğŸ”¥ é€£ç¶šæ—¥æ•°ï¼š<b id="statStreak">0</b></span>
          <span class="pill">ğŸ•’ æœ€çµ‚ç·´ç¿’ï¼š<b id="statLast">--</b></span>
        </div>

        <div class="small" style="margin-top:8px;">
          ğŸ’¡ ç¶šã‘ã‚‹ã‚³ãƒ„ï¼š<b>ã€Œè‰¯ã‹ã£ãŸ1ã¤ã€ï¼‹ã€Œæ¬¡ã¯1ã¤ã€</b>ã ã‘æ›¸ã‘ã°ä¼¸ã³ã¾ã™ã€‚
        </div>
      </div>
    </div>

    <!-- éŒ²éŸ³ -->
    <div class="card" style="display:block;">
      <div class="title">ğŸ™ éŒ²éŸ³</div>
      <div class="desc">
        <div class="box">
          <div class="row">
            <button id="recBtn" class="good" onclick="toggleRecording()">éŒ²éŸ³é–‹å§‹</button>
            <button class="danger" onclick="resetRecording()">éŒ²éŸ³ãƒªã‚»ãƒƒãƒˆ</button>
            <span id="recStatus" class="mono">å¾…æ©Ÿä¸­</span>
          </div>

          <audio id="player" controls style="display:none;"></audio>

          <div class="small" style="margin-top:10px;">
            âœ… éŒ²éŸ³ã—ãŸéŸ³å£°ã¯ã“ã®ç«¯æœ«å†…ã§å†ç”Ÿã§ãã¾ã™ã€‚<br>
            ğŸ’¡ å†ç”Ÿã‚’è´ããªãŒã‚‰ä¸‹ã®æœ¬æ–‡æ¬„ã«ãƒ¡ãƒ¢ â†’ AIè©•ä¾¡ãŒä¸€ç•ªãŠã™ã™ã‚ã§ã™ã€‚
          </div>

          <div class="hr"></div>

          <!-- âœ… æµ®ã‹ãªã„ã‚ˆã†ã«ã€Œä¸Šç´šï¼ˆä»»æ„ï¼‰ã€ã¸æ ¼ä¸Šã’ã—ã¦æŠ˜ã‚ŠãŸãŸã¿ -->
          <details>
            <summary>ä¸Šç´šï¼ˆä»»æ„ï¼‰ï¼šã‚»ãƒ«ãƒ•æ–‡å­—èµ·ã“ã—ï¼ˆè©¦é¨“ï¼‰</summary>
            <div class="small" style="margin-top:10px;">
              ã“ã‚Œã¯<b>ä»»æ„</b>ã§ã™ã€‚å‹•ã‹ãªã„ç’°å¢ƒã‚‚å¤šã„ã®ã§ã€ä½¿ãˆãªãã¦ã‚‚å…¨ãå•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚<br>
              ç›®çš„ï¼šè‡ªåˆ†ã®ã€Œå£ãã›ã€ã€Œè¨€ã„ç›´ã—ã€ã€Œãƒ ãƒ€èªã€ã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã®ç·´ç¿’ã§ã™ã€‚
            </div>

            <div class="row" style="margin-top:10px;">
              <button id="speechBtn" onclick="toggleSpeechToText()" style="display:none;">ğŸ“ æ–‡å­—èµ·ã“ã—ã‚’é–‹å§‹</button>
              <span id="sttStatus" class="mono"></span>
            </div>

            <div class="small" style="margin-top:10px;">
              âš ï¸ iPhone Safariã§ã¯å‹•ã‹ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ï¼ˆãƒœã‚¿ãƒ³ãŒå‡ºãªã„/åå¿œã—ãªã„ç­‰ï¼‰ã€‚<br>
              ãã®å ´åˆã¯ã€ŒéŒ²éŸ³â†’å†ç”Ÿâ†’æ‰‹å…¥åŠ›ãƒ¡ãƒ¢ã€ã§OKã§ã™ã€‚
            </div>
          </details>

        </div>
      </div>
    </div>

    <!-- å…¥åŠ› -->
    <div class="card" style="display:block;">
      <div class="title">ğŸ“ ã‚¹ãƒ”ãƒ¼ãƒæœ¬æ–‡ï¼ˆè©•ä¾¡å¯¾è±¡ï¼‰</div>
      <div class="desc">
        <textarea id="speechText" placeholder="ã“ã“ã«ã‚¹ãƒ”ãƒ¼ãƒã‚’æ›¸ã„ã¦ãã ã•ã„ï¼ˆéŒ²éŸ³ã‚’è´ããªãŒã‚‰ãƒ¡ãƒ¢ã§ã‚‚OKï¼‰"></textarea>

        <div class="btnRow" style="margin-top:10px;">
          <button class="primary" onclick="runEvaluation()">AIè©•ä¾¡ã™ã‚‹</button>
          <button onclick="insertSample()">ã‚µãƒ³ãƒ—ãƒ«æŒ¿å…¥</button>
          <button onclick="clearText()">ã‚¯ãƒªã‚¢</button>
        </div>

        <div class="small" style="margin-top:10px;">
          â€»è©•ä¾¡ã¯ã€Œæ¸›ç‚¹æ–¹å¼ã€ã§ã¯ãªãã€è‰¯ã„ç‚¹ã‚’è¦‹ã¤ã‘ã¦ä¼¸ã°ã™æ–¹å¼ã§ã™ã€‚<br>
          â€»ã€Œçµè«–ãƒ»ç†ç”±ãƒ»ä¾‹ãˆã°ã€ãªã©ã®å˜èªãŒãã®ã¾ã¾å…¥ã£ã¦ã„ãªãã¦ã‚‚ã€ä¼¼ãŸè¡¨ç¾ãªã‚‰OKã«ã—ã¦ã„ã¾ã™ã€‚
        </div>
      </div>
    </div>

    <!-- âœ… æŒ¯ã‚Šè¿”ã‚Šãƒãƒ¼ãƒˆï¼ˆåˆ¥è¦–ç‚¹ã®ã‚µãƒãƒ¼ãƒˆï¼šã“ã“ãŒâ€œæ–‡å­—èµ·ã“ã—â€ã®ä»£æ›¿ã«ã‚‚ãªã‚‹ï¼‰ -->
    <div class="card" style="display:block;">
      <div class="title">ğŸ““ æŒ¯ã‚Šè¿”ã‚Šãƒãƒ¼ãƒˆï¼ˆæˆé•·ãŒé€Ÿããªã‚‹ï¼‰</div>
      <div class="desc">
        <div class="grid2">
          <div>
            <div style="font-weight:700; margin-bottom:6px;">ğŸŒŸ è‰¯ã‹ã£ãŸç‚¹ï¼ˆ1ã¤ã ã‘ï¼‰</div>
            <textarea id="reflectGood" style="min-height:90px;" placeholder="ä¾‹ï¼šçµè«–ã‚’æœ€åˆã«è¨€ãˆãŸ / å£°ãŒã¯ã£ãã‚Šã—ã¦ã„ãŸ ãªã©"></textarea>
          </div>
          <div>
            <div style="font-weight:700; margin-bottom:6px;">ğŸ¯ æ¬¡ã«ç›´ã™ç‚¹ï¼ˆ1ã¤ã ã‘ï¼‰</div>
            <textarea id="reflectNext" style="min-height:90px;" placeholder="ä¾‹ï¼šå…·ä½“ä¾‹ã‚’1ã¤å…¥ã‚Œã‚‹ / ç· ã‚ã‚’1æ–‡ã«ã™ã‚‹ ãªã©"></textarea>
          </div>
        </div>

        <div class="btnRow" style="margin-top:10px;">
          <button onclick="saveReflection()">ä¿å­˜</button>
          <button onclick="loadReflection()">å‰å›ã®æŒ¯ã‚Šè¿”ã‚Šã‚’è¡¨ç¤º</button>
          <button onclick="clearReflection()">æŒ¯ã‚Šè¿”ã‚Šã‚¯ãƒªã‚¢</button>
        </div>

        <div class="small" style="margin-top:10px;">
          ğŸ’¡ ã‚³ãƒ„ï¼šæ¯å›ã€Œè‰¯ã‹ã£ãŸ1ã¤ï¼‹æ¬¡ã¯1ã¤ã€ã ã‘ã§OKã€‚ã“ã‚ŒãŒä¸€äººç·´ç¿’ã®æœ€çŸ­ãƒ«ãƒ¼ãƒˆã§ã™ã€‚
        </div>
      </div>
    </div>

    <!-- çµæœ -->
    <div class="card" style="display:block;">
      <div class="title">ğŸ“Š è©•ä¾¡çµæœ</div>
      <div class="desc">
        <div id="badges"></div>
        <div id="result" class="resultBox" style="margin-top:10px;">ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>

        <div class="btnRow" style="margin-top:10px;">
          <button onclick="copyResult()">ğŸ“‹ çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
          <button onclick="setNextFromAdvice()">ğŸ¯ æ¬¡ã«ç›´ã™ç‚¹ã¸åæ˜ </button>
        </div>

        <div class="small" style="margin-top:10px;">
          âœ… ãŠã™ã™ã‚ï¼šçµæœã‚’è¦‹ãŸã‚‰ã€Œæ¬¡ã«ç›´ã™ç‚¹ã€ã«1è¡Œã ã‘æ›¸ã„ã¦çµ‚ã‚ã‚Šã€‚ã“ã‚Œã§ç¢ºå®Ÿã«ä¼¸ã³ã¾ã™ã€‚
        </div>
      </div>
    </div>

  </main>

<script>
/* =========================================================
   0) ãƒ­ã‚°ï¼ˆlocalStorageï¼‰
   ========================================================= */
const LS = {
  total: "hx_ai_total",
  last: "hx_ai_lastDate",
  streak: "hx_ai_streak",
  lastAdvice: "hx_ai_lastAdvice",
  reflectGood: "hx_ai_reflect_good",
  reflectNext: "hx_ai_reflect_next"
};

function todayKey(){
  // ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ï¼ˆJSTæƒ³å®šï¼‰
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

function formatDate(key){
  if(!key) return "--";
  return key;
}

function updateStatsUI(){
  document.getElementById("statTotal").textContent = Number(localStorage.getItem(LS.total) || 0);
  document.getElementById("statStreak").textContent = Number(localStorage.getItem(LS.streak) || 0);
  document.getElementById("statLast").textContent = formatDate(localStorage.getItem(LS.last));
}

function bumpPracticeCount(){
  const total = Number(localStorage.getItem(LS.total) || 0) + 1;
  localStorage.setItem(LS.total, String(total));

  const today = todayKey();
  const last = localStorage.getItem(LS.last);

  // streakè¨ˆç®—ï¼ˆã–ã£ãã‚Šï¼šå‰å›ãŒæ˜¨æ—¥ãªã‚‰+1ã€ãã‚Œä»¥å¤–ã¯1ï¼‰
  const streakNow = (() => {
    if(!last) return 1;
    // lastKey -> Date
    const [ly,lm,ld] = last.split("-").map(Number);
    const lastDate = new Date(ly, lm-1, ld);
    const now = new Date();
    const diffDays = Math.floor((new Date(now.getFullYear(),now.getMonth(),now.getDate()) - new Date(lastDate.getFullYear(),lastDate.getMonth(),lastDate.getDate())) / 86400000);
    if(diffDays === 0) return Number(localStorage.getItem(LS.streak) || 1); // åŒæ—¥
    if(diffDays === 1) return Number(localStorage.getItem(LS.streak) || 0) + 1; // é€£ç¶š
    return 1; // ãƒªã‚»ãƒƒãƒˆ
  })();

  localStorage.setItem(LS.last, today);
  localStorage.setItem(LS.streak, String(streakNow));
  updateStatsUI();
}

updateStatsUI();

/* =========================================================
   â‘  éŒ²éŸ³ï¼ˆMediaRecorderï¼‰
   ========================================================= */
let mediaRecorder = null;
let recordedChunks = [];
let recordedBlobUrl = null;

async function toggleRecording(){
  const btn = document.getElementById("recBtn");
  const status = document.getElementById("recStatus");
  const player = document.getElementById("player");

  if(mediaRecorder && mediaRecorder.state === "recording"){
    mediaRecorder.stop();
    btn.textContent = "éŒ²éŸ³é–‹å§‹";
    status.textContent = "åœæ­¢ã—ã¾ã—ãŸï¼ˆéŸ³å£°ç”Ÿæˆä¸­â€¦ï¼‰";
    return;
  }

  try{
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    recordedChunks = [];
    mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = (e) => {
      if(e.data && e.data.size > 0) recordedChunks.push(e.data);
    };

    mediaRecorder.onstop = () => {
      stream.getTracks().forEach(t => t.stop());

      const blob = new Blob(recordedChunks, { type: "audio/webm" });
      if(recordedBlobUrl) URL.revokeObjectURL(recordedBlobUrl);
      recordedBlobUrl = URL.createObjectURL(blob);

      player.src = recordedBlobUrl;
      player.style.display = "block";
      status.textContent = "éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿æº–å‚™OKï¼ˆå†ç”Ÿã§ãã¾ã™ï¼‰";
    };

    mediaRecorder.start();
    btn.textContent = "éŒ²éŸ³åœæ­¢";
    status.textContent = "éŒ²éŸ³ä¸­â€¦";
  }catch(err){
    status.textContent = "éŒ²éŸ³ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆãƒã‚¤ã‚¯è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰";
    alert("éŒ²éŸ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚iPhoneã®è¨­å®šã§Safariã®ãƒã‚¤ã‚¯è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  }
}

function resetRecording(){
  const status = document.getElementById("recStatus");
  const player = document.getElementById("player");

  if(mediaRecorder && mediaRecorder.state === "recording"){
    mediaRecorder.stop();
  }
  recordedChunks = [];
  if(recordedBlobUrl) URL.revokeObjectURL(recordedBlobUrl);
  recordedBlobUrl = null;

  player.pause();
  player.removeAttribute("src");
  player.style.display = "none";
  status.textContent = "å¾…æ©Ÿä¸­";
}

/* =========================================================
   â‘¡ï¼ˆä»»æ„ï¼‰éŸ³å£°â†’æ–‡å­—ï¼ˆWeb Speech APIï¼‰
   ========================================================= */
let recognition = null;
let sttRunning = false;

function canUseSpeechRecognition(){
  return (window.SpeechRecognition || window.webkitSpeechRecognition);
}

function setupSpeechButton(){
  const sttBtn = document.getElementById("speechBtn");
  const sttStatus = document.getElementById("sttStatus");

  if(canUseSpeechRecognition()){
    sttBtn.style.display = "inline-block";
    sttStatus.textContent = "å¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã™ï¼ˆä»»æ„ã§ä½¿ãˆã¾ã™ï¼‰";
  }else{
    sttBtn.style.display = "none";
    sttStatus.textContent = "ã“ã®ç’°å¢ƒã§ã¯éå¯¾å¿œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆå•é¡Œã‚ã‚Šã¾ã›ã‚“ï¼‰";
  }
}
setupSpeechButton();

function toggleSpeechToText(){
  const STT = window.SpeechRecognition || window.webkitSpeechRecognition;
  const sttStatus = document.getElementById("sttStatus");
  const sttBtn = document.getElementById("speechBtn");
  const textarea = document.getElementById("speechText");

  if(!STT){
    alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°ã®æ–‡å­—èµ·ã“ã—ã«å¯¾å¿œã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
    return;
  }

  if(sttRunning){
    recognition.stop();
    return;
  }

  recognition = new STT();
  recognition.lang = "ja-JP";
  recognition.interimResults = true;
  recognition.continuous = true;

  let finalText = "";

  recognition.onstart = () => {
    sttRunning = true;
    sttBtn.textContent = "ğŸ›‘ æ–‡å­—èµ·ã“ã—åœæ­¢";
    sttStatus.textContent = "æ–‡å­—èµ·ã“ã—ä¸­â€¦ï¼ˆè©±ã—ã¦OKï¼‰";
  };

  recognition.onerror = (e) => {
    sttStatus.textContent = "ã‚¨ãƒ©ãƒ¼ï¼š" + (e.error || "ä¸æ˜");
  };

  recognition.onend = () => {
    sttRunning = false;
    sttBtn.textContent = "ğŸ“ æ–‡å­—èµ·ã“ã—ã‚’é–‹å§‹";
    sttStatus.textContent = "åœæ­¢ã—ã¾ã—ãŸï¼ˆä»»æ„æ©Ÿèƒ½ï¼‰";
  };

  recognition.onresult = (event) => {
    let interim = "";
    for(let i = event.resultIndex; i < event.results.length; i++){
      const transcript = event.results[i][0].transcript;
      if(event.results[i].isFinal){
        finalText += transcript + "\n";
      } else {
        interim += transcript;
      }
    }
    textarea.value = (finalText + interim).trim();
  };

  recognition.start();
}

/* =========================================================
   â‘¢ ç·åˆè©•ä¾¡
   ========================================================= */
function gentleEvaluate(text){
  const raw = (text || "").trim();
  const t = raw.replace(/\r\n/g, "\n").replace(/\n{3,}/g, "\n\n").trim();

  if(t.length < 10){
    return {
      score: 60,
      badges: ["å…¥åŠ›ãŒçŸ­ã‚"],
      message:
`ğŸŒŸ ç·åˆè©•ä¾¡ï¼š60ç‚¹

çŸ­ã„ãªãŒã‚‰ã‚‚ã€è©±ãã†ã¨ã™ã‚‹å§¿å‹¢ãŒã¨ã¦ã‚‚è‰¯ã„ã§ã™ã€‚

ã‚‚ã†1ã€œ2æ–‡ã ã‘è¶³ã—ã¦ã€
ã€Œä½•ã‚’ä¼ãˆãŸã„ã‹ï¼ˆçµè«–ï¼‰ã€ã‹ã€Œä¸€ç•ªå°è±¡ã«æ®‹ã£ãŸã“ã¨ã€ã‚’å…¥ã‚Œã‚‹ã¨ã€
ãã£ã¨ä¼ã‚ã‚Šã‚„ã™ããªã‚Šã¾ã™ğŸ˜Š`
    };
  }

  let score = 60;
  const goodPoints = [];
  const badges = [];
  const advice = [];

  const conclusion = ["çµè«–","è¦ã™ã‚‹ã«","ã¤ã¾ã‚Š","ä¸€è¨€ã§ã„ã†ã¨","ç§ã®è€ƒãˆã¯","åƒ•ã®è€ƒãˆã¯","ç§ã¯","åƒ•ã¯","å¤§äº‹ãªã®ã¯","é‡è¦ãªã®ã¯","ãƒã‚¤ãƒ³ãƒˆã¯","çµå±€","ä¸€ç•ªè¨€ã„ãŸã„ã®ã¯"];
  const reason = ["ãªãœãªã‚‰","ç†ç”±","èƒŒæ™¯","ã¨ã„ã†ã®ã‚‚","ãªãœã‹ã¨ã„ã†ã¨","ã ã‹ã‚‰ã“ã","ãªã®ã§","ã‹ã‚‰","ãŸã‚","ãŒã‚ã£ã¦"];
  const example = ["ä¾‹ãˆã°","ãŸã¨ãˆã°","å®Ÿéš›ã«","ã“ã®å‰","ä»¥å‰","å…ˆæ—¥","å…·ä½“çš„ã«","ä½“é¨“ã¨ã—ã¦","ãŸã¨ãˆã‚‹ã¨","ã“ã‚“ãªã“ã¨ãŒã‚ã£ã¦","ã®ã¨ã"];
  const summary = ["ã¾ã¨ã‚ã‚‹ã¨","çµè«–ã¨ã—ã¦","æœ€å¾Œã«","ã ã‹ã‚‰","ã¤ã¾ã‚Š","ãªã®ã§","ã¨ã„ã†ã‚ã‘ã§","è¦ã¯","ä»Šå¾Œã¯","æ¬¡ã¯","ã“ã‚Œã‹ã‚‰"];

  if(conclusion.some(w => t.includes(w))){
    score += 10; goodPoints.push("ãƒ†ãƒ¼ãƒï¼ˆä¸»å¼µï¼‰ãŒã¯ã£ãã‚Šã—ã¦ã„ã¾ã—ãŸ"); badges.push("ãƒ†ãƒ¼ãƒæ˜ç¢º");
  }
  if(reason.some(w => t.includes(w))){
    score += 10; goodPoints.push("ç†ç”±ã‚„èƒŒæ™¯ãŒä¼ã‚ã£ã¦ç´å¾—ã—ã‚„ã™ã‹ã£ãŸã§ã™"); badges.push("ç´å¾—æ„Ÿ");
  }
  if(example.some(w => t.includes(w))){
    score += 10; goodPoints.push("å…·ä½“ä¾‹ãŒã‚ã‚Šã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã‚„ã™ã‹ã£ãŸã§ã™"); badges.push("å…·ä½“æ€§");
  }
  if(summary.some(w => t.includes(w))){
    score += 10; goodPoints.push("æœ€å¾Œã®ç· ã‚ãƒ»ã¾ã¨ã‚ãŒè‰¯ãã€ä½™éŸ»ãŒæ®‹ã‚Šã¾ã—ãŸ"); badges.push("ç· ã‚ãŒè‰¯ã„");
  }

  if(t.length > 120){
    score += 5; goodPoints.push("å†…å®¹ã‚’ã—ã£ã‹ã‚Šè€ƒãˆã¦è©±ã—ã¦ã„ã‚‹ã®ãŒä¼ã‚ã‚Šã¾ã—ãŸ"); badges.push("å†…å®¹å……å®Ÿ");
  }

  const emotionWords = ["å¬‰ã—ã„","æ¥½ã—ã„","æ‚”ã—ã„","æ‚²ã—ã„","æ€–ã„","æ„Ÿå‹•","é©šã„ãŸ","ãƒ¯ã‚¯ãƒ¯ã‚¯","ãƒ¢ãƒ¤ãƒ¢ãƒ¤","è…¹ãŒç«‹ã£ãŸ","ã»ã£ã¨ã—ãŸ"];
  if(emotionWords.some(w => t.includes(w))){
    score += 5; goodPoints.push("æ„Ÿæƒ…ãŒå…¥ã£ã¦ã„ã¦ã€èãæ‰‹ã®å¿ƒã«å±Šãã‚„ã™ã„è©±ã—æ–¹ã§ã—ãŸ"); badges.push("æ„Ÿæƒ…ãŒä¼ã‚ã‚‹");
  }

  const listenerWords = ["ã‚ãªãŸ","ã¿ãªã•ã‚“","çš†ã•ã‚“","ç›¸æ‰‹","èãäºº","ä¼ãˆãŸã„","ãŠã™ã™ã‚","å…±æœ‰"];
  if(listenerWords.some(w => t.includes(w))){
    score += 5; goodPoints.push("èãæ‰‹ã‚’æ„è­˜ã—ãŸè¨€è‘‰é¸ã³ãŒã§ãã¦ã„ã¾ã—ãŸ"); badges.push("èãæ‰‹ç›®ç·š");
  }

  const hasConclusion = conclusion.some(w => t.includes(w));
  const hasReason = reason.some(w => t.includes(w));
  const hasExample = example.some(w => t.includes(w));
  const hasSummary = summary.some(w => t.includes(w));

  if(!hasExample){
    advice.push("å…·ä½“ä¾‹ã‚’ã€Œ1ã¤ã ã‘ã€å…¥ã‚Œã‚‹ã¨ã€ã•ã‚‰ã«ã‚°ãƒƒã¨ä¼ã‚ã‚Šã¾ã™ï¼ˆä¾‹ï¼šãã®æ™‚ã®å ´é¢ï¼å‡ºæ¥äº‹ï¼‰");
  } else if(!hasSummary){
    advice.push("æœ€å¾Œã«ä¸€è¨€ã ã‘ã€Œã¾ã¨ã‚ã€ã‚’ç½®ãã¨ã€èãæ‰‹ã®è¨˜æ†¶ã«æ®‹ã‚Šã‚„ã™ããªã‚Šã¾ã™");
  } else if(!hasReason){
    advice.push("ç†ç”±ã‚’ä¸€è¨€è¶³ã™ã¨èª¬å¾—åŠ›ãŒå¢—ã—ã¾ã™ï¼ˆä¾‹ï¼šãªãœãã†æ„Ÿã˜ãŸã‹ï¼‰");
  } else if(!hasConclusion){
    advice.push("å†’é ­ã‹æœ€å¾Œã«ã€Œä¸€ç•ªä¼ãˆãŸã„çµè«–ã€ã‚’ä¸€è¨€ç½®ãã¨ã€ã•ã‚‰ã«åˆ†ã‹ã‚Šã‚„ã™ããªã‚Šã¾ã™");
  }

  const praise = goodPoints.length
    ? goodPoints[Math.floor(Math.random() * goodPoints.length)]
    : "å‰å‘ãã«è©±ãã†ã¨ã—ã¦ã„ã‚‹å§¿å‹¢ãŒã¨ã¦ã‚‚è‰¯ã„ã§ã™";

  const improve = advice.length ? advice[0] : "ä»Šã®èª¿å­ã§ç¶šã‘ã¦ã„ãã¾ã—ã‚‡ã†";
  score = Math.min(score, 100);

  const finalBadges = badges.length ? badges : ["å‰å‘ã"];

  return {
    score,
    badges: finalBadges,
    adviceOne: improve,
    message:
`ğŸŒŸ ç·åˆè©•ä¾¡ï¼š${score}ç‚¹

ã¨ã¦ã‚‚è‰¯ã„ã‚¹ãƒ”ãƒ¼ãƒã§ã—ãŸã€‚

ç‰¹ã«ã€Œ${praise}ã€ç‚¹ãŒç´ æ™´ã‚‰ã—ã„ã§ã™ã€‚

ğŸ’¡ ã•ã‚‰ã«è‰¯ãã™ã‚‹ãªã‚‰ï¼š
${improve}

ã“ã‚Œã‹ã‚‰ã‚‚è‡ªä¿¡ã‚’æŒã£ã¦è©±ã—ã¦å¤§ä¸ˆå¤«ã§ã™ğŸ˜Š`
  };
}

/* =========================================================
   UI
   ========================================================= */
function runEvaluation(){
  const text = document.getElementById("speechText").value;
  const res = gentleEvaluate(text);

  const badgesEl = document.getElementById("badges");
  badgesEl.innerHTML = "";
  (res.badges || []).forEach(b => {
    const span = document.createElement("span");
    span.className = "pill";
    span.textContent = b;
    badgesEl.appendChild(span);
  });

  document.getElementById("result").textContent = res.message;

  // âœ… ç·´ç¿’ãƒ­ã‚°æ›´æ–°
  bumpPracticeCount();

  // âœ… ã€Œæ¬¡ã«ç›´ã™ç‚¹ã€å€™è£œã¨ã—ã¦ä¿å­˜ï¼ˆãƒœã‚¿ãƒ³ã§åæ˜ ã‚‚ã§ãã‚‹ï¼‰
  if(res.adviceOne){
    localStorage.setItem(LS.lastAdvice, res.adviceOne);
  }
}

function clearText(){
  document.getElementById("speechText").value = "";
  document.getElementById("badges").innerHTML = "";
  document.getElementById("result").textContent = "ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚";
}

function insertSample(){
  document.getElementById("speechText").value =
`æœ€è¿‘ã†ã‚Œã—ã‹ã£ãŸã“ã¨ã‚’è©±ã—ã¾ã™ã€‚
ã“ã®å‰ã€ä»•äº‹ã§æ–°äººã•ã‚“ãŒã€Œèª¬æ˜ãŒã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€ã¨è¨€ã£ã¦ãã‚Œã¾ã—ãŸã€‚
ã¨ã„ã†ã®ã‚‚ã€ç§ã¯æœ€åˆã«ç›¸æ‰‹ã®çŠ¶æ³ã‚’èã„ã¦ã‹ã‚‰èª¬æ˜ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã‹ã‚‰ã§ã™ã€‚
ä¾‹ãˆã°ã€æ‰‹é †ã‚’ä¸€æ°—ã«è¨€ã†ã®ã§ã¯ãªãã€ä»Šã®ä¸å®‰ã‚’ä¸€ã¤ãšã¤è§£æ¶ˆã™ã‚‹å½¢ã«ã—ã¾ã—ãŸã€‚
ãªã®ã§ã€ã“ã‚Œã‹ã‚‰ã‚‚ç›¸æ‰‹ç›®ç·šã§ä¼ãˆã‚‹ã“ã¨ã‚’å¤§äº‹ã«ã—ãŸã„ã§ã™ã€‚`;
  runEvaluation();
}

/* =========================================================
   æŒ¯ã‚Šè¿”ã‚Šãƒãƒ¼ãƒˆ
   ========================================================= */
function saveReflection(){
  localStorage.setItem(LS.reflectGood, (document.getElementById("reflectGood").value || "").trim());
  localStorage.setItem(LS.reflectNext, (document.getElementById("reflectNext").value || "").trim());
  alert("ä¿å­˜ã—ã¾ã—ãŸğŸ˜Š");
}

function loadReflection(){
  document.getElementById("reflectGood").value = localStorage.getItem(LS.reflectGood) || "";
  document.getElementById("reflectNext").value = localStorage.getItem(LS.reflectNext) || "";
  alert("å‰å›ã®æŒ¯ã‚Šè¿”ã‚Šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸğŸ˜Š");
}

function clearReflection(){
  document.getElementById("reflectGood").value = "";
  document.getElementById("reflectNext").value = "";
}

function setNextFromAdvice(){
  const adv = localStorage.getItem(LS.lastAdvice);
  if(!adv){
    alert("ã¾ãšAIè©•ä¾¡ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ğŸ˜Š");
    return;
  }
  const next = document.getElementById("reflectNext");
  next.value = adv;
  next.focus();
  window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
}

/* =========================================================
   çµæœã‚³ãƒ”ãƒ¼
   ========================================================= */
async function copyResult(){
  const txt = document.getElementById("result").textContent || "";
  try{
    await navigator.clipboard.writeText(txt);
    alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸğŸ˜Š");
  }catch(e){
    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ãŒä½¿ãˆãªã„ç’°å¢ƒå‘ã‘
    prompt("ã‚³ãƒ”ãƒ¼ã§ããªã„å ´åˆã¯ã€ã“ã“ã‹ã‚‰æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ğŸ‘‡", txt);
  }
}

/* åˆæœŸï¼šå‰å›ã®æŒ¯ã‚Šè¿”ã‚Šã‚’è»½ãå¾©å…ƒï¼ˆä»»æ„ï¼‰ */
(function init(){
  // ä½•ã‚‚å…¥ã£ã¦ã„ãªã„æ™‚ã ã‘ã€å‰å›åˆ†ã‚’è–„ãæ®‹ã—ã¦ãŠãï¼ˆé‚ªé­”ãªã‚‰æ¶ˆã—ã¦OKï¼‰
  const g = localStorage.getItem(LS.reflectGood) || "";
  const n = localStorage.getItem(LS.reflectNext) || "";
  if(g) document.getElementById("reflectGood").value = g;
  if(n) document.getElementById("reflectNext").value = n;
})();
</script>

</body>
</html>