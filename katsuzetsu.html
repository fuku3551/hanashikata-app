<!doctype html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ğŸ‘„ æ»‘èˆŒç·´ç¿’ï¼ˆä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼‰</title>
<link rel="stylesheet" href="style.css" />

<style>
  /* ===== å…¨ä½“ ===== */
  #phraseBody{
    font-size:32px;
    font-weight:900;
    text-align:center;
    line-height:1.9;
    white-space:pre-wrap;
  }

  ruby rt{ font-size:0.55em; opacity:0.85; }

  .row{
    display:flex;
    gap:10px;
    justify-content:center;
    flex-wrap:wrap;
    align-items:center;
  }

  .mini{
    font-size:14px;
    opacity:0.85;
    line-height:1.7;
    white-space:pre-wrap;
  }

  /* ===== ã‚«ãƒ©ã‚ªã‚±ï¼šrubyå¯¾å¿œãƒ¦ãƒ‹ãƒƒãƒˆ ===== */
  .karaUnit{
    display:inline-block;
    padding:2px 4px;
    border-radius:8px;
    transition:.12s;
  }
  .karaUnit.active{
    background:#ffdddd;
    color:#d60000;
  }
  .karaUnit.done{ opacity:.45; }
  .karaUnit.skip{
    background:transparent !important;
    color:inherit !important;
    opacity:1;
  }

  /* é›£èªã¯ã€Œå…¨ä½“ã‚’ç‚¹ç¯ã€ã™ã‚‹ã®ã§ã€phraseBodyè‡ªä½“ã«ã‚‚è‰²ä»˜ã‘ */
  .hardAllOn{
    background:#ffdddd;
    color:#d60000;
    border-radius:12px;
    padding:6px 8px;
    display:inline-block;
  }

  /* ===== èª­ã¿ä¸Šã’ä½ç½®ï¼ˆå›ºå®šè¡¨ç¤ºï¼‰ ===== */
  .readStage{
    position: sticky;
    top: var(--readTop, 220px);
    z-index: 5;
  }
  .readBox{
    border:1px solid rgba(0,0,0,.18);
    border-radius:14px;
    padding:12px;
    background: rgba(255,255,255,.92);
    backdrop-filter: blur(4px);
  }

  input[type=range]{ width:240px; }

  /* ===== ãƒœã‚¿ãƒ³ï¼šå¤§ãã‚ ===== */
  .controls{
    position:relative;
    z-index:10;
  }
  .bigBtn{
    font-size:18px;
    font-weight:900;
    padding:16px 18px;
    border-radius:14px;
    border:1px solid rgba(0,0,0,.12);
    background:#fff;
    min-width:150px;
    box-shadow:0 6px 18px rgba(0,0,0,.06);
    -webkit-tap-highlight-color: rgba(0,0,0,0);
  }
  .bigBtn:active{ transform: scale(.98); }
  .primary{ background:#0ea5e9; color:#fff; border:none; }
  .danger{ background:#ef4444; color:#fff; border:none; }
  .ghost{ background:#fff; }
  .warn{ background:#111; color:#fff; border:none; }
  .disabled{ opacity:.45; }

  /* ===== ä¸‹æ®µï¼šã‚¢ãƒ‰ãƒã‚¤ã‚¹æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« ===== */
  .marqueeBox{
    width:100%;
    overflow:hidden;
    border-radius:12px;
    border:1px solid rgba(0,0,0,.12);
    background:rgba(255,255,255,.85);
    padding:8px 10px;
    box-sizing:border-box;
  }
  .marquee{
    display:inline-block;
    white-space:nowrap;
    will-change:transform;
    animation: marqueeMove 11s linear infinite;
    font-weight:900;
    font-size:16px;
  }
  @keyframes marqueeMove{
    0%{ transform: translateX(100%); }
    100%{ transform: translateX(-100%); }
  }
  .marquee.paused{ animation-play-state: paused; }

  /* è¦‹å‡ºã—è£œåŠ© */
  .subHeader{
    text-align:center;
    font-size:14px;
    opacity:.85;
    margin-top:-6px;
  }
</style>
</head>

<body>

<header class="top">
  <h1>ğŸ‘„ æ»‘èˆŒç·´ç¿’</h1>
  <p><a href="index.html">â† ãƒ›ãƒ¼ãƒ ã¸</a></p>
</header>

<main class="menu">

  <!-- âœ… ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼ˆä¸Šéƒ¨ã‚’åˆ†ã‹ã‚Šã‚„ã™ãï¼‰ -->
  <div class="card">
    <div class="title">ğŸ”° ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼ˆç´„2ã€œ3åˆ†ï¼‰</div>
    <div class="desc">
      <div id="dailyText" class="mini">èª­ã¿è¾¼ã¿ä¸­â€¦</div>

      <!-- âœ… ã“ã“ã§èª­ã¿ä¸Šã’ä½ç½®ã‚’è¨­å®š -->
      <div style="margin-top:12px;">
        <div class="mini" style="text-align:center;font-weight:900;">ğŸ“ èª­ã¿ä¸Šã’ä½ç½®ï¼ˆä¸Šä¸‹èª¿æ•´ï¼‰</div>
        <div class="row" style="margin-top:8px;">
          <span class="mini">ä¸Š</span>
          <input id="readPosRange" type="range" min="80" max="420" value="220" />
          <span class="mini">ä¸‹</span>
          <span class="mini" id="readPosLabel">220px</span>
        </div>
        <div class="subHeader">â€» èª­ã‚€å ´æ‰€ã‚’ã€Œç›®ç·šã®é«˜ã•ã€ã«åˆã‚ã›ã‚‹ã¨ç–²ã‚Œã«ãã„ã§ã™</div>
      </div>
    </div>
  </div>

  <!-- âœ… æ“ä½œãƒœã‚¿ãƒ³ï¼ˆå¤§ãããƒ»èª­ã¿ä¸Šã’ä½ç½®ã‚ˆã‚Šä¸‹ï¼‰ -->
  <div class="card">
    <div class="title">æ“ä½œ</div>
    <div class="desc controls">
      <div class="row">
        <button id="playBtn"  class="bigBtn primary" type="button">â–¶ é–‹å§‹</button>
        <button id="pauseBtn" class="bigBtn ghost"   type="button">â¸ ä¸€æ™‚åœæ­¢</button>
        <button id="stopBtn"  class="bigBtn danger"  type="button">â¹ åœæ­¢</button>
        <button id="skipBtn"  class="bigBtn warn"    type="button">â­ ã‚¹ã‚­ãƒƒãƒ—</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="autoBtn" class="bigBtn ghost" type="button">è‡ªå‹•OFF</button>
        <button id="karaBtn" class="bigBtn ghost" type="button">ğŸŒˆ ON</button>
        <button id="shuffleBtn" class="bigBtn ghost" type="button">ğŸ² ãƒŸãƒƒã‚·ãƒ§ãƒ³å¤‰æ›´</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <span class="mini" style="font-weight:900;">é€Ÿåº¦</span>
        <input id="speedRange" type="range" min="250" max="1000" value="700" />
        <span class="mini" id="speedLabel">700ms</span>
      </div>

      <div class="mini" style="margin-top:8px; text-align:center;">
        ãƒ»é€šå¸¸ï¼š1ãƒ¦ãƒ‹ãƒƒãƒˆ=0.7ç§’ï¼ˆãŠã™ã™ã‚ï¼‰<br>
        ãƒ»é›£èªï¼š1ãƒ•ãƒ¬ãƒ¼ã‚º=3ç§’ã§è‡ªå‹•åˆ‡æ›¿ï¼ˆå…¨æ–‡ç‚¹ç¯ï¼‰
      </div>
    </div>
  </div>

  <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <div class="card">
    <div class="title">ã‚»ã‚¯ã‚·ãƒ§ãƒ³</div>
    <div class="desc row">
      <button class="bigBtn ghost" type="button" onclick="setSection(0)">â‘ æ¯éŸ³</button>
      <button class="bigBtn ghost" type="button" onclick="setSection(1)">â‘¡åŸºæœ¬</button>
      <button class="bigBtn ghost" type="button" onclick="setSection(2)">â‘¢æ¿éŸ³</button>
      <button class="bigBtn ghost" type="button" onclick="setSection(3)">â‘£æ‹—éŸ³</button>
      <button class="bigBtn ghost" type="button" onclick="setSection(4)">â‘¤ãƒªã‚ºãƒ </button>
      <button class="bigBtn ghost" type="button" onclick="setSection(5)">â‘¥é›£èª</button>
    </div>
  </div>

  <!-- è¡¨ç¤º -->
  <div class="card readStage" id="readStage">
    <div class="title" id="sectionTitle"></div>
    <div class="desc">
      <div style="text-align:center;">
        <span id="counter" class="mini"></span>
      </div>

      <div class="readBox">
        <div id="phraseBody"></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="bigBtn ghost" type="button" onclick="prev()">â—€ å‰</button>
        <button class="bigBtn ghost" type="button" onclick="next()">â–¶ æ¬¡</button>
        <button class="bigBtn ghost" type="button" onclick="rand()">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ </button>
        <button class="bigBtn ghost" type="button" onclick="reset()">âŸ² ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>
  </div>

  <!-- âœ… ä¸‹æ®µï¼šãƒ¯ãƒ³ãƒã‚¤ãƒ³ãƒˆã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼ˆè‡ªå‹•æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ -->
  <div class="card">
    <div class="title">ãƒ¯ãƒ³ãƒã‚¤ãƒ³ãƒˆ</div>
    <div class="desc">
      <div class="marqueeBox">
        <span id="adviceMarquee" class="marquee">èª­ã¿è¾¼ã¿ä¸­â€¦</span>
      </div>
    </div>
  </div>

</main>

<script>
/* =========================
   ãƒ‡ãƒ¼ã‚¿
========================= */

// â‘  æ¯éŸ³ï¼ˆå¢—é‡ï¼‰
const p1 = [
  "ã‚ã„ã†ãˆãŠ",
  "ã‚ãˆã„ã†ãˆãŠã‚ãŠ",
  "ã‚ã„ã†ãˆãŠã‚ãŠ",
  "ã‚ãŠã‚ãˆã„ã†ãˆãŠ",
  "ã‚ã„ã†ãˆãŠã‚ã„ã†ãˆãŠ",
  "ã‚ãƒ¼ã„ãƒ¼ã†ãƒ¼ãˆãƒ¼ãŠãƒ¼ï¼ˆã‚†ã£ãã‚Šï¼‰",
  "ã‚ã€€ã„ã€€ã†ã€€ãˆã€€ãŠï¼ˆ1éŸ³ãšã¤ï¼‰",
  "ã‚ã„ã†ãˆãŠã‚ãˆã†",
  "ã‚ã„ã†ãˆãŠã‚ã„ã†ãˆãŠ",
  "ã‚ãˆã„ã†ãˆãŠã‚ãŠ",
  "ã‚ãŠã‚ãŠã‚ãˆã„ãˆã†ãˆãŠã†",
  "ã‚ã„ã†ãˆãŠãŠãˆã†ã„ã‚"
];

// â‘¡ è¡Œåˆ¥åŸºæœ¬
const p2 = [
  "ï¼ˆã‚è¡Œï¼‰ ã‚ã€€ã„ã€€ã†ã€€ãˆã€€ãŠ",
  "ã‚ãˆã„ã€€ã†ãˆãŠã€€ã‚ãŠ",
  "ï¼ˆã‹è¡Œï¼‰ ã‹ã€€ãã€€ãã€€ã‘ã€€ã“",
  "ã‹ããã‘ã“ã€€ã‹ã‘ã“ã€€ããã‘",
  "ï¼ˆã•è¡Œï¼‰ ã•ã€€ã—ã€€ã™ã€€ã›ã€€ã",
  "ã•ã—ã™ã›ãã€€ã•ã›ãã€€ã—ã™ã›",
  "ï¼ˆãŸè¡Œï¼‰ ãŸã€€ã¡ã€€ã¤ã€€ã¦ã€€ã¨",
  "ãŸã¡ã¤ã¦ã¨ã€€ãŸã¦ã¨ã€€ã¡ã¤ã¦",
  "ï¼ˆãªè¡Œï¼‰ ãªã€€ã«ã€€ã¬ã€€ã­ã€€ã®",
  "ãªã«ã¬ã­ã®ã€€ãªã­ã®ã€€ã«ã¬ã­",
  "ï¼ˆã¯è¡Œï¼‰ ã¯ã€€ã²ã€€ãµã€€ã¸ã€€ã»",
  "ã¯ã²ãµã¸ã»ã€€ã¯ã¸ã»ã€€ã²ãµã¸",
  "ï¼ˆã¾è¡Œï¼‰ ã¾ã€€ã¿ã€€ã‚€ã€€ã‚ã€€ã‚‚",
  "ã¾ã¿ã‚€ã‚ã‚‚ã€€ã¾ã‚ã‚‚ã€€ã¿ã‚€ã‚",
  "ï¼ˆã‚„è¡Œï¼‰ ã‚„ã€€ã‚†ã€€ã‚ˆ",
  "ã‚„ã‚†ã‚ˆã€€ã‚†ã‚ˆã‚„ã€€ã‚ˆã‚„ã‚†",
  "ï¼ˆã‚‰è¡Œï¼‰ ã‚‰ã€€ã‚Šã€€ã‚‹ã€€ã‚Œã€€ã‚",
  "ã‚‰ã‚Šã‚‹ã‚Œã‚ã€€ã‚‰ã‚Œã‚ã€€ã‚Šã‚‹ã‚Œ",
  "ï¼ˆã‚è¡Œï¼‰ ã‚ã€€ã‚’ã€€ã‚“",
  "ã‚ã‚’ã‚“ã€€ã‚ã‚“ã‚’ã€€ã‚’ã‚ã‚“"
];

// â‘¢ æ¿éŸ³ãƒ»åŠæ¿éŸ³
const p3 = [
  "ãŒããã’ã”ã€€ãŒã’ã”ã€€ããã’",
  "ã–ã˜ãšãœãã€€ã–ãœãã€€ã˜ãšãœ",
  "ã ã¢ã¥ã§ã©ã€€ã ã§ã©ã€€ã¢ã¥ã§",
  "ã°ã³ã¶ã¹ã¼ã€€ã°ã¹ã¼ã€€ã³ã¶ã¹",
  "ã±ã´ã·ãºã½ã€€ã±ãºã½ã€€ã´ã·ãº"
];

// â‘£ æ‹—éŸ³
const p4 = [
  "ãã‚ƒãã‚…ãã‚‡ã€€ãã‚ƒããã‚‡ã€€ãã‚…ãã‚‡ãã‚ƒ",
  "ã—ã‚ƒã—ã‚…ã—ã‚‡ã€€ã—ã‚ƒãã—ã‚‡ã€€ã—ã‚…ã—ã‚‡ã—ã‚ƒ",
  "ã¡ã‚ƒã¡ã‚…ã¡ã‚‡ã€€ã¡ã‚ƒãã¡ã‚‡ã€€ã¡ã‚…ã¡ã‚‡ã¡ã‚ƒ",
  "ã«ã‚ƒã«ã‚…ã«ã‚‡ã€€ã«ã‚ƒãã«ã‚‡ã€€ã«ã‚…ã«ã‚‡ã«ã‚ƒ",
  "ã²ã‚ƒã²ã‚…ã²ã‚‡ã€€ã²ã‚ƒãã²ã‚‡ã€€ã²ã‚…ã²ã‚‡ã²ã‚ƒ",
  "ã¿ã‚ƒã¿ã‚…ã¿ã‚‡ã€€ã¿ã‚ƒãã¿ã‚‡ã€€ã¿ã‚…ã¿ã‚‡ã¿ã‚ƒ",
  "ã‚Šã‚ƒã‚Šã‚…ã‚Šã‚‡ã€€ã‚Šã‚ƒãã‚Šã‚‡ã€€ã‚Šã‚…ã‚Šã‚‡ã‚Šã‚ƒ"
];

// â‘¤ ãƒªã‚ºãƒ 
const p5 = [
  "ãŸãŸãŸã€€ã¦ã¦ã¦ã€€ã¨ã¨ã¨",
  "ã‹ã‹ã‹ã€€ãããã€€ããã",
  "ã•ã•ã•ã€€ã—ã—ã—ã€€ã™ã™ã™",
  "ã‚‰ã‚‰ã‚‰ã€€ã‚Šã‚Šã‚Šã€€ã‚‹ã‚‹ã‚‹"
];

/* âœ… â‘¥ é›£èªï¼šè¢«ã‚‰ãªã„20å€‹ï¼ˆ1ãƒ•ãƒ¬ãƒ¼ã‚º3ç§’ã§åˆ‡æ›¿ã€2è¡Œã‚‚OKï¼‰ */
const p6 = [
  "ã™ã‚‚ã‚‚ã‚‚ã‚‚ã‚‚ã‚‚ã‚‚ã‚‚ã®ã†ã¡\nã‚‚ã‚‚ã‚‚ã™ã‚‚ã‚‚ã‚‚ã‚‚ã‚‚ã®ã†ã¡",
  "åŠä¸»ãŒå±é¢¨ã«ä¸Šæ‰‹ã«åŠä¸»ã®çµµã‚’æã„ãŸ",
  "ã‚«ã‚¨ãƒ«ã´ã‚‡ã“ã´ã‚‡ã“ä¸‰ã´ã‚‡ã“ã´ã‚‡ã“\nåˆã‚ã›ã¦ã´ã‚‡ã“ã´ã‚‡ã“å…­ã´ã‚‡ã“ã´ã‚‡ã“",
  "é’ãƒ‘ã‚¸ãƒ£ãƒèµ¤ãƒ‘ã‚¸ãƒ£ãƒé»„ãƒ‘ã‚¸ãƒ£ãƒ",
  "éš£ã®ç«¹å£ã«ç«¹ç«‹ã¦ã‹ã‘ãŸã®ã¯\nç«¹ç«‹ã¦ã‹ã‘ãŸã‹ã£ãŸã‹ã‚‰ã ",
  "ã“ã®é‡˜å¼•ãæŠœãã«ãã„é‡˜\nå¼•ãæŠœãã«ãã„é‡˜ã ",
  "å³ç›®å³è€³å³è‚©å³è…•\nå·¦ç›®å·¦è€³å·¦è‚©å·¦è…•",
  "æ–°é€²ã‚·ãƒ£ãƒ³ã‚½ãƒ³æ­Œæ‰‹ç·å‡ºæ¼”\næ–°æ˜¥ã‚·ãƒ£ãƒ³ã‚½ãƒ³ã‚·ãƒ§ãƒ¼",
  "æ—©æœé€è¿è»Šå•†ç¤¾é§è»Šå ´é›†åˆ",
  "èª¿æŸ»ä¸»ä»»ã€è«¸æ‰€è¦–å¯Ÿã—æ‰€æ„Ÿæ›¸è¨˜",
  "è²¨ç‰©å®¢å®¤ã€å„å®¢ãŒå®¢å¸­ç¢ºä¿",
  "æ²¹å£²ã‚ŠãŒæ²¹ã‚’å£²ã‚‹é–“ã«\nå£²ä¸ŠãŒã†ã£ã‹ã‚Šè½ã¡ã‚‹",
  "ç‰¹è£½ç‚­é…¸æ°´ã€ç¬é–“é…¸æ¬ å¯¸å‰",
  "éš™é–“éš™é–“ã«ã™ãç„¼ãã®å…·ã‚’\nã™ãã™ãè©°ã‚ã‚‹",
  "ãƒãƒŠãƒŠã®è¬ã¯ã¾ã ãªãã \nè¬ãªã‚‰è¬ã¨åä¹—ã‚Œ",
  "é€£ç¶šæœ—èª­ã€è«–ç†è«–è¿°ã€æœ—æœ—è«–",
  "æ€¥é½ä¼‘æš‡ã€ç©¶æ¥µç´šã®ä¾›çµ¦ä¸è¶³",
  "å®¢å¸­é€†ã•ã€é€†èµ°å®¢ãŒæ€¥åŠ é€Ÿ",
  "æœ´è¨¥ãªç‰§ç«¥ã€åŒ—æ–—ã®æœ¨åˆ€ç‰¹è¨“",
  "ç™ºæ³¡ç™ºé…µã€ç™½æ³¡ç™ºç”Ÿã€åå¾©ç™ºè©±"
];

const sections = [
  {t:"â‘ æ¯éŸ³", d:p1, isHtml:false},
  {t:"â‘¡åŸºæœ¬", d:p2, isHtml:false},
  {t:"â‘¢æ¿éŸ³", d:p3, isHtml:false},
  {t:"â‘£æ‹—éŸ³", d:p4, isHtml:false},
  {t:"â‘¤ãƒªã‚ºãƒ ", d:p5, isHtml:false},
  {t:"â‘¥é›£èª", d:p6, isHtml:false}, // âœ… é›£èªã¯ã€Œå…¨æ–‡ç‚¹ç¯ï¼‹3ç§’åˆ‡æ›¿ã€ãªã®ã§HTMLä¸è¦
];

let sec = 0;
let idx = 0;

/* ===== è¨­å®š ===== */
let auto = false;     // è‡ªå‹•ã§æ¬¡ã¸
let kara = true;      // è‰²ä»˜ã‘
let speed = 700;      // é€šå¸¸ï¼š1ãƒ¦ãƒ‹ãƒƒãƒˆ0.7ç§’
let timer = null;     // karaoke interval
let isPlaying = false;
let paused = false;

/* ===== ãƒ¯ãƒ³ãƒã‚¤ãƒ³ãƒˆï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ¥ï¼‰ ===== */
const adviceMap = {
  0: "â‘ æ¯éŸ³ï¼šå£ã‚’â€œç¸¦ã«å¤§ããâ€é–‹ã‘ã¦ã€ã‚â†’ã„â†’ã†â†’ãˆâ†’ãŠ ã‚’ä¸å¯§ã«ã€‚å£°ã¯å°ã•ãã¦ã‚‚OKã€‚",
  1: "â‘¡åŸºæœ¬ï¼šå­éŸ³â†’æ¯éŸ³ã‚’ã‚»ãƒƒãƒˆã§ã€‚ã€ã‹ã€ã¯â€œkâ€ã‚’å½“ã¦ã¦ã‹ã‚‰â€œaâ€ã¸ã€‚æ€¥ãŒãšæ­£ç¢ºã«ã€‚",
  2: "â‘¢æ¿éŸ³ï¼šå¼·ãå½“ã¦ã™ããªã„ã€‚å–‰ã«åŠ›ã‚’å…¥ã‚Œãšâ€œã‚„ã‚ã‚‰ã‹ã„æ¿ã‚Šâ€ã‚’æ„è­˜ã€‚",
  3: "â‘£æ‹—éŸ³ï¼šãã‚ƒï¼ã€ãã€ï¼‹å°ã•ã„ã€ã‚ƒã€ã‚’â€œã²ã¨å›ºã¾ã‚Šâ€ã§ã€‚åˆ†ã‘ãšã«ä¸€æ¯ã§ã€‚",
  4: "â‘¤ãƒªã‚ºãƒ ï¼šåŒã˜å½¢ã§å£ã‚’å‹•ã‹ã™ã€‚ãƒ†ãƒ³ãƒã‚ˆã‚Šâ€œç­‰é–“éš”â€ãŒå¤§äº‹ï¼ˆãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ æ„Ÿè¦šï¼‰ã€‚",
  5: "â‘¥é›£èªï¼šé€Ÿã•ã‚ˆã‚Šæ­£ç¢ºã•ã€‚å™›ã‚“ã ã‚‰ä¸€å›æ­¢ã‚ã¦ã€æœ€åˆã®3æ–‡å­—ã ã‘å®Œç’§ã«ã—ã¦å†é–‹ã€‚"
};

/* =========================
  âœ… ãƒ¦ãƒ‹ãƒƒãƒˆåŒ–ï¼ˆé€šå¸¸ç”¨ï¼‰
   - æ‹—éŸ³ï¼ˆå°æ–‡å­—ï¼‰ã‚’å‰ã®æ–‡å­—ã¨åˆä½“
   - ç©ºç™½ã¯skip
   - ï¼ˆï¼‰ã¯è¡¨ç¤ºã‹ã‚‰é™¤å¤–
========================= */
function buildUnits(text){
  const small = "ã‚ƒã‚…ã‚‡ããƒã…ã‡ã‰";
  let arr = [];
  let buf = "";
  let inParen = false;

  for(const c of text){
    if(c === "ï¼ˆ"){ inParen = true; continue; }
    if(c === "ï¼‰"){ inParen = false; continue; }
    if(inParen) continue;

    if(/\s/.test(c)){
      if(buf){ arr.push({t:buf}); buf=""; }
      arr.push({t:c, skip:true});
      continue;
    }

    if(small.includes(c)){
      buf += c;
      continue;
    }else{
      if(buf) arr.push({t:buf});
      buf = c;
    }
  }
  if(buf) arr.push({t:buf});
  return arr;
}

/* ===== DOM ===== */
const phraseBody = document.getElementById("phraseBody");
const sectionTitle = document.getElementById("sectionTitle");
const counter = document.getElementById("counter");

const dailyText = document.getElementById("dailyText");
const adviceMarquee = document.getElementById("adviceMarquee");

const playBtn = document.getElementById("playBtn");
const pauseBtn = document.getElementById("pauseBtn");
const stopBtn = document.getElementById("stopBtn");
const skipBtn = document.getElementById("skipBtn");
const autoBtn = document.getElementById("autoBtn");
const karaBtn = document.getElementById("karaBtn");
const shuffleBtn = document.getElementById("shuffleBtn");

const speedRange = document.getElementById("speedRange");
const speedLabel = document.getElementById("speedLabel");

const readStage = document.getElementById("readStage");
const readPosRange = document.getElementById("readPosRange");
const readPosLabel = document.getElementById("readPosLabel");

/* ===== è¡¨ç¤º ===== */
function updateAdvice(){
  const txt = adviceMap[sec] || "å£ã‚’å¤§ããã€ã‚†ã£ãã‚Šã€ã¯ã£ãã‚Šã€‚";
  adviceMarquee.textContent = txt + "ã€€ï¼ã€€" + txt; // é€”åˆ‡ã‚Œæ„Ÿã‚’æ¸›ã‚‰ã™ãŸã‚2å›ã¤ãªã

  // iPhoneã§ç¢ºå®Ÿã«æ›´æ–°ï¼ˆã‚¢ãƒ‹ãƒ¡å†ã‚¹ã‚¿ãƒ¼ãƒˆï¼‰
  adviceMarquee.style.animation = "none";
  void adviceMarquee.offsetWidth;
  adviceMarquee.style.animation = "";
}

function render(){
  const s = sections[sec];
  sectionTitle.textContent = s.t;
  counter.textContent = (idx+1) + "/" + s.d.length;

  const text = s.d[idx];

  phraseBody.classList.remove("hardAllOn");

  if(kara){
    renderKara(text);
  }else{
    phraseBody.textContent = text;
  }

  updateAdvice();
}

function renderKara(text){
  phraseBody.innerHTML = "";
  const units = buildUnits(text);

  units.forEach(u=>{
    const sp = document.createElement("span");
    sp.className = "karaUnit";
    if(u.skip){
      sp.classList.add("skip");
      sp.textContent = u.t;
    }else{
      sp.textContent = u.t;
    }
    phraseBody.appendChild(sp);
  });
}

/* =========================
   å†ç”Ÿ/åœæ­¢/ä¸€æ™‚åœæ­¢
========================= */
function clearTimers(){
  if(timer){
    clearInterval(timer);
    timer = null;
  }
}

function stopKaraVisual(){
  document.querySelectorAll(".karaUnit").forEach(s=>{
    s.classList.remove("active","done");
  });
  phraseBody.classList.remove("hardAllOn");
}

function stopAll(){
  isPlaying = false;
  paused = false;
  pauseBtn.textContent = "â¸ ä¸€æ™‚åœæ­¢";
  clearTimers();
  stopKaraVisual();
}

/* ===== é€šå¸¸ï¼ˆãƒ¦ãƒ‹ãƒƒãƒˆé †ç‚¹ç¯ï¼‰ ===== */
let playIndex = 0; // é€”ä¸­åœæ­¢â†’å†é–‹ã§ä½¿ã†

function startNormal(){
  if(!kara) return;

  clearTimers();

  const spans = Array.from(document.querySelectorAll(".karaUnit"))
    .filter(sp=>!sp.classList.contains("skip"));

  if(spans.length === 0) return;

  timer = setInterval(()=>{
    if(!isPlaying) return;
    if(paused) return;

    if(playIndex > 0){
      spans[playIndex-1].classList.remove("active");
      spans[playIndex-1].classList.add("done");
    }

    if(playIndex >= spans.length){
      clearTimers();
      if(auto){
        setTimeout(()=> next(true), 420);
      }else{
        isPlaying = false;
      }
      return;
    }

    spans[playIndex].classList.add("active");
    playIndex++;
  }, speed);
}

/* ===== é›£èªï¼ˆå…¨æ–‡ç‚¹ç¯ï¼‹3ç§’ã§æ¬¡ã¸ï¼‰ ===== */
let hardTimeout = null;
function clearHardTimeout(){
  if(hardTimeout){
    clearTimeout(hardTimeout);
    hardTimeout = null;
  }
}

function startHard(){
  // é›£èªã¯ã€Œå…¨æ–‡ç‚¹ç¯ã€â†’3ç§’â†’æ¬¡ã¸
  clearTimers();
  clearHardTimeout();
  stopKaraVisual();

  phraseBody.classList.add("hardAllOn");

  // å…¨ãƒ¦ãƒ‹ãƒƒãƒˆã‚‚activeã«ã—ã¦ãŠãï¼ˆè¦‹ãŸç›®å¼·åŒ–ï¼‰
  document.querySelectorAll(".karaUnit").forEach(sp=>{
    if(!sp.classList.contains("skip")){
      sp.classList.add("active");
    }
  });

  hardTimeout = setTimeout(()=>{
    if(!isPlaying) return;
    if(paused){
      // pausedãªã‚‰ã“ã“ã§ã¯é€²ã‚ãªã„ã€‚å†é–‹æ™‚ã«å†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã™ã‚‹
      return;
    }
    next(true); // è‡ªå‹•çš„ã«æ¬¡ã¸
  }, 3000);
}

/* ===== å†ç”Ÿé–‹å§‹ ===== */
function startPlay(){
  stopKaraVisual();
  clearTimers();
  clearHardTimeout();

  isPlaying = true;
  paused = false;
  pauseBtn.textContent = "â¸ ä¸€æ™‚åœæ­¢";

  playIndex = 0;

  // é›£èªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ç‰¹åˆ¥ãƒ«ãƒ¼ãƒ«
  if(sec === 5){
    // kara OFFã§ã‚‚é›£èªã¯3ç§’åˆ‡æ›¿ãŒæ¬²ã—ã„ã®ã§ã€karaãŒOFFãªã‚‰å…¨æ–‡ç‚¹ç¯ãªã—ã§åˆ‡æ›¿
    if(kara){
      startHard();
    }else{
      clearHardTimeout();
      hardTimeout = setTimeout(()=>{ if(isPlaying && !paused) next(true); }, 3000);
    }
    return;
  }

  if(kara){
    startNormal();
  }
}

function togglePause(){
  if(!isPlaying) return;
  paused = !paused;
  pauseBtn.textContent = paused ? "â–¶ å†é–‹" : "â¸ ä¸€æ™‚åœæ­¢";

  // é›£èªã®ã¨ãï¼špausedè§£é™¤ã§å†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
  if(sec === 5 && !paused && isPlaying){
    // 3ç§’åˆ‡æ›¿ã‚’â€œå†é–‹æ™‚ç‚¹ã‹ã‚‰â€ã‚„ã‚Šç›´ã™æ–¹ãŒåˆå¿ƒè€…ã«å„ªã—ã„
    if(kara) startHard();
    else{
      clearHardTimeout();
      hardTimeout = setTimeout(()=>{ if(isPlaying && !paused) next(true); }, 3000);
    }
  }
}

/* =========================
   æ“ä½œï¼ˆæ¬¡/å‰/ãƒ©ãƒ³ãƒ€ãƒ /ãƒªã‚»ãƒƒãƒˆï¼‰
   - next(true) ã¯ã€Œè‡ªå‹•çµŒç”±ã€æ‰±ã„ï¼ˆæ­¢ã‚ãšã«ç¶šã‘ã‚‹ï¼‰
========================= */
function setSection(n){
  sec = n;
  idx = 0;
  stopAll();
  render();
}

function next(fromAuto=false){
  idx = (idx + 1) % sections[sec].d.length;
  stopKaraVisual();
  clearTimers();
  clearHardTimeout();
  render();

  if(fromAuto && isPlaying){
    // ç¶™ç¶šå†ç”Ÿ
    if(sec === 5){
      if(kara) startHard();
      else hardTimeout = setTimeout(()=>{ if(isPlaying && !paused) next(true); }, 3000);
    }else{
      playIndex = 0;
      startNormal();
    }
  }else{
    // æ‰‹å‹•nextã®ã¨ãï¼šè‡ªå‹•ONãªã‚‰ç¶™ç¶š
    if(auto && isPlaying){
      startPlay();
    }
  }
}

function prev(){
  idx = (idx - 1 + sections[sec].d.length) % sections[sec].d.length;
  stopAll();
  render();
}

function rand(){
  idx = Math.floor(Math.random() * sections[sec].d.length);
  stopAll();
  render();
}

function reset(){
  idx = 0;
  stopAll();
  render();
}

/* ã‚¹ã‚­ãƒƒãƒ—ï¼šå†ç”Ÿä¸­ã¯å³æ¬¡ã¸ / åœæ­¢ä¸­ãªã‚‰æ¬¡è¡¨ç¤ºã ã‘ */
function skip(){
  if(isPlaying){
    next(true);
  }else{
    next(false);
  }
}

/* =========================
   ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³
   æŒ‡å®šã®ä¸¦ã³ï¼šæ¯éŸ³ â†’ ãƒªã‚ºãƒ  â†’ æ‹—éŸ³ â†’ æ¿éŸ³ï¼ˆ4æœ¬ï¼‰
========================= */
let daily = null;

function r(a){ return a[Math.floor(Math.random()*a.length)]; }

function pickDaily(){
  return [
    {sec:0, p:r(p1)},
    {sec:4, p:r(p5)},
    {sec:3, p:r(p4)},
    {sec:2, p:r(p3)}
  ];
}

function showDaily(){
  if(!daily) daily = pickDaily();
  dailyText.textContent =
    daily.map((x,i)=>`(${i+1}) ${sections[x.sec].t}ï¼š${x.p}`).join("\n");
}

function shuffleDaily(){
  daily = pickDaily();
  showDaily();
}

/* ãƒŸãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ï¼šè‡ªå‹•ONã§é †ç•ªã«å†ç”Ÿ */
let dailyIndex = 0;
let dailyRunTimeout = null;

function clearDailyRun(){
  if(dailyRunTimeout){
    clearTimeout(dailyRunTimeout);
    dailyRunTimeout = null;
  }
}

function startDaily(){
  if(!daily) daily = pickDaily();
  auto = true;
  syncAutoBtn();
  dailyIndex = 0;
  runDailyStep();
}

function runDailyStep(){
  clearDailyRun();

  const item = daily[dailyIndex];
  if(!item){
    // çµ‚äº†
    stopAll();
    return;
  }

  sec = item.sec;
  idx = sections[sec].d.indexOf(item.p);
  if(idx < 0) idx = 0;

  render();

  // ãã®é …ç›®ã‚’å†ç”Ÿï¼ˆé€šå¸¸ã¯ãƒ¦ãƒ‹ãƒƒãƒˆæ•°Ã—speedã€é›£èªã¯3ç§’ï¼‰
  isPlaying = true;
  paused = false;
  pauseBtn.textContent = "â¸ ä¸€æ™‚åœæ­¢";

  // 1é …ç›®ã ã‘æµã—ã¦æ¬¡ã¸ï¼ˆãƒŸãƒƒã‚·ãƒ§ãƒ³ç”¨ï¼‰
  if(sec === 5){
    // é›£èªã¯ãƒŸãƒƒã‚·ãƒ§ãƒ³ã«å…¥ã‚Œãªã„æƒ³å®šã ãŒã€ä¿é™º
    if(kara){
      startHard();
      dailyRunTimeout = setTimeout(()=>{
        dailyIndex++;
        runDailyStep();
      }, 3200);
    }else{
      dailyRunTimeout = setTimeout(()=>{
        dailyIndex++;
        runDailyStep();
      }, 3200);
    }
    return;
  }

  // é€šå¸¸ï¼šãƒ¦ãƒ‹ãƒƒãƒˆæ•°ã§è¦‹ç©ã‚‚ã‚Š
  const units = buildUnits(sections[sec].d[idx]).filter(u=>!u.skip);
  startPlay();

  const est = units.length * speed + 600;
  dailyRunTimeout = setTimeout(()=>{
    // æ¬¡ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã¸
    stopAll();
    dailyIndex++;
    runDailyStep();
  }, est);
}

/* =========================
   UIåŒæœŸ
========================= */
function syncAutoBtn(){
  autoBtn.textContent = auto ? "è‡ªå‹•ON" : "è‡ªå‹•OFF";
}
function syncKaraBtn(){
  karaBtn.textContent = kara ? "ğŸŒˆ ON" : "ğŸŒˆ OFF";
}
function setSpeed(v){
  speed = Number(v);
  speedLabel.textContent = speed + "ms";
}

/* èª­ã¿ä¸Šã’ä½ç½® */
function setReadTop(px){
  readStage.style.setProperty("--readTop", px + "px");
  readPosLabel.textContent = px + "px";
}

/* =========================
   ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆiPhoneå®‰å®šï¼šclick + touchendï¼‰
========================= */
function bindTap(el, fn){
  el.addEventListener("click", fn);
  el.addEventListener("touchend", fn, {passive:true});
}

bindTap(playBtn, ()=>{
  // ãƒŸãƒƒã‚·ãƒ§ãƒ³è¡¨ç¤ºã®ã€Œé–‹å§‹ã€ã§ã¯ãªãã€ä»Šè¡¨ç¤ºä¸­ãƒ•ãƒ¬ãƒ¼ã‚ºã®é–‹å§‹
  startPlay();
});
bindTap(pauseBtn, ()=> togglePause());
bindTap(stopBtn,  ()=> { stopAll(); clearDailyRun(); });
bindTap(skipBtn,  ()=> skip());

bindTap(autoBtn, ()=>{
  auto = !auto;
  syncAutoBtn();
});
bindTap(karaBtn, ()=>{
  kara = !kara;
  syncKaraBtn();
  stopAll();
  render();
});
bindTap(shuffleBtn, ()=>{
  shuffleDaily();
});

speedRange.addEventListener("input", (e)=>{
  setSpeed(e.target.value);
  // å†ç”Ÿä¸­ã«å¤‰ãˆãŸã‚‰ã€æ¬¡å›ã‹ã‚‰åæ˜ ï¼ˆä»Šã®intervalã¯ç¶™ç¶šï¼‰
});

readPosRange.addEventListener("input", (e)=>{
  setReadTop(Number(e.target.value));
});

/* =========================
   åˆæœŸ
========================= */
setSpeed(speedRange.value);
setReadTop(Number(readPosRange.value));
daily = pickDaily();
showDaily();
syncAutoBtn();
syncKaraBtn();
render();

// è¿½åŠ ï¼šãƒŸãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ãƒœã‚¿ãƒ³ã‚‚æ¬²ã—ã„ãªã‚‰ã€dailyTextã®ä¸‹ã«ç½®ãè¨­è¨ˆã«ã—ã¦ã‚ã‚‹ã®ã§
// ã€ŒãƒŸãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ã€ã‚‚æ“ä½œãƒœã‚¿ãƒ³ã«ç´ä»˜ã‘ãŸã„å ´åˆã¯ã“ã“ã§OK
// ä¾‹ï¼šé•·æŠ¼ã—ã§ãƒŸãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ãªã©ã‚‚ã§ãã‚‹
// ä»Šå›ã¯ â€œãƒŸãƒƒã‚·ãƒ§ãƒ³å¤‰æ›´â€ ãƒœã‚¿ãƒ³ã®ã¿æ“ä½œã«ç½®ãã€ãƒŸãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ã¯ä¸Šã‚«ãƒ¼ãƒ‰ã«ä»˜ã‘ãŸã„ãªã‚‰ä¸‹ã‚’æœ‰åŠ¹åŒ–ï¼š
(function addMissionButtonsIfMissing(){
  // ä¸Šã‚«ãƒ¼ãƒ‰ã«ã€Œé–‹å§‹/å¤‰æ›´ã€ãŒæ¬²ã—ã„å ´åˆã®ä¿é™ºï¼ˆæ—¢ã«UIã¯ã‚ã‚‹ãŒã€ä»Šå›ã¯æœ€ä¸Šéƒ¨ã‚’ãƒ†ã‚­ã‚¹ãƒˆä¸­å¿ƒã«ã—ãŸã®ã§ä¸è¦ï¼‰
})();
</script>

</body>
</html>