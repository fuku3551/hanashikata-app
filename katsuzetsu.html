<!doctype html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>👄 滑舌練習（今日のミッション）</title>
<link rel="stylesheet" href="style.css" />

<style>
  /* ===== 全体 ===== */
  #phraseBody{
    font-size:32px;
    font-weight:900;
    text-align:center;
    line-height:1.9;
    white-space:pre-wrap;
  }

  ruby rt{ font-size:0.55em; opacity:0.85; }

  .row{
    display:flex;
    gap:10px;
    justify-content:center;
    flex-wrap:wrap;
    align-items:center;
  }

  .mini{
    font-size:14px;
    opacity:0.85;
    line-height:1.7;
    white-space:pre-wrap;
  }

  /* ===== カラオケユニット ===== */
  .karaUnit{
    display:inline-block;
    padding:2px 4px;
    border-radius:8px;
    transition:.12s;
  }
  .karaUnit.active{
    background:#ffdddd;
    color:#d60000;
  }
  .karaUnit.done{ opacity:.45; }
  .karaUnit.skip{
    background:transparent !important;
    color:inherit !important;
    opacity:1;
  }

  /* 難語：全文点灯 */
  .hardAllOn{
    background:#ffdddd;
    color:#d60000;
    border-radius:12px;
    padding:6px 8px;
    display:inline-block;
  }

  /* ===== 読み上げ表示を上部に固定（メニュー下） ===== */
  .readStageTop{
    position: sticky;
    top: 120px;     /* ヘッダーの下に来るように */
    z-index: 10;
  }
  .readBox{
    border:1px solid rgba(0,0,0,.18);
    border-radius:14px;
    padding:12px;
    background: rgba(255,255,255,.92);
    backdrop-filter: blur(4px);
  }

  /* ===== ボタン大きめ ===== */
  .controls{
    position:relative;
    z-index: 5;
  }
  .bigBtn{
    font-size:18px;
    font-weight:900;
    padding:16px 18px;
    border-radius:14px;
    border:1px solid rgba(0,0,0,.12);
    background:#fff;
    min-width:150px;
    box-shadow:0 6px 18px rgba(0,0,0,.06);
    -webkit-tap-highlight-color: rgba(0,0,0,0);
  }
  .bigBtn:active{ transform: scale(.98); }
  .primary{ background:#0ea5e9; color:#fff; border:none; }
  .danger{ background:#ef4444; color:#fff; border:none; }
  .ghost{ background:#fff; }
  .warn{ background:#111; color:#fff; border:none; }
</style>
</head>

<body>

<header class="top">
  <h1>👄 滑舌練習</h1>
  <p><a href="index.html">← ホームへ</a></p>
</header>

<main class="menu">

  <!-- ✅ 今日のミッション（最上部） -->
  <div class="card">
    <div class="title">🔰 今日のミッション（約2〜3分）</div>
    <div class="desc">
      <div id="dailyText" class="mini">読み込み中…</div>
      <div class="mini" style="margin-top:8px;">
        💡「開始」を押すと、上から順に最後まで自動で進みます
      </div>
    </div>
  </div>

  <!-- ✅ 読み上げ表示（上部へ移動） -->
  <div class="card readStageTop" id="readStage">
    <div class="title" id="sectionTitle">準備OK</div>
    <div class="desc">
      <div style="text-align:center;">
        <span id="counter" class="mini"></span>
      </div>

      <div class="readBox">
        <div id="phraseBody">▶「開始」を押してください</div>
      </div>

      <div class="mini" style="text-align:center; margin-top:10px;">
        ※ まず「ゆっくり正確に」→ 慣れたらテンポアップ
      </div>
    </div>
  </div>

  <!-- ✅ 操作ボタン（必要な4つだけ） -->
  <div class="card">
    <div class="title">操作</div>
    <div class="desc controls">
      <div class="row">
        <button id="playBtn"  class="bigBtn primary" type="button">▶ 開始</button>
        <button id="pauseBtn" class="bigBtn ghost"   type="button">⏸ 一時停止</button>
        <button id="stopBtn"  class="bigBtn danger"  type="button">⏹ 停止</button>
        <button id="skipBtn"  class="bigBtn warn"    type="button">⏭ スキップ</button>
      </div>
    </div>
  </div>

</main>

<script>
/* =========================
   データ（ミッション固定：母音→リズム→拗音→濁音）
   - 難語は手動用として保持（セクション表示はしないが再生ロジックは残す）
========================= */

// 母音
const p1 = [
  "あいうえお",
  "あえいうえおあお",
  "あいうえおあお",
  "あおあえいうえお",
  "あいうえおあいうえお",
  "あーいーうーえーおー（ゆっくり）",
  "あ　い　う　え　お（1音ずつ）",
  "あいうえおあえう",
  "あおあおあえいえうえおう",
  "あいうえおおえういあ"
];

// リズム
const p5 = [
  "たたた　ててて　ととと",
  "かかか　ききき　くくく",
  "さささ　ししし　すすす",
  "ららら　りりり　るるる"
];

// 拗音
const p4 = [
  "きゃきゅきょ　きゃくきょ　きゅきょきゃ",
  "しゃしゅしょ　しゃくしょ　しゅしょしゃ",
  "ちゃちゅちょ　ちゃくちょ　ちゅちょちゃ",
  "にゃにゅにょ　にゃくにょ　にゅにょにゃ",
  "ひゃひゅひょ　ひゃくひょ　ひゅひょひゃ",
  "みゃみゅみょ　みゃくみょ　みゅみょみゃ",
  "りゃりゅりょ　りゃくりょ　りゅりょりゃ"
];

// 濁音
const p3 = [
  "がぎぐげご　がげご　ぎぐげ",
  "ざじずぜぞ　ざぜぞ　じずぜ",
  "だぢづでど　だでど　ぢづで",
  "ばびぶべぼ　ばべぼ　びぶべ",
  "ぱぴぷぺぽ　ぱぺぽ　ぴぷぺ"
];

/* ✅ 難語（ふりがな付き / 3秒切替 / 全文点灯） */
const hardRuby = [
  "<ruby>特製<rt>とくせい</rt></ruby><ruby>炭酸水<rt>たんさんすい</rt></ruby>、<ruby>瞬間<rt>しゅんかん</rt></ruby><ruby>酸欠<rt>さんけつ</rt></ruby><ruby>寸前<rt>すんぜん</rt></ruby>",
  "<ruby>早朝<rt>そうちょう</rt></ruby><ruby>送迎車<rt>そうげいしゃ</rt></ruby>、<ruby>商社<rt>しょうしゃ</rt></ruby><ruby>駐車場<rt>ちゅうしゃじょう</rt></ruby><ruby>集合<rt>しゅうごう</rt></ruby>",
  "<ruby>調査主任<rt>ちょうさしゅにん</rt></ruby>、<ruby>諸所<rt>しょしょ</rt></ruby><ruby>視察<rt>しさつ</rt></ruby>し<ruby>所感<rt>しょかん</rt></ruby><ruby>書記<rt>しょき</rt></ruby>",
  "<ruby>貨物<rt>かもつ</rt></ruby><ruby>客室<rt>きゃくしつ</rt></ruby>、<ruby>各客<rt>かくきゃく</rt></ruby>が<ruby>客席<rt>きゃくせき</rt></ruby><ruby>確保<rt>かくほ</rt></ruby>",
  "<ruby>急遽<rt>きゅうきょ</rt></ruby><ruby>休暇<rt>きゅうか</rt></ruby>、<ruby>究極級<rt>きゅうきょくきゅう</rt></ruby>の<ruby>供給不足<rt>きょうきゅうぶそく</rt></ruby>",
  "<ruby>連続<rt>れんぞく</rt></ruby><ruby>朗読<rt>ろうどく</rt></ruby>、<ruby>論理<rt>ろんり</rt></ruby><ruby>論述<rt>ろんじゅつ</rt></ruby>、<ruby>朗朗論<rt>ろうろうろん</rt></ruby>",
  "<ruby>反復<rt>はんぷく</rt></ruby><ruby>発話<rt>はつわ</rt></ruby>、<ruby>発泡<rt>はっぽう</rt></ruby><ruby>発酵<rt>はっこう</rt></ruby>、<ruby>白泡<rt>しろあわ</rt></ruby><ruby>発生<rt>はっせい</rt></ruby>",
  "<ruby>逆走客<rt>ぎゃくそうきゃく</rt></ruby>が<ruby>客席<rt>きゃくせき</rt></ruby><ruby>急加速<rt>きゅうかそく</rt></ruby>、<ruby>客席<rt>きゃくせき</rt></ruby><ruby>逆<rt>ぎゃく</rt></ruby>さ",
  "<ruby>朴訥<rt>ぼくとつ</rt></ruby>な<ruby>牧童<rt>ぼくどう</rt></ruby>、<ruby>北斗<rt>ほくと</rt></ruby>の<ruby>木刀<rt>ぼくとう</rt></ruby><ruby>特訓<rt>とっくん</rt></ruby>",
  "<ruby>隙間<rt>すきま</rt></ruby><ruby>隙間<rt>すきま</rt></ruby>に<ruby>すき焼き<rt>すきやき</rt></ruby>の<ruby>具<rt>ぐ</rt></ruby>を<ruby>詰<rt>つ</rt></ruby>める",
  "<ruby>新進<rt>しんしん</rt></ruby><ruby>歌手<rt>かしゅ</rt></ruby><ruby>総出演<rt>そうしゅつえん</rt></ruby>、<ruby>新春<rt>しんしゅん</rt></ruby><ruby>ショー<rt>しょー</rt></ruby>",
  "<ruby>右目<rt>みぎめ</rt></ruby><ruby>右耳<rt>みぎみみ</rt></ruby><ruby>右肩<rt>みぎかた</rt></ruby><ruby>右腕<rt>みぎうで</rt></ruby>／<ruby>左目<rt>ひだりめ</rt></ruby><ruby>左耳<rt>ひだりみみ</rt></ruby><ruby>左肩<rt>ひだりかた</rt></ruby><ruby>左腕<rt>ひだりうで</rt></ruby>",
  "<ruby>竹垣<rt>たけがき</rt></ruby>に<ruby>竹<rt>たけ</rt></ruby>を<ruby>立<rt>た</rt></ruby>てかけたのは<ruby>立<rt>た</rt></ruby>てたかったから",
  "<ruby>釘<rt>くぎ</rt></ruby>を<ruby>引<rt>ひ</rt></ruby>き<ruby>抜<rt>ぬ</rt></ruby>きにくい<ruby>釘<rt>くぎ</rt></ruby>だ",
  "<ruby>油<rt>あぶら</rt></ruby><ruby>売<rt>う</rt></ruby>りが<ruby>油<rt>あぶら</rt></ruby>を<ruby>売<rt>う</rt></ruby>る<ruby>間<rt>あいだ</rt></ruby>に<ruby>売上<rt>うりあげ</rt></ruby>が<ruby>落<rt>お</rt></ruby>ちる",
  "<ruby>謎<rt>なぞ</rt></ruby>なら<ruby>謎<rt>なぞ</rt></ruby>と<ruby>名乗<rt>なの</rt></ruby>れ、<ruby>バナナ<rt>ばなな</rt></ruby>の<ruby>謎<rt>なぞ</rt></ruby>はまだ<ruby>謎<rt>なぞ</rt></ruby>だ",
  "<ruby>屏風<rt>びょうぶ</rt></ruby>に<ruby>上手<rt>じょうず</rt></ruby>に<ruby>坊主<rt>ぼうず</rt></ruby>の<ruby>絵<rt>え</rt></ruby>を<ruby>描<rt>か</rt></ruby>く",
  "<ruby>青<rt>あお</rt></ruby><ruby>赤<rt>あか</rt></ruby><ruby>黄<rt>き</rt></ruby>の<ruby>パジャマ<rt>ぱじゃま</rt></ruby>を<ruby>着<rt>き</rt></ruby>かえる",
  "<ruby>三<rt>さん</rt></ruby><ruby>匹<rt>びき</rt></ruby>の<ruby>蛙<rt>かえる</rt></ruby>がぴょこぴょこ、<ruby>六<rt>ろく</rt></ruby>ぴょこぴょこ",
  "<ruby>滑舌<rt>かつぜつ</rt></ruby><ruby>練習<rt>れんしゅう</rt></ruby>は<ruby>反復<rt>はんぷく</rt></ruby>が<ruby>最強<rt>さいきょう</rt></ruby>"
];

/* ミッション固定（指定どおり） */
let daily = [
  {t:"母音", list:p1},
  {t:"リズム", list:p5},
  {t:"拗音", list:p4},
  {t:"濁音", list:p3}
];

/* =========================
   状態
========================= */
let isPlaying = false;
let paused = false;
let dailyIndex = 0;
let phraseIndex = 0;
let timer = null;
let hardTimeout = null;

/* ✅ 通常：1ユニット=0.7秒固定 */
const SPEED = 700;

/* ===== DOM ===== */
const dailyTextEl = document.getElementById("dailyText");
const sectionTitle = document.getElementById("sectionTitle");
const counter = document.getElementById("counter");
const phraseBody = document.getElementById("phraseBody");

const playBtn = document.getElementById("playBtn");
const pauseBtn = document.getElementById("pauseBtn");
const stopBtn = document.getElementById("stopBtn");
const skipBtn = document.getElementById("skipBtn");

/* =========================
   ユニット化（通常用）
   - 拗音小文字を合体
   - 空白はskip（表示は残す）
   - （）内は除外
========================= */
function buildUnits(text){
  const small = "ゃゅょぁぃぅぇぉ";
  let arr = [];
  let buf = "";
  let inParen = false;

  for(const c of text){
    if(c === "（"){ inParen = true; continue; }
    if(c === "）"){ inParen = false; continue; }
    if(inParen) continue;

    if(/\s/.test(c)){
      if(buf){ arr.push({t:buf}); buf=""; }
      arr.push({t:c, skip:true});
      continue;
    }

    if(small.includes(c)){
      buf += c;
      continue;
    }else{
      if(buf) arr.push({t:buf});
      buf = c;
    }
  }
  if(buf) arr.push({t:buf});
  return arr;
}

/* =========================
   表示
========================= */
function showDaily(){
  // 毎回ランダムに選ぶ（固定順で中身だけ変わる）
  const pick = (a)=> a[Math.floor(Math.random()*a.length)];

  daily = [
    {t:"①母音", list:[pick(p1)]},
    {t:"⑤リズム", list:[pick(p5)]},
    {t:"④拗音", list:[pick(p4)]},
    {t:"③濁音", list:[pick(p3)]}
  ];

  dailyTextEl.textContent =
    daily.map((x,i)=>`(${i+1}) ${x.t}：${x.list[0]}`).join("\n");
}

function renderCurrent(text, isHard=false){
  phraseBody.classList.remove("hardAllOn");
  phraseBody.innerHTML = "";

  if(isHard){
    // 難語（ruby HTML）
    phraseBody.innerHTML = `<span class="hardAllOn">${text}</span>`;
    return;
  }

  // 通常：karaUnit生成
  const units = buildUnits(text);
  units.forEach(u=>{
    const sp = document.createElement("span");
    sp.className = "karaUnit";
    if(u.skip){
      sp.classList.add("skip");
      sp.textContent = u.t;
    }else{
      sp.textContent = u.t;
    }
    phraseBody.appendChild(sp);
  });
}

function clearVisual(){
  document.querySelectorAll(".karaUnit").forEach(s=>{
    s.classList.remove("active","done");
  });
  phraseBody.classList.remove("hardAllOn");
}

/* =========================
   タイマー制御
========================= */
function clearTimers(){
  if(timer){ clearInterval(timer); timer=null; }
  if(hardTimeout){ clearTimeout(hardTimeout); hardTimeout=null; }
}

function stopAll(){
  isPlaying = false;
  paused = false;
  pauseBtn.textContent = "⏸ 一時停止";
  clearTimers();
  clearVisual();
  sectionTitle.textContent = "停止";
  counter.textContent = "";
  phraseBody.textContent = "▶「開始」を押してください";
}

/* =========================
   再生ロジック
   - 開始：ミッションを最後まで自動
   - 難語は別（手動で使う想定のため、ここではミッションに入れない）
========================= */
let playIndex = 0;

function startKaraForCurrent(){
  clearTimers();
  clearVisual();
  playIndex = 0;

  const spans = Array.from(document.querySelectorAll(".karaUnit"))
    .filter(sp=>!sp.classList.contains("skip"));

  if(spans.length === 0){
    // 文字が無いときは次へ
    goNextPhrase();
    return;
  }

  timer = setInterval(()=>{
    if(!isPlaying) return;
    if(paused) return;

    if(playIndex > 0){
      spans[playIndex-1].classList.remove("active");
      spans[playIndex-1].classList.add("done");
    }

    if(playIndex >= spans.length){
      clearTimers();
      // 次へ
      setTimeout(()=> goNextPhrase(), 420);
      return;
    }

    spans[playIndex].classList.add("active");
    playIndex++;
  }, SPEED);
}

function goNextPhrase(){
  if(!isPlaying) return;

  // ミッションの現在項目は daily[dailyIndex].list に1つだけ入ってる
  phraseIndex++;

  // 今回は各項目1フレーズ固定なので、すぐ次の項目へ
  dailyIndex++;

  if(dailyIndex >= daily.length){
    // 完了
    isPlaying = false;
    paused = false;
    pauseBtn.textContent = "⏸ 一時停止";
    sectionTitle.textContent = "✨ お疲れ様でした";
    counter.textContent = "";
    phraseBody.textContent = "😊";
    return;
  }

  // 次の項目を表示して再生
  phraseIndex = 0;
  playDailyStep();
}

function playDailyStep(){
  const item = daily[dailyIndex];
  const text = item.list[0];

  sectionTitle.textContent = item.t;
  counter.textContent = `(${dailyIndex+1}/${daily.length})`;

  renderCurrent(text, false);
  startKaraForCurrent();
}

function startDailyAuto(){
  // 毎回ミッションを更新してからスタート
  showDaily();

  isPlaying = true;
  paused = false;
  pauseBtn.textContent = "⏸ 一時停止";

  dailyIndex = 0;
  phraseIndex = 0;

  playDailyStep();
}

function togglePause(){
  if(!isPlaying) return;
  paused = !paused;
  pauseBtn.textContent = paused ? "▶ 再開" : "⏸ 一時停止";
}

function skip(){
  if(!isPlaying){
    // 停止中のスキップは、次の難語を見せる（おまけ：練習用）
    const t = hardRuby[Math.floor(Math.random()*hardRuby.length)];
    sectionTitle.textContent = "⑥難語（おまけ）";
    counter.textContent = "";
    renderCurrent(t, true);
    // 難語は3秒で自動切替（停止中でも見せたい場合）
    clearTimers();
    hardTimeout = setTimeout(()=>{
      if(isPlaying) return;
      const t2 = hardRuby[Math.floor(Math.random()*hardRuby.length)];
      renderCurrent(t2, true);
    }, 3000);
    return;
  }

  // 再生中：次のミッションへ
  clearTimers();
  goNextPhrase();
}

/* =========================
   iPhone安定イベント：click + touchend
========================= */
function bindTap(el, fn){
  el.addEventListener("click", fn);
  el.addEventListener("touchend", fn, {passive:true});
}

bindTap(playBtn, ()=> startDailyAuto());
bindTap(pauseBtn, ()=> togglePause());
bindTap(stopBtn,  ()=> stopAll());
bindTap(skipBtn,  ()=> skip());

/* 初期 */
showDaily();
sectionTitle.textContent = "準備OK";
counter.textContent = "";
</script>

</body>
</html>