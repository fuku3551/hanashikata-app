<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ»‘èˆŒç·´ç¿’ï¼ˆãƒ•ãƒ¬ãƒ¼ã‚ºå¼ï¼‰</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* ===== è¦‹ã‚„ã™ã•ï¼šãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å¤§ãã ===== */
    #phraseBody {
      font-size: 32px !important;
      font-weight: 800;
      text-align: center;
      line-height: 1.8;
      letter-spacing: 0.02em;
    }
    #phraseCounter { font-size: 14px; opacity: 0.75; }

    /* ===== ã‚«ãƒ©ã‚ªã‚±é¢¨ãƒã‚¤ãƒ©ã‚¤ãƒˆ ===== */
    .karaChar{
      display:inline-block;
      padding: 2px 2px;
      border-radius: 6px;
    }
    .karaChar.active{
      background: rgba(239,68,68,0.18);
      color: #ef4444;
    }
    .karaChar.done{
      opacity: 0.55;
    }

    /* ===== ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«UI ===== */
    .ctrlCard { display:block; }
    .row { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; align-items:center; }
    .mini { font-size: 14px; opacity: 0.85; line-height: 1.7; }
    .pill {
      display:inline-block; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.15); font-size:14px; opacity:0.9;
    }
    input[type="range"]{ width: 240px; }
    .modeBtnOn{
      border: 2px solid #333 !important;
      opacity: 1 !important;
    }
  </style>
</head>

<body>

<header class="top">
  <h1>ğŸ‘„ æ»‘èˆŒç·´ç¿’ï¼ˆãƒ•ãƒ¬ãƒ¼ã‚ºå¼ï¼‰</h1>
  <p class="sub">ã€Œæ¬¡ã¸ã€ã§1ãƒ•ãƒ¬ãƒ¼ã‚ºãšã¤é€²ã¿ã¾ã™ï¼ˆè‡ªå‹•ãƒ»èª­ã¿ä¸Šã’ã‚‚OKï¼‰</p>
  <p><a href="index.html">â† ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</a></p>
</header>

<main class="menu">

  <!-- å¤§ãã‚ã‚¿ã‚¤ãƒˆãƒ« -->
  <div class="card" style="display:block;">
    <div class="title" style="font-size:28px;">æ»‘èˆŒç·´ç¿’</div>
    <div class="desc" style="margin-top:6px; opacity:0.8;">
      ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆâ‘ ã€œâ‘¥ï¼‰ã‚’é¸ã‚“ã§ã€1ãƒ•ãƒ¬ãƒ¼ã‚ºãšã¤ç·´ç¿’ã§ãã¾ã™
    </div>
  </div>

  <!-- âœ… ä»Šæ—¥ã®æ»‘èˆŒãƒŸãƒƒã‚·ãƒ§ãƒ³ -->
  <div class="card" style="display:block;">
    <div class="title">ğŸ”° ä»Šæ—¥ã®æ»‘èˆŒãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼ˆç´„2ã€œ3åˆ†ï¼‰</div>
    <div class="desc">
      <div class="mini" id="dailyText">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
      <div class="row" style="margin-top:10px;">
        <button onclick="startDaily()">â–¶ ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹</button>
        <button onclick="shuffleDaily()">ğŸ² å¤‰æ›´</button>
      </div>
      <div class="mini" style="margin-top:8px;">
        ğŸ’¡ è¿·ã£ãŸã‚‰ã“ã‚Œã ã‘ã‚„ã‚Œã°OKï¼ˆçŸ­æ™‚é–“ã§â€œæ¯æ—¥ç¶šãâ€è¨­è¨ˆï¼‰
      </div>
    </div>
  </div>

  <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³é¸æŠ -->
  <div class="card" style="display:block;">
    <div class="title">ã‚»ã‚¯ã‚·ãƒ§ãƒ³é¸æŠ</div>
    <div class="desc" style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:10px;">
      <button onclick="setSection(0)">â‘  æ¯éŸ³</button>
      <button onclick="setSection(1)">â‘¡ è¡Œåˆ¥åŸºæœ¬</button>
      <button onclick="setSection(2)">â‘¢ æ¿éŸ³/åŠæ¿éŸ³</button>
      <button onclick="setSection(3)">â‘£ æ‹—éŸ³</button>
      <button onclick="setSection(4)">â‘¤ ãƒªã‚ºãƒ </button>
      <button onclick="setSection(5)">â‘¥ è¨€ã„ã«ãã„è¨€è‘‰</button>
    </div>
  </div>

  <!-- âœ… ç·´ç¿’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆå†ç”Ÿãƒ»è‡ªå‹•ãƒ»é€Ÿåº¦ãƒ»ãƒ¢ãƒ¼ãƒ‰ï¼‰ -->
  <div class="card ctrlCard">
    <div class="title">âš™ï¸ ç·´ç¿’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</div>
    <div class="desc">
      <div class="row">
        <button id="btnPlay" onclick="togglePlay()">ğŸ”Š å†ç”Ÿ</button>
        <button id="btnAuto" onclick="toggleAuto()" style="opacity:0.85;">â­ è‡ªå‹•ï¼šOFF</button>
        <button id="btnKara" onclick="toggleKaraoke()" style="opacity:0.85;">ğŸŒˆ ã‚«ãƒ©ã‚ªã‚±ï¼šON</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <span class="pill">é€Ÿåº¦</span>
        <input type="range" min="200" max="900" value="450" oninput="setSpeed(this.value)">
        <span class="pill" id="speedLabel">450ms</span>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="btnBeginner" class="modeBtnOn" onclick="setLevel('beginner')">ğŸ”° åˆå¿ƒè€…</button>
        <button id="btnAdvanced" onclick="setLevel('advanced')" style="opacity:0.7;">ğŸ”¥ ä¸Šç´š</button>
      </div>

      <div class="mini" style="margin-top:10px;">
        ãƒ»åˆå¿ƒè€…ï¼šã‚†ã£ãã‚Šï¼†æ­£ç¢ºï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆå¼·ã‚ï¼‰<br>
        ãƒ»ä¸Šç´šï¼šãƒ†ãƒ³ãƒUPï¼ˆè‡ªå‹•ONæ¨å¥¨ï¼‰<br>
        â€» iPhoneã¯èª­ã¿ä¸Šã’é–‹å§‹æ™‚ã«ã€Œå†ç”Ÿã€ã‚’1å›ã‚¿ãƒƒãƒ—ãŒå¿…è¦ã§ã™ï¼ˆä»•æ§˜ï¼‰
      </div>
    </div>
  </div>

  <!-- è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <div class="card" style="display:block;">
    <div class="title" id="sectionTitle">ï¼ˆâ‘  æ¯éŸ³ï¼‰</div>
    <div class="desc">
      <div style="margin: 6px 0; opacity: 0.75; text-align:center;">
        <span id="phraseCounter">0/0</span>
      </div>

      <div style="border:1px solid rgba(255,255,255,0.15); border-radius:12px; padding:14px;">
        <div id="phraseBody" style="white-space: pre-wrap;">
          ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
        </div>
      </div>

      <div style="display:flex; gap:10px; justify-content:center; margin-top:12px; flex-wrap:wrap;">
        <button onclick="prevPhrase()">â—€ å‰ã¸</button>
        <button onclick="nextPhrase()">æ¬¡ã¸ â–¶</button>
        <button onclick="randomPhrase()">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ </button>
        <button onclick="resetPhrase()">âŸ² æœ€åˆã¸</button>
      </div>

      <div style="text-align:center; margin-top:10px; opacity:0.75; font-size:14px;">
        â€» ã¾ãšã€Œã‚†ã£ãã‚Šæ­£ç¢ºã«ã€â†’ æ…£ã‚ŒãŸã‚‰å°‘ã—ãƒ†ãƒ³ãƒã‚¢ãƒƒãƒ—
      </div>
    </div>
  </div>

</main>

<script>
/* =========================
   ãƒ‡ãƒ¼ã‚¿ï¼šâ‘ ã€œâ‘¥
========================= */
// â‘  æ¯éŸ³
const phrases1 = [
  "ã‚ãˆã„ã†ãˆãŠã€€ã‚ãŠ",
  "ã‚ã„ã†ãˆãŠã€€ã‚ãŠ",
  "ã‚ãˆã„ã†ãˆãŠã€€ã‚ãŠ",
  "ã‚ã„ã†ãˆãŠã€€ã‚ãŠ",
  "ã‚ãˆã„ã†ãˆãŠã€€ã‚ãŠ",
  "ã‚ã„ã†ãˆãŠã€€ã‚ãŠ"
];

// â‘¡ è¡Œåˆ¥åŸºæœ¬
const phrases2 = [
  "ï¼ˆã‚è¡Œï¼‰ ã‚ã€€ã„ã€€ã†ã€€ãˆã€€ãŠ",
  "ã‚ãˆã„ã€€ã†ãˆãŠã€€ã‚ãŠ",
  "ï¼ˆã‹è¡Œï¼‰ ã‹ã€€ãã€€ãã€€ã‘ã€€ã“",
  "ã‹ããã‘ã“ã€€ã‹ã‘ã“ã€€ããã‘",
  "ï¼ˆã•è¡Œï¼‰ ã•ã€€ã—ã€€ã™ã€€ã›ã€€ã",
  "ã•ã—ã™ã›ãã€€ã•ã›ãã€€ã—ã™ã›",
  "ï¼ˆãŸè¡Œï¼‰ ãŸã€€ã¡ã€€ã¤ã€€ã¦ã€€ã¨",
  "ãŸã¡ã¤ã¦ã¨ã€€ãŸã¦ã¨ã€€ã¡ã¤ã¦",
  "ï¼ˆãªè¡Œï¼‰ ãªã€€ã«ã€€ã¬ã€€ã­ã€€ã®",
  "ãªã«ã¬ã­ã®ã€€ãªã­ã®ã€€ã«ã¬ã­",
  "ï¼ˆã¯è¡Œï¼‰ ã¯ã€€ã²ã€€ãµã€€ã¸ã€€ã»",
  "ã¯ã²ãµã¸ã»ã€€ã¯ã¸ã»ã€€ã²ãµã¸",
  "ï¼ˆã¾è¡Œï¼‰ ã¾ã€€ã¿ã€€ã‚€ã€€ã‚ã€€ã‚‚",
  "ã¾ã¿ã‚€ã‚ã‚‚ã€€ã¾ã‚ã‚‚ã€€ã¿ã‚€ã‚",
  "ï¼ˆã‚„è¡Œï¼‰ ã‚„ã€€ã‚†ã€€ã‚ˆ",
  "ã‚„ã‚†ã‚ˆã€€ã‚†ã‚ˆã‚„ã€€ã‚ˆã‚„ã‚†",
  "ï¼ˆã‚‰è¡Œï¼‰ ã‚‰ã€€ã‚Šã€€ã‚‹ã€€ã‚Œã€€ã‚",
  "ã‚‰ã‚Šã‚‹ã‚Œã‚ã€€ã‚‰ã‚Œã‚ã€€ã‚Šã‚‹ã‚Œ",
  "ï¼ˆã‚è¡Œï¼‰ ã‚ã€€ã‚’ã€€ã‚“",
  "ã‚ã‚’ã‚“ã€€ã‚ã‚“ã‚’ã€€ã‚’ã‚ã‚“"
];

// â‘¢ æ¿éŸ³ãƒ»åŠæ¿éŸ³
const phrases3 = [
  "ãŒããã’ã”ã€€ãŒã’ã”ã€€ããã’",
  "ã–ã˜ãšãœãã€€ã–ãœãã€€ã˜ãšãœ",
  "ã ã¢ã¥ã§ã©ã€€ã ã§ã©ã€€ã¢ã¥ã§",
  "ã°ã³ã¶ã¹ã¼ã€€ã°ã¹ã¼ã€€ã³ã¶ã¹",
  "ã±ã´ã·ãºã½ã€€ã±ãºã½ã€€ã´ã·ãº"
];

// â‘£ æ‹—éŸ³
const phrases4 = [
  "ãã‚ƒãã‚…ãã‚‡ã€€ãã‚ƒããã‚‡ã€€ãã‚…ãã‚‡ãã‚ƒ",
  "ã—ã‚ƒã—ã‚…ã—ã‚‡ã€€ã—ã‚ƒãã—ã‚‡ã€€ã—ã‚…ã—ã‚‡ã—ã‚ƒ",
  "ã¡ã‚ƒã¡ã‚…ã¡ã‚‡ã€€ã¡ã‚ƒãã¡ã‚‡ã€€ã¡ã‚…ã¡ã‚‡ã¡ã‚ƒ",
  "ã«ã‚ƒã«ã‚…ã«ã‚‡ã€€ã«ã‚ƒãã«ã‚‡ã€€ã«ã‚…ã«ã‚‡ã«ã‚ƒ",
  "ã²ã‚ƒã²ã‚…ã²ã‚‡ã€€ã²ã‚ƒãã²ã‚‡ã€€ã²ã‚…ã²ã‚‡ã²ã‚ƒ",
  "ã¿ã‚ƒã¿ã‚…ã¿ã‚‡ã€€ã¿ã‚ƒãã¿ã‚‡ã€€ã¿ã‚…ã¿ã‚‡ã¿ã‚ƒ",
  "ã‚Šã‚ƒã‚Šã‚…ã‚Šã‚‡ã€€ã‚Šã‚ƒãã‚Šã‚‡ã€€ã‚Šã‚…ã‚Šã‚‡ã‚Šã‚ƒ"
];

// â‘¤ ãƒªã‚ºãƒ 
const phrases5 = [
  "ãŸãŸãŸã€€ã¦ã¦ã¦ã€€ã¨ã¨ã¨",
  "ã‹ã‹ã‹ã€€ãããã€€ããã",
  "ã•ã•ã•ã€€ã—ã—ã—ã€€ã™ã™ã™",
  "ã‚‰ã‚‰ã‚‰ã€€ã‚Šã‚Šã‚Šã€€ã‚‹ã‚‹ã‚‹"
];

// â‘¥ è¨€ã„ã«ãã„è¨€è‘‰
const phrases6 = [
  "ã‚ã‚ã‚“ã¼ã‚ã‹ã„ãªã€€ã‚ã„ã†ãˆãŠã€€ã†ãã‚‚ã«ã“ãˆã³ã‚‚ãŠã‚ˆã„ã§ã‚‹",
  "ç”Ÿéº¦ï¼ˆãªã¾ã‚€ãï¼‰ã€€ç”Ÿç±³ï¼ˆãªã¾ã”ã‚ï¼‰ã€€ç”Ÿåµï¼ˆãªã¾ãŸã¾ã”ï¼‰",
  "èµ¤å·»ç´™ï¼ˆã‚ã‹ã¾ããŒã¿ï¼‰ã€€é’å·»ç´™ï¼ˆã‚ãŠã¾ããŒã¿ï¼‰ã€€é»„å·»ç´™ï¼ˆãã¾ããŒã¿ï¼‰",
  "æ±äº¬ç‰¹è¨±è¨±å¯å±€ï¼ˆã¨ã†ãã‚‡ã†ã¨ã£ãã‚‡ãã‚‡ã‹ãã‚‡ãï¼‰",
  "éš£ï¼ˆã¨ãªã‚Šï¼‰ã®å®¢ï¼ˆãã‚ƒãï¼‰ã¯ã‚ˆãæŸ¿ï¼ˆã‹ãï¼‰é£Ÿã†å®¢ã ",
  "ã“ã®ç«¹å£ï¼ˆãŸã‘ãŒãï¼‰ã«ç«¹ç«‹ï¼ˆãŸã‘ãŸï¼‰ã¦ã‹ã‘ãŸã®ã¯ç«¹ç«‹ï¼ˆãŸã‘ãŸï¼‰ã¦ã‹ã‘ãŸã‹ã£ãŸã‹ã‚‰",
  "è€è‹¥ç”·å¥³ï¼ˆã‚ã†ã«ã‚ƒããªã‚“ã«ã‚‡ï¼‰",
  "æ—…å®¢æ©Ÿï¼ˆã‚Šã‚‡ã‹ã£ãï¼‰ã€€æ—…å®¢èˆ¹ï¼ˆã‚Šã‚‡ã‹ãã›ã‚“ï¼‰ã€€æ—…é¤¨ï¼ˆã‚Šã‚‡ã‹ã‚“ï¼‰",
  "æ¥­å‹™ä¸Šéå¤±è‡´æ­»å‚·ï¼ˆãã‚‡ã†ã‚€ã˜ã‚‡ã†ã‹ã—ã¤ã¡ã—ã—ã‚‡ã†ï¼‰",
  "æ‰“è€…èµ°è€…å‹è€…ï¼ˆã ã—ã‚ƒãã†ã—ã‚ƒã—ã‚‡ã†ã—ã‚ƒï¼‰",
  "é­”è¡“å¸«æ‰‹è¡“ä¸­ï¼ˆã¾ã˜ã‚…ã¤ã—ã—ã‚…ã˜ã‚…ã¤ã¡ã‚…ã†ï¼‰",
  "è²§ä¹äººï¼ˆã³ã‚“ã¼ã†ã«ã‚“ï¼‰ã€€æ•è…•å¼è­·å£«ï¼ˆã³ã‚“ã‚ã‚“ã¹ã‚“ã”ã—ï¼‰",
  "ãƒã‚¹ã‚¬ã‚¹çˆ†ç™ºï¼ˆã°ã™ãŒã™ã°ãã¯ã¤ï¼‰",
  "è²¨å®¢èˆ¹ï¼ˆã‹ãã‚ƒãã›ã‚“ï¼‰ã€€æ—…å®¢èˆ¹ï¼ˆã‚Šã‚‡ã‹ãã›ã‚“ï¼‰ã€€å®¢èˆ¹ï¼ˆãã‚ƒãã›ã‚“ï¼‰",
  "ç©¶æ¥µï¼ˆãã‚…ã†ãã‚‡ãï¼‰ã€€ä¾›çµ¦ï¼ˆãã‚‡ã†ãã‚…ã†ï¼‰ã€€è¦æ±‚ï¼ˆã‚ˆã†ãã‚…ã†ï¼‰",
  "ãã‚ƒã‚Šãƒ¼ãã‚…ã‚Šãƒ¼ãã‚‡ã‚ãã‚‡ã‚ï¼ˆâ€»æ‹—éŸ³ç·´ç¿’ï¼‰",
  "ã—ã‚ƒã—ã‚…ã—ã‚‡ã§ã€€ã—ã‚…ã—ã‚…ã—ã‚…ã£ã¨ã€€ã—ã‚‡ã—ã‚‡ã—ã‚‡",
  "ã¡ã‚ƒã¡ã‚…ã¡ã‚‡ã§ã€€ã¡ã‚‡ã¡ã‚‡ã¡ã‚‡ã£ã¨ã€€ã¡ã‚…ã¡ã‚…ã¡ã‚…ã£ã¨",
  "æ–°è¨­ï¼ˆã—ã‚“ã›ã¤ï¼‰æ–½è¨­ï¼ˆã—ã›ã¤ï¼‰è¦–å¯Ÿï¼ˆã—ã•ã¤ï¼‰",
  "æ—©æœï¼ˆãã†ã¡ã‚‡ã†ï¼‰æ—©é€€ï¼ˆãã†ãŸã„ï¼‰ç›¸å¯¾ï¼ˆãã†ãŸã„ï¼‰",
  "åˆå‡ºå ´ï¼ˆã—ã‚‡ã—ã‚…ã¤ã˜ã‚‡ã†ï¼‰ã€€å‡ºå ´è€…ï¼ˆã—ã‚…ã¤ã˜ã‚‡ã†ã—ã‚ƒï¼‰ã€€ä¸»å¼µï¼ˆã—ã‚…ã¡ã‚‡ã†ï¼‰",
  "è‚©å©ãæ©Ÿï¼ˆã‹ãŸãŸãŸããï¼‰ã€€ãŸã å©ãæ©Ÿï¼ˆãŸã ãŸãŸããï¼‰",
  "å–æ¨é¸æŠï¼ˆã—ã‚…ã—ã‚ƒã›ã‚“ãŸãï¼‰ã€€è©¦å†™å®¤ï¼ˆã—ã—ã‚ƒã—ã¤ï¼‰ã€€æ”¯ç¤¾è¦–å¯Ÿï¼ˆã—ã—ã‚ƒã—ã•ã¤ï¼‰",
  "å·¦æŠ˜è»Šï¼ˆã•ã›ã¤ã—ã‚ƒï¼‰ã€€å³æŠ˜è»Šï¼ˆã†ã›ã¤ã—ã‚ƒï¼‰ã€€å¾è¡Œè»Šï¼ˆã˜ã‚‡ã“ã†ã—ã‚ƒï¼‰",
  "æœ€çµ‚æ‰‹æ®µï¼ˆã•ã„ã—ã‚…ã†ã—ã‚…ã ã‚“ï¼‰ã€€åé›†ï¼ˆã—ã‚…ã†ã—ã‚…ã†ï¼‰ã€€é›†ä¸­ï¼ˆã—ã‚…ã†ã¡ã‚…ã†ï¼‰",
  "ç‰¹æ€¥åˆ—è»Šï¼ˆã¨ã£ãã‚…ã†ã‚Œã£ã—ã‚ƒï¼‰ã€€æ™®é€šåˆ—è»Šï¼ˆãµã¤ã†ã‚Œã£ã—ã‚ƒï¼‰",
  "å†å†å†ï¼ˆã•ã„ã•ã„ã•ã„ï¼‰ç¢ºèªï¼ˆã‹ãã«ã‚“ï¼‰ã€€æœ€çµ‚ï¼ˆã•ã„ã—ã‚…ã†ï¼‰ç¢ºèªï¼ˆã‹ãã«ã‚“ï¼‰"
];

const sectionDefs = [
  { title: "ã€â‘  æ¯éŸ³ã€‘", data: phrases1 },
  { title: "ã€â‘¡ è¡Œåˆ¥åŸºæœ¬ã€‘", data: phrases2 },
  { title: "ã€â‘¢ æ¿éŸ³/åŠæ¿éŸ³ã€‘", data: phrases3 },
  { title: "ã€â‘£ æ‹—éŸ³ã€‘", data: phrases4 },
  { title: "ã€â‘¤ ãƒªã‚ºãƒ ã€‘", data: phrases5 },
  { title: "ã€â‘¥ è¨€ã„ã«ãã„è¨€è‘‰ã€‘", data: phrases6 }
];

let sectionIndex = 0;
let phraseIndex = 0;

/* =========================
   è¨­å®šï¼šã‚«ãƒ©ã‚ªã‚±/è‡ªå‹•/é€Ÿåº¦/ãƒ¢ãƒ¼ãƒ‰
========================= */
let karaokeOn = true;
let autoOn = false;
let speedMs = 450;        // 1æ–‡å­—ã”ã¨ã®è¡¨ç¤ºé€Ÿåº¦
let level = "beginner";   // beginner / advanced

let karaTimer = null;
let autoTimer = null;

/* =========================
   èª­ã¿ä¸Šã’ï¼ˆWeb Speech APIï¼‰
========================= */
let ttsSpeaking = false;
function canTTS(){
  return ("speechSynthesis" in window);
}
function speak(text){
  if(!canTTS()) return;

  // é€”ä¸­åœæ­¢
  window.speechSynthesis.cancel();

  const u = new SpeechSynthesisUtterance(text);
  u.lang = "ja-JP";
  // ãƒ¢ãƒ¼ãƒ‰ã§å°‘ã—å¤‰ãˆã‚‹
  u.rate = (level === "advanced") ? 1.08 : 0.95;
  u.pitch = 1.0;

  ttsSpeaking = true;
  u.onend = () => { ttsSpeaking = false; };
  u.onerror = () => { ttsSpeaking = false; };

  window.speechSynthesis.speak(u);
}

/* =========================
   ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
========================= */
function render(){
  const sec = sectionDefs[sectionIndex];
  const total = sec.data.length;

  document.getElementById("sectionTitle").textContent = sec.title;
  document.getElementById("phraseCounter").textContent = `${phraseIndex + 1}/${total}`;

  // è¡¨ç¤ºï¼ˆã‚«ãƒ©ã‚ªã‚±ONãªã‚‰1æ–‡å­—spanåŒ–ï¼‰
  const phrase = sec.data[phraseIndex];
  if(karaokeOn){
    renderKaraokeText(phrase);
  }else{
    document.getElementById("phraseBody").textContent = phrase;
  }

  // å†ç”Ÿãƒœã‚¿ãƒ³è¡¨ç¤º
  const btnPlay = document.getElementById("btnPlay");
  btnPlay.textContent = "ğŸ”Š å†ç”Ÿ";
}

function renderKaraokeText(text){
  const box = document.getElementById("phraseBody");
  box.innerHTML = "";
  const chars = Array.from(text);

  chars.forEach(ch => {
    const span = document.createElement("span");
    span.className = "karaChar";
    span.textContent = ch;
    box.appendChild(span);
  });
}

/* =========================
   ã‚«ãƒ©ã‚ªã‚±é€²è¡Œ
========================= */
// æ‹—éŸ³ãªã©ã€Œç™ºéŸ³ã®ã¾ã¨ã¾ã‚Šã€ã§åˆ†å‰²ã™ã‚‹
function splitIntoUnits(text){
  const chars = Array.from(text);

  // æ‹—éŸ³ã‚„å¤–æ¥èªç”¨ã®å°æ›¸ã
  const smallKana = new Set(["ã‚ƒ","ã‚…","ã‚‡","ã","ãƒ","ã…","ã‡","ã‰","ã‚"]);

  const units = [];
  for(let i = 0; i < chars.length; i++){
    const ch = chars[i];
    const next = chars[i + 1];

    // ã‚¹ãƒšãƒ¼ã‚¹ã¯ãã®ã¾ã¾ï¼ˆè‰²ä»˜ã‘ã—ãŸããªã„ãªã‚‰åˆ¥æ‰±ã„ã§ã‚‚OKï¼‰
    if(ch === " " || ch === "ã€€"){
      units.push(ch);
      continue;
    }

    // ã€Œãã€+ã€Œã‚ƒã€ã¿ãŸã„ã«æ¬¡ãŒå°æ›¸ããªã‚‰ã€2æ–‡å­—ã‚»ãƒƒãƒˆã«ã™ã‚‹
    if(next && smallKana.has(next)){
      units.push(ch + next);
      i++; // next ã‚’æ¶ˆè²»
      continue;
    }

    // é€šå¸¸ã¯1æ–‡å­—
    units.push(ch);
  }
  return units;
}

function renderKaraokeText(text){
  const box = document.getElementById("phraseBody");
  box.innerHTML = "";

  // â˜… ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼š1æ–‡å­—ã§ã¯ãªãã€ã¾ã¨ã¾ã‚Šã§åˆ†å‰²
  const units = splitIntoUnits(text);

  units.forEach(u => {
    const span = document.createElement("span");
    span.className = "karaChar";
    span.textContent = u;
    box.appendChild(span);
  });
}

function startKaraoke(){
  if(!karaokeOn) return;

  stopKaraoke();

  const spans = document.querySelectorAll(".karaChar");
  let i = 0;

  karaTimer = setInterval(()=>{
    if(i > 0){
      spans[i-1].classList.remove("active");
      spans[i-1].classList.add("done");
    }
    if(i >= spans.length){
      clearInterval(karaTimer);
      karaTimer = null;

      // è‡ªå‹•ONãªã‚‰æ¬¡ã¸
      if(autoOn){
        autoTimer = setTimeout(()=> nextPhrase(), 700);
      }
      return;
    }

    // ã‚¹ãƒšãƒ¼ã‚¹ã¯è‰²ä»˜ã‘ç„¡ã—ã§ã‚¹ã‚­ãƒƒãƒ—ï¼ˆè‡ªç„¶ã«è¦‹ãˆã‚‹ï¼‰
    if(spans[i].textContent === " " || spans[i].textContent === "ã€€"){
      spans[i].classList.add("done");
      i++;
      return;
    }

    spans[i].classList.add("active");
    i++;
  }, speedMs);
}

/* =========================
   æ“ä½œï¼šæ¬¡ã¸/å‰ã¸/ãƒ©ãƒ³ãƒ€ãƒ /æœ€åˆã¸
========================= */
function setSection(i){
  sectionIndex = i;
  phraseIndex = 0;
  stopAll();
  render();
}

function nextPhrase(){
  const sec = sectionDefs[sectionIndex];
  phraseIndex = (phraseIndex + 1) % sec.data.length;
  stopAll();
  render();

  if(autoOn || ttsSpeaking){
    // è‡ªå‹•å†ç”Ÿã®æ™‚ã¯ç¶šã‘ã¦å‹•ã
    playFlow();
  }
}

function prevPhrase(){
  const sec = sectionDefs[sectionIndex];
  phraseIndex = (phraseIndex - 1 + sec.data.length) % sec.data.length;
  stopAll();
  render();
}

function resetPhrase(){
  phraseIndex = 0;
  stopAll();
  render();
}

function randomPhrase(){
  const sec = sectionDefs[sectionIndex];
  phraseIndex = Math.floor(Math.random() * sec.data.length);
  stopAll();
  render();
}

/* =========================
   å†ç”Ÿï¼ˆTTSï¼‰ï¼‹ã‚«ãƒ©ã‚ªã‚±ï¼‹è‡ªå‹•ã®é€£æº
========================= */
function stopAll(){
  stopKaraoke();
  if(autoTimer){ clearTimeout(autoTimer); autoTimer = null; }
  if(canTTS()) window.speechSynthesis.cancel();
  ttsSpeaking = false;
}

function playFlow(){
  // ç¾åœ¨ã®æ–‡
  const sec = sectionDefs[sectionIndex];
  const phrase = sec.data[phraseIndex];

  // ã‚«ãƒ©ã‚ªã‚±é–‹å§‹
  if(karaokeOn) startKaraoke();

  // èª­ã¿ä¸Šã’ï¼ˆä»»æ„ï¼‰
  // iPhoneã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®ç›´å¾Œã ã‘éŸ³ãŒå‡ºã‚„ã™ã„ã®ã§ã€å†ç”Ÿãƒœã‚¿ãƒ³çµŒç”±ã‚’æ¨å¥¨
  if(ttsSpeaking || autoOn){
    speak(phrase);
  }
}

function togglePlay(){
  // å†ç”Ÿï¼šã“ã®ç¬é–“ã«éŸ³å£°ãŒå‡ºã‚‹ï¼ˆiPhoneå¯¾ç­–ï¼‰
  stopAll();
  ttsSpeaking = true; // playFlowå†…ã§ speak ãŒèµ°ã‚‹ã‚ˆã†ã«
  playFlow();
}

/* =========================
   è‡ªå‹•ON/OFF
========================= */
function toggleAuto(){
  autoOn = !autoOn;
  const b = document.getElementById("btnAuto");
  b.textContent = autoOn ? "â­ è‡ªå‹•ï¼šON" : "â­ è‡ªå‹•ï¼šOFF";
  b.style.opacity = autoOn ? "1" : "0.85";

  // è‡ªå‹•ONã«ã—ãŸç›´å¾Œã¯ã€å†ç”Ÿ/ãƒã‚¤ãƒ©ã‚¤ãƒˆãŒæ¬²ã—ã‘ã‚Œã°å†ç”Ÿãƒœã‚¿ãƒ³ã§é–‹å§‹ã™ã‚‹ã®ãŒå®‰å®š
}

/* =========================
   ã‚«ãƒ©ã‚ªã‚±ON/OFF
========================= */
function toggleKaraoke(){
  karaokeOn = !karaokeOn;
  const b = document.getElementById("btnKara");
  b.textContent = karaokeOn ? "ğŸŒˆ ã‚«ãƒ©ã‚ªã‚±ï¼šON" : "ğŸŒˆ ã‚«ãƒ©ã‚ªã‚±ï¼šOFF";
  b.style.opacity = karaokeOn ? "1" : "0.85";

  stopAll();
  render();
}

/* =========================
   é€Ÿåº¦
========================= */
function setSpeed(v){
  speedMs = Number(v);
  document.getElementById("speedLabel").textContent = `${speedMs}ms`;
}

/* =========================
   åˆå¿ƒè€…/ä¸Šç´š
========================= */
function setLevel(lv){
  level = lv;

  const b = document.getElementById("btnBeginner");
  const a = document.getElementById("btnAdvanced");

  if(level === "beginner"){
    b.classList.add("modeBtnOn");
    a.classList.remove("modeBtnOn");
    a.style.opacity = "0.7";
    // åˆå¿ƒè€…ã¯å°‘ã—ã‚†ã£ãã‚Šå¯„ã›
    speedMs = Math.max(speedMs, 420);
  }else{
    a.classList.add("modeBtnOn");
    b.classList.remove("modeBtnOn");
    b.style.opacity = "0.7";
    // ä¸Šç´šã¯å°‘ã—é€Ÿã‚å¯„ã›
    speedMs = Math.min(speedMs, 420);
  }
  document.getElementById("speedLabel").textContent = `${speedMs}ms`;
}

/* =========================
   ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³
========================= */
let dailyPlan = null;

function pickDaily(){
  // â‘ æ¯éŸ³ â†’ â‘£æ‹—éŸ³ â†’ â‘¢æ¿éŸ³ ã®é †ãŒåŠ¹ç‡è‰¯ã„ï¼ˆå£ã®å½¢â†’èˆŒâ†’ç ´è£‚/æ‘©æ“¦ï¼‰
  const plan = [
    { sec: 0, label: "æ¯éŸ³", phrase: randomFrom(phrases1) },
    { sec: 4, label: "ãƒªã‚ºãƒ ", phrase: randomFrom(phrases5) },
    { sec: 3, label: "æ‹—éŸ³", phrase: randomFrom(phrases4) }
  ];
  // ãŸã¾ã«æ¿éŸ³ã‚’æ··ãœã‚‹ï¼ˆåˆºæ¿€ï¼‰
  if(Math.random() < 0.5){
    plan.push({ sec: 2, label: "æ¿éŸ³/åŠæ¿éŸ³", phrase: randomFrom(phrases3) });
  }
  return plan;
}

function randomFrom(arr){
  return arr[Math.floor(Math.random() * arr.length)];
}

function showDaily(){
  if(!dailyPlan) dailyPlan = pickDaily();
  const text = dailyPlan.map((p,i)=>`(${i+1}) ${p.label}ï¼š${p.phrase}`).join("\n");
  document.getElementById("dailyText").textContent = text;
}

function shuffleDaily(){
  dailyPlan = pickDaily();
  showDaily();
}

function startDaily(){
  if(!dailyPlan) dailyPlan = pickDaily();

  // 1ã¤ç›®ã‚’ã‚»ãƒƒãƒˆã—ã¦é–‹å§‹
  const first = dailyPlan[0];
  setSection(first.sec);

  // è©²å½“ãƒ•ãƒ¬ãƒ¼ã‚ºã«åˆã‚ã›ãŸã„ã®ã§ index æ¢ã™
  jumpToPhrase(first.phrase);

  // è‡ªå‹•ONæ¨å¥¨ï¼ˆãŸã ã—ã€éŸ³å£°ã¯iPhoneã§å‡ºãªã„å ´åˆãŒã‚ã‚‹ã®ã§ã‚«ãƒ©ã‚ªã‚±ã ã‘ã§ã‚‚OKï¼‰
  autoOn = true;
  document.getElementById("btnAuto").textContent = "â­ è‡ªå‹•ï¼šON";
  document.getElementById("btnAuto").style.opacity = "1";

  // ãƒŸãƒƒã‚·ãƒ§ãƒ³ã¯ã€Œæ¬¡ã¸ã€ã§ã¯ãªãã€æ±ºã‚ãŸé †ã§é€²ã‚€
  runDailySequence(0);
}

function jumpToPhrase(phraseText){
  const sec = sectionDefs[sectionIndex];
  const idx = sec.data.indexOf(phraseText);
  phraseIndex = (idx >= 0) ? idx : 0;
  render();
}

function runDailySequence(i){
  const item = dailyPlan[i];
  if(!item) return;

  setSection(item.sec);
  jumpToPhrase(item.phrase);

  // è‡ªå‹•é€ã‚Šã¯ã€Œæ–‡å­—ãƒã‚¤ãƒ©ã‚¤ãƒˆå®Œäº†ã€ãƒˆãƒªã‚¬ãƒ¼ã ã¨ã‚ºãƒ¬ãŒå‡ºã‚‹ã®ã§ã€ã“ã“ã¯æ™‚é–“ã§åŒºåˆ‡ã‚‹
  stopAll();
  render();
  if(karaokeOn) startKaraoke();

  // æ–‡ç« ã‚’èª­ã‚“ã ã‚‰æ¬¡ã¸ï¼ˆç›®å®‰ï¼šæ–‡å­—æ•°Ã—speed + 600msï¼‰
  const approx = Array.from(item.phrase).length * speedMs + 600;

  // ä½™è£•ãŒã‚ã‚Œã°èª­ã¿ä¸Šã’ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…è¦ãªç«¯æœ«ã‚‚ã‚ã‚‹ï¼‰
  // å¼·åˆ¶ã¯ã—ãªã„ï¼šå†ç”Ÿãƒœã‚¿ãƒ³ã§éŸ³å£°ONã«ã—ã¦ã‚‚OK
  // speak(item.phrase);

  setTimeout(()=>{
    runDailySequence(i+1);
  }, approx);
}

/* åˆæœŸè¡¨ç¤º */
render();
showDaily();
</script>

</body>
</html>

