<!doctype html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>読み練習（外郎売）縦書き</title>
<link rel="stylesheet" href="style.css" />

<style>
  .wrap{max-width:1100px;margin:0 auto;}

  /* 本文エリア（縦書き右→左） */
  #reader{
    position:relative;
    height:70vh;
    overflow:auto;
    border:1px solid rgba(0,0,0,.12);
    border-radius:14px;
    background:rgba(255,255,255,.75);
    padding:14px;
  }

  #textBody{
    writing-mode:vertical-rl;     /* 縦書き・右→左 */
    text-orientation:mixed;
    font-size:19px;              /* 少し小さめ */
    font-weight:650;
    line-height:1.9;
    letter-spacing:.03em;
    white-space:pre-wrap;
    word-break:break-word;
  }

  /* ruby（ふりがな） */
  ruby{ ruby-position: over; ruby-align: center; }
  ruby rt{
    font-size:.55em;
    opacity:.88;
    letter-spacing:.02em;
    line-height:1.1;
    /* iOS Safari対策：余計な回転やズレが出にくい設定 */
    text-orientation:mixed;
  }

  /* ガイド縦線 */
  #guideLine{
    position:absolute;
    top:10px; bottom:10px;
    width:2px;
    background:rgba(230,0,51,.18);
    right:18px;
    display:none;
    border-radius:999px;
    pointer-events:auto; /* ドラッグするためON */
    touch-action:none;
  }

  .row{
    display:flex;gap:10px;justify-content:center;flex-wrap:wrap;align-items:center;
  }
  .pill{
    display:inline-block;padding:6px 12px;border-radius:999px;
    background:rgba(255,255,255,.75);border:1px solid rgba(0,0,0,.12);font-size:14px;
  }
  .btn{
    padding:10px 14px;border-radius:12px;border:1px solid rgba(0,0,0,.12);
    background:#fff;font-weight:800;
  }
  .btnPrimary{background:#0ea5e9;color:#fff;border:none;}
  .btnDanger{background:#ef4444;color:#fff;border:none;}
  .mini{font-size:14px;opacity:.85;line-height:1.7;text-align:center;white-space:pre-wrap;}

  input[type="range"]{ width:240px; }
</style>
</head>

<body>
<header class="top">
  <h1>📖 読み練習（外郎売）</h1>
  <p class="sub">縦書き（右→左）｜スマホ横向き推奨</p>
  <p><a href="index.html">← ホームへ戻る</a></p>
</header>

<main class="menu wrap">

  <div class="card" style="display:block;">
    <div class="title">操作</div>
    <div class="desc">
      <div class="row">
        <button class="btn btnPrimary" onclick="startAuto()">▶ 開始</button>
        <button class="btn btnDanger" onclick="stopAuto()">⏹ 停止</button>
        <button class="btn" onclick="resetPos()">⟲ リセット</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn" onclick="toggleLine()">│ 縦線：<span id="lineState">OFF</span></button>
        <button class="btn" onclick="toggleSlide()">⇢ 自動スライド：<span id="slideState">OFF</span></button>
      </div>

      <div class="row" style="margin-top:10px;">
        <span class="pill">縦線位置</span>
        <input id="linePos" type="range" min="0" max="120" value="18" oninput="setLineRight(this.value)">
        <span class="pill"><span id="lineRightLabel">18</span>px</span>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn" onclick="slower()">➖ 速度</button>
        <span class="pill">速度：<span id="speedLabel">900</span>ms</span>
        <button class="btn" onclick="faster()">➕ 速度</button>
      </div>

      <div class="mini" style="margin-top:10px;">
        ✅ 縦線は「スライダー」でも「指ドラッグ」でも位置調整できます
      </div>
    </div>
  </div>

  <div class="card" style="display:block;">
    <div class="title">外郎売（縦書き）</div>
    <div class="desc">
      <div id="reader">
        <div id="guideLine" title="ドラッグで縦線位置を調整"></div>
        <div id="textBody">読み込み中…</div>
      </div>
    </div>
  </div>

</main>

<script>
/* ======================================================
  ✅ ここに全文を貼る（あなたの形式：漢字の直後にひらがな）
====================================================== */
const RAW_TEXT = `
拙者せっしゃ親方おやかたと申もうすは、お立会たちあいの中うちに御存知ごぞんじのお方かたもござりましょうが、お江戸えどを発たって二十里にじゅうり上方かみがた、相州そうしゅう小田原おだわら一色町いっしきまちをお過すぎなされて、青物あおもの町ちょうを登のぼりへお出いでなさるれば、欄干橋らんかんばし虎屋とらや藤右衛門とうえもん、只今ただいまは剃髪ていはつ致いたして圓斎えんさいと名乗なのりまする。
元朝がんちょうより大晦日おおつごもりまで、御手おてに入いれまする此この薬くすりは、昔むかし珍ちんの国くにの唐人とうじん、外郎ういろうと云いう人ひと、我が朝ちょうへ来きたり。帝みかどへ参内さんだいの折おりから、此この薬くすりを深ふかく込こめ置おき、用もちゆる時ときは一粒いちりゅうずつ冠かんむりの隙間すきまより取とり出いだす。依よってその名なを帝みかどより透頂香とうちんこうと賜たまわる。即すなわち文字もじには、「頂いただき、透すく、香におい」と書かいて「とうちんこう」と申もうす。
只今ただいまは此この薬くすり、殊ことの外ほか世上せじょうに広ひろまり、方々ほうぼうに似にせ看板かんばんを出いだし、イヤ小田原おだわらの灰俵はいだわらの、さん俵だわらの、炭俵すみだわらのと、色々いろいろに申もうせども、平仮名ひらがなをもって「ういろう」と致いたしたは、親方おやかた圓斎えんさいばかり。もしやお立会たちあいの中うちに、熱海あたみか塔ノ沢とうのさわへ湯治とうじにお出いでなさるるか、又または伊勢いせ御参宮ごさんぐうの折おりからは、必かならず門かど違ちがいなされまするな。御上のぼりなれば右みぎの方かた、御下くだりなれば左側ひだりがわ、八方はっぽうが八つ棟やつむね、表おもてが三つ棟みつむね玉堂ぎょくどう造づくり、破風はふには菊きくに桐きりの薹とうの御紋ごもんを御赦免しゃめんあって、系図けいず正ただしき薬くすりでござる。
イヤ最前さいぜんより家名かめいの自慢じまんばかり申もうしても、御存知ごぞんじない方かたには、正身しょうしんの胡椒こしょうの丸呑まるのみ、白河夜船しらかわよふね。さらば一粒いちりゅう食たべかけて、その気味合きみあいをお目めに懸かけましょう。先まず此この薬くすりを斯様かように一粒いちりゅう舌したの上うえへ乗のせまして、腹ふく内ないへ納おさめますると、イヤどうもいえぬは、胃い、心しん、肺はい、肝かんが健すこやかに成なって、薫風くんぷう喉のどより来きたり、口中こうちゅう微涼びりょうを生しょうずるが如ごとし。魚鳥ぎょちょう、木の子きのこ、麺類めんるいの食くい合あわせ、其その外ほか万病まんびょう即効そっこうあること神かみの如ごとし。
さて此この薬くすり、第一だいいちの奇妙きみょうには、舌したの廻まわることが銭ぜにごまが裸足はだしで逃にげる。ひょっと舌したが廻まわり出だすと、矢やも盾たても堪たまらぬじゃ。
そりゃそりゃそりゃ、そりゃそりゃ、廻まわって来きたわ、廻まわって来くるわ。アワヤ喉のど、サタラナ舌したにカ牙げサ歯音しおん、ハマの二つふたつは唇くちびるの軽重きょうじゅう開口かいこう爽さわやかに、アカサタナ、ハマヤラワ、オコソトノ、ホモヨロヲ。
一つへぎへぎに、へぎ干ほし、はじかみ。盆豆ぼんまめ、盆米ぼんごめ、盆牛蒡ぼんごぼう。摘つみ蓼たで、摘つみ豆まめ、摘つみ山椒さんしょう、書写山しょしゃざんの社しゃ僧正そうじょう。
小米こごめの生なま噛がみ、小米こごめの生なま噛がみ、こん小米こごめのこ生なま噛がみ。繻子しゅす緋ひ繻子じゅす、繻子しゅす繻珍しゅちん。
親おやも嘉兵衛かへえ、子こも嘉兵衛かへえ、親嘉兵衛おやかへえ子嘉兵衛こかへえ、子嘉兵衛こかへえ親嘉兵衛おやかへえ。古栗こぐりの木きの古ふる切口きりくち。雨合羽あまがっぱが番ばん合羽がっぱか。貴様きさまの脚絆きゃはんも皮脚絆かわぎゃはん、我等われらが脚絆きゃはんも皮脚絆かわぎゃはん。尻皮袴しりかわばかまのしっ綻ぽころびを、三針みはり針長はりながにちょと縫ぬうて、縫ぬうてちょとぶん出だせ。河原撫子かわらなでしこ、野石のぜき竹ちく。野良如来のらにょらい野良如来のらにょらい、三野良如来みのらにょらいに六野良如来むのらにょらい。
一寸先いっすんさきのお小仏こぼとけにお蹴躓けつまずきゃるな、細溝ほそみぞにどじょにょろり。京きょうの生鱈なまだら、奈良なら生学鰹なまながつお、ちょと四五貫目しごかんめ。お茶立ちゃだちょ、茶立ちゃだちょ、ちゃっと立たちょ、茶立ちゃだちょ。青竹あおだけ茶筅ちゃせんでお茶ちゃちゃと立たちゃ。
来くるわ来くるわ何なにが来くる、高野こうやの山やまのおこけら小僧こぞう、狸たぬき百匹ひゃっぴき、箸はし百膳ひゃくぜん、天目てんもく百杯ひゃっぱい、棒ぼう八百本はっぴゃっぽん。武具ぶぐ、馬具ばぐ、武具馬具ぶぐばぐ、三武具馬具みぶぐばぐ、合あわせて武具馬具ぶぐばぐ、六武具馬具むぶぐばぐ。
菊きく、栗くり、菊栗きくくり、三菊栗みきくくり、合あわせて菊栗きくくり、六菊栗むきくくり。麦むぎ、ごみ、麦ごみむぎごみ、三麦ごみみむぎごみ、合あわせて麦ごみむぎごみ、六麦ごみむむぎごみ。あの長押なげしの長なが薙刀なぎなたは誰たが長なが薙刀なぎなたぞ。向むこうの胡麻殻ごまがらは荏えの胡麻殻ごまがらか真胡麻まごまの胡麻殻ごまがらか、あれこそ本ほんの真胡麻まごまの胡麻殻ごまがら。がらぴいがらぴい風車かざぐるま。起おきゃがれ小法師こぼし、起おきゃがれ小法師こぼし、昨夜ゆんべも溢こぼしてまた溢こぼした。
たぁぷぽぽ、たぁぷぽぽ、ちりからちりから、つったっぽ。たっぽたっぽ一丁いっちょう蛸だこ、落おちたら煮にて食くを。煮にても焼やいても食くわれぬ物ものは、五徳ごとく、鉄弓てつきゅう、金熊童子かなぐまどうじに、石熊いしくま、石持いしもち、虎熊とらくま、虎鱚とらぎす。中なかにも東寺とうじの羅生門らしょうもんには、茨木童子いばらきどうじが腕うで栗ぐり五合ごんごう掴つかんでおむしゃる。かの頼光らいこうの膝元ひざもと去さらず。
鮒ふな、金柑きんかん、椎茸しいたけ、定さだめて後段ごだんな、蕎麦切そばきり、素麺そうめん、饂飩うどんか愚鈍ぐどんなこ新発しんぼ知ち。小棚こだなの小下こしたに、小桶こおけに小味噌こみそが小有こあるぞ、小杓子こしゃくし小持こもって、小すくって小寄よこせ。おっと合点がてんだ、心得こころえ田圃たんぼの川崎かわさき、神奈川かながわ、程ヶ谷ほどがや、戸塚とつかは走はしって行ゆけば、灸やいとを擦すりむく、三里さんりばかりか、藤沢ふじさわ、平塚ひらつか、大磯おおいそがしや、小磯こいその宿やどを七つななつ起おきして、早天そうてんそうそう、相州そうしゅう小田原おだわら、透頂香とうちんこう。隠かくれござらぬ貴賎きせん群衆ぐんじゅの花はなの御江戸えどの花はな、ういろう。あれ、あの花はなを見みて、お心こころをお和やわらぎやという。産うぶ子こ、這子はうこに至いたるまで、此このういろうの御評判ごひょうばん、御存知ごぞんじないとは申もうされまいまいつぶり、角出つのだせ、棒出ぼうだせ、ぼうぼう眉まゆに、臼うす、杵きね、擂鉢すりばち、ばちばち、ぐゎらぐゎらぐゎらと、羽目はめを外はずして今日こんにち御出でおいでの何いずれ様さまに、上あげねばならぬ、売うらねばならぬと、息せい引ひっ張ぱり、東方とうほう世界せかいの薬くすりの元締もとじめ、薬師如来やくしにょらいも照覧しょうらんあれと、ホホ敬うやまって、ういろうはいらっしゃりませぬか。
`.trim();

/* ======================================================
  ✅ 自動ruby化（重要改善）
  - 「漢字の後に 空白 があっても」読みを拾う
  - 例：相州 そうしゅう → <ruby>相州<rt>そうしゅう</rt></ruby>
====================================================== */
function isKanji(ch){ return /[一-龥々]/.test(ch); }
function isHiragana(ch){ return /[ぁ-ゖーゝゞ]/.test(ch); } // ー/ゝ/ゞも許容
function isSpace(ch){ return ch === " " || ch === "　"; }

function escapeHtml(s){
  return (s+"")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;");
}

function autoRuby(text){
  let out = "";
  let i = 0;

  while(i < text.length){
    const c = text[i];

    if(c === "\n" || c === "\r"){
      out += "\n";
      i++;
      continue;
    }

    if(isKanji(c)){
      // 1) 漢字連続
      let kanjiRun = c;
      i++;
      while(i < text.length && isKanji(text[i])){
        kanjiRun += text[i];
        i++;
      }

      // 2) 漢字と読みの間の空白をスキップ（ここが改善点）
      while(i < text.length && isSpace(text[i])) i++;

      // 3) ひらがな連続（読み）
      let hiraRun = "";
      while(i < text.length && isHiragana(text[i])){
        hiraRun += text[i];
        i++;
      }

      if(hiraRun.length > 0){
        out += `<ruby>${escapeHtml(kanjiRun)}<rt>${escapeHtml(hiraRun)}</rt></ruby>`;
      }else{
        out += escapeHtml(kanjiRun);
      }
      continue;
    }

    out += escapeHtml(c);
    i++;
  }

  return out;
}

function render(){
  document.getElementById("textBody").innerHTML = autoRuby(RAW_TEXT);
}
render();

/* ======================================================
  ✅ 縦線 ON/OFF + 位置調整
====================================================== */
let lineOn = false;

function setLineRight(px){
  const v = Number(px);
  document.getElementById("guideLine").style.right = v + "px";
  document.getElementById("lineRightLabel").textContent = String(v);
}

function toggleLine(){
  lineOn = !lineOn;
  document.getElementById("guideLine").style.display = lineOn ? "block" : "none";
  document.getElementById("lineState").textContent = lineOn ? "ON" : "OFF";
  if(lineOn){
    // スライダー値を反映
    setLineRight(document.getElementById("linePos").value);
  }
}

/* 指ドラッグで縦線移動（iPhone用） */
(function enableDragLine(){
  const line = document.getElementById("guideLine");
  const reader = document.getElementById("reader");
  let dragging = false;

  function clientX(e){
    return (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
  }

  function onDown(e){
    if(!lineOn) return;
    dragging = true;
    e.preventDefault();
  }

  function onMove(e){
    if(!dragging) return;
    const rect = reader.getBoundingClientRect();
    const x = clientX(e);
    // right(px) = rect.right - x
    let right = Math.round(rect.right - x);
    right = Math.max(0, Math.min(220, right)); // 範囲制限（好みで調整OK）
    line.style.right = right + "px";
    document.getElementById("linePos").value = right;
    document.getElementById("lineRightLabel").textContent = String(right);
    e.preventDefault();
  }

  function onUp(){
    dragging = false;
  }

  line.addEventListener("touchstart", onDown, {passive:false});
  window.addEventListener("touchmove", onMove, {passive:false});
  window.addEventListener("touchend", onUp);

  line.addEventListener("mousedown", onDown);
  window.addEventListener("mousemove", onMove);
  window.addEventListener("mouseup", onUp);
})();

/* ======================================================
  ✅ 自動スライド（右→左へ進む）
====================================================== */
let slideOn = false;
let speed = 900; // ms
let timer = null;

function updateSpeedLabel(){
  document.getElementById("speedLabel").textContent = String(speed);
}
updateSpeedLabel();

function toggleSlide(){
  slideOn = !slideOn;
  document.getElementById("slideState").textContent = slideOn ? "ON" : "OFF";
  if(slideOn){
    if(!lineOn) toggleLine();
    startAuto();
  }else{
    stopAuto();
  }
}

function startAuto(){
  stopAuto();
  if(!slideOn) return;

  const reader = document.getElementById("reader");
  const line = document.getElementById("guideLine");

  timer = setInterval(()=>{
    // 線を少し左へ（right増加）
    const cur = parseFloat(line.style.right || "18");
    const next = cur + 12;
    line.style.right = next + "px";
    document.getElementById("linePos").value = Math.min(220, next);
    document.getElementById("lineRightLabel").textContent = String(Math.round(next));

    // 本文も横へ進める
    reader.scrollLeft += 18;

    const max = reader.scrollWidth - reader.clientWidth;
    if(reader.scrollLeft >= max - 5){
      stopAuto();
    }
  }, speed);
}

function stopAuto(){
  if(timer){
    clearInterval(timer);
    timer = null;
  }
}

function resetPos(){
  stopAuto();
  const reader = document.getElementById("reader");
  reader.scrollLeft = 0;
  // 線を初期位置へ
  document.getElementById("linePos").value = 18;
  setLineRight(18);
}

function slower(){
  speed = Math.min(speed + 120, 3000);
  updateSpeedLabel();
  if(timer) startAuto();
}
function faster(){
  speed = Math.max(speed - 120, 200);
  updateSpeedLabel();
  if(timer) startAuto();
}

/* 初期：縦線位置ラベル */
setLineRight(document.getElementById("linePos").value);
</script>

</body>
</html>